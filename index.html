<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="google-site-verification" content="9OxFQQHfJelUvYSKyGNO0LYCFwb_LICV6b3N2-Go5fU" />
<meta name="description" content="早稲田大学生の情報共有掲示板。授業口コミ、サークル情報、キャンパスライフ、Q&Aを学生同士でシェア。受験生にも役立つ早稲田の最新情報。">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ワセダノート - 早稲田大学生の情報共有掲示板</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root {
    --crimson: #8B0000; --crimson-light: #A50000; --crimson-dark: #700000; --crimson-pale: #f9f0f0;
    --gold: #C8A951; --gold-light: #e8c96a; --gold-dark: #b8941f;
    --dark: #1a1a1a; --gray: #6b6b6b; --gray-light: #9a9a9a; --gray-lighter: #d5d5d5;
    --white: #ffffff; --border: #e8e0e0; --bg: #faf8f8; --bg-light: #ffffff;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Noto Sans JP', sans-serif; background: var(--bg); color: var(--dark); min-height: 100vh; line-height: 1.6; }

  header { background: linear-gradient(135deg, var(--crimson) 0%, var(--crimson-dark) 100%); padding: 0 1.2rem; position: sticky; top: 0; z-index: 100; box-shadow: 0 3px 16px rgba(139, 0, 0, 0.3); }
  .header-inner { max-width: 1200px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; height: 60px; gap: 0.5rem; }
  .logo { display: flex; align-items: center; gap: 8px; text-decoration: none; flex-shrink: 0; }
  .logo-jp { font-size: 1.35rem; font-weight: 900; color: var(--white); letter-spacing: 0.05em; white-space: nowrap; line-height: 1; }
  .logo-en { font-family: 'Playfair Display', serif; font-size: 0.65rem; color: var(--gold-light); letter-spacing: 0.12em; white-space: nowrap; }
  .header-right { display: flex; align-items: center; gap: 0.6rem; flex-shrink: 0; }
  .btn-google-auth { background: #fff; color: #333; border: 1.5px solid #dadce0; border-radius: 18px; padding: 6px 12px; font-size: 0.78rem; font-weight: 700; display: inline-flex; align-items: center; gap: 6px; cursor: pointer; transition: all 0.2s; white-space: nowrap; }
  .btn-google-auth:hover { border-color: #c4c7cc; box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
  .btn-google-auth.logged-in { background: #f8f9fa; }
  .google-g { width: 18px; height: 18px; border-radius: 50%; background: conic-gradient(#4285f4 0 25%, #34a853 25% 50%, #fbbc05 50% 75%, #ea4335 75% 100%); color: #fff; font-size: 11px; line-height: 18px; text-align: center; font-weight: 900; display: inline-block; }
  .google-user-name { max-width: 110px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .btn-admin { background: white; color: #333; border: 1px solid #ccc; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85rem; }
    .btn-admin:hover { background: #f0f0f0; }
    
    /* Prominent announcement banner */
    .announcement-banner { 
      background: linear-gradient(135deg, #ffc107 0%, #ffb300 100%);
      box-shadow: 0 4px 16px rgba(255, 193, 7, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.3);
      padding: 0;
      width: 100%;
      animation: slideDown 0.5s ease-out;
      border-bottom: 3px solid #ff9800;
    }
    
    @keyframes slideDown {
      from { 
        opacity: 0;
        transform: translateY(-100%);
      }
      to { 
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .announcement-container {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 18px 24px;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .announcement-icon {
      font-size: 32px;
      flex-shrink: 0;
      animation: megaphone 0.6s ease-out;
    }
    
    @keyframes megaphone {
      0% { transform: scale(0) rotate(-45deg); opacity: 0; }
      50% { transform: scale(1.1); }
      100% { transform: scale(1) rotate(0); opacity: 1; }
    }
    
    .announcement-content {
      flex: 1;
      text-align: left;
    }
    
    .announcement-title {
      font-size: 1.3rem;
      font-weight: 900;
      color: #2c1810;
      line-height: 1.3;
      margin-bottom: 6px;
      letter-spacing: 0.01em;
    }
    
    .announcement-body {
      font-size: 0.95rem;
      color: #3e2723;
      line-height: 1.5;
      font-weight: 500;
    }
    
    .announcement-close {
      flex-shrink: 0;
      background: rgba(255, 255, 255, 0.3);
      border: none;
      color: #2c1810;
      font-size: 24px;
      padding: 4px 8px;
      cursor: pointer;
      border-radius: 4px;
      transition: all 0.2s;
    }
    
    .announcement-close:hover {
      background: rgba(255, 255, 255, 0.6);
      transform: rotate(90deg);
    }
  .nickname-badge { background: rgba(255,255,255,0.18); border: 1.5px solid rgba(255,255,255,0.35); color: white; padding: 6px 14px; border-radius: 20px; font-size: 0.8rem; cursor: pointer; transition: all 0.2s; font-weight: 500; white-space: nowrap; }
  .nickname-badge:hover { background: rgba(255,255,255,0.28); }
  .btn-mypage { background: rgba(255,255,255,0.14); color: #fff; border: 1.5px solid rgba(255,255,255,0.35); padding: 6px 12px; border-radius: 18px; font-size: 0.77rem; font-weight: 700; cursor: pointer; transition: all 0.2s; white-space: nowrap; }
  .btn-mypage:hover { background: rgba(255,255,255,0.28); }
  .btn-post { background: var(--gold); color: var(--crimson-dark); border: none; padding: 8px 18px; border-radius: 8px; font-weight: 700; font-size: 0.85rem; cursor: pointer; font-family: 'Noto Sans JP', sans-serif; transition: all 0.2s; white-space: nowrap; }
  .btn-post:hover { background: var(--gold-light); transform: translateY(-1px); }

  .juken-banner { display: block; background: var(--gold); text-decoration: none; text-align: center; padding: 0 1rem; line-height: 40px; height: 40px; font-size: 0.85rem; font-weight: 700; color: var(--crimson-dark); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; transition: background 0.2s; letter-spacing: 0.01em; }
  .juken-banner:hover { background: var(--gold-light); }
  .hero { background: linear-gradient(160deg, var(--crimson) 0%, var(--crimson-dark) 100%); padding: 2rem 1.5rem 1.8rem; text-align: center; }
  .hero h1 { font-size: 1.25rem; color: var(--white); letter-spacing: 0.04em; margin-bottom: 0.4rem; font-weight: 700; line-height: 1.5; }
  .hero p { color: rgba(255,255,255,0.75); font-size: 0.88rem; margin-bottom: 1.2rem; font-weight: 400; line-height: 1.6; }
  .search-bar { max-width: 600px; padding: 0; margin: 0 auto; display: flex; gap: 8px; }
  .search-input { flex: 1; border: none; border-radius: 10px; padding: 11px 15px; font-size: 0.9rem; font-family: 'Noto Sans JP', sans-serif; outline: none; transition: box-shadow 0.2s; min-width: 0; }
  .search-input:focus { box-shadow: 0 0 0 3px rgba(200, 169, 81, 0.3); }
  .search-btn { background: var(--gold); border: none; border-radius: 10px; padding: 11px 20px; font-size: 0.9rem; cursor: pointer; transition: all 0.2s; font-weight: 700; flex-shrink: 0; white-space: nowrap; color: var(--crimson-dark); }
  .search-btn:hover { background: var(--gold-light); }

  .faculty-bar { background: var(--white); border-bottom: 2px solid #f0ede0; padding: 1rem 2rem; overflow-x: auto; -webkit-overflow-scrolling: touch; }
  .faculty-bar-inner { max-width: 1200px; margin: 0 auto; display: flex; gap: 10px; white-space: nowrap; align-items: center; }
  .faculty-label { font-size: 0.8rem; color: var(--gray); font-weight: 700; margin-right: 8px; flex-shrink: 0; letter-spacing: 0.05em; }
  .faculty-chip { padding: 8px 16px; border-radius: 25px; font-size: 0.8rem; font-weight: 600; cursor: pointer; border: 1.5px solid var(--border); background: white; color: var(--gray); transition: all 0.25s; white-space: nowrap; font-family: 'Noto Sans JP', sans-serif; }
  .faculty-chip:hover { border-color: var(--crimson); color: var(--crimson); background: var(--crimson-pale); }
  .faculty-chip.active { background: var(--crimson); color: white; border-color: var(--crimson); font-weight: 700; box-shadow: 0 2px 8px rgba(139, 0, 0, 0.2); }

  .tabs { background: var(--white); border-bottom: 2px solid #f0ede0; position: sticky; top: 60px; z-index: 90; box-shadow: 0 2px 12px rgba(0,0,0,0.08); display: flex; align-items: center; }
  .tabs-scroll-btn { flex-shrink: 0; width: 28px; min-width: 28px; height: 28px; margin-right: 0.75rem; border: 1.5px solid var(--gray-lighter); border-radius: 50%; background: var(--white); color: var(--gray-light); font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: color 0.2s, border-color 0.2s, box-shadow 0.2s, opacity 0.25s, width 0.25s, min-width 0.25s, margin-right 0.25s; box-shadow: 0 1px 4px rgba(0,0,0,0.08); user-select: none; overflow: hidden; }
  .tabs-scroll-btn:hover { border-color: var(--crimson); color: var(--crimson); box-shadow: 0 2px 8px rgba(139,0,0,0.15); }
  .tabs-scroll-btn.hidden { opacity: 0; pointer-events: none; width: 0; min-width: 0; margin-right: 0; border-width: 0; }
  .tabs-inner { padding: 0.6rem 1rem; display: flex; flex-wrap: nowrap; justify-content: flex-start; gap: 0.6rem; max-width: 1000px; margin: 0 auto; overflow-x: auto; scroll-behavior: smooth; }
  .tabs-inner::-webkit-scrollbar { height: 3px; }
  .tabs-inner::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); }
  .tabs-inner::-webkit-scrollbar-thumb { background: rgba(139,0,0,0.2); border-radius: 2px; }

  .tab { display: inline-block; padding: 7px 13px; font-size: 0.82rem; font-weight: 600; background: white; color: var(--crimson); border: 1.5px solid var(--crimson); border-radius: 18px; cursor: pointer; transition: all 0.2s; text-align: center; white-space: nowrap; letter-spacing: 0.01em; user-select: none; flex-shrink: 0; }
  .tab:hover { background: var(--crimson); color: white; transform: translateY(-1px); }
  .tab.active { background: linear-gradient(135deg, var(--crimson) 0%, var(--crimson-dark) 100%); color: white; border-color: var(--crimson-dark); font-weight: 700; box-shadow: 0 2px 8px rgba(139, 0, 0, 0.2); }
  /* 受験生サポートタブ — ゴールドで差別化 */
  .tab[data-label="juken"] { background: var(--gold); color: #1a1000; border-color: var(--gold-dark); font-weight: 700; }
  .tab[data-label="juken"]:hover { background: var(--gold-light); border-color: var(--gold); transform: translateY(-1px); }
  .tab[data-label="juken"].active { background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%); color: #1a1000; border-color: var(--gold-dark); box-shadow: 0 2px 8px rgba(200,169,81,0.5); }
  @media (max-width: 992px) {
    .tabs-inner { padding: 0.45rem 0.4rem; gap: 0.35rem; }
    .tab { font-size: 0.75rem; padding: 5px 10px; }
  }
  @media (max-width: 480px) {
    .tabs-inner { padding: 0.4rem 0.3rem; gap: 0.3rem; }
    .tab { font-size: 0.7rem; padding: 4px 8px; }
  }


    .main { max-width: 1200px; margin: 0 auto; padding: 2.5rem 2rem; display: grid; grid-template-columns: 1fr 260px; gap: 2.5rem; }

    .search-banner { background: linear-gradient(135deg, rgba(139,0,0,0.08) 0%, rgba(200,169,81,0.08) 100%); border: 1.5px solid rgba(139,0,0,0.15); border-radius: 12px; padding: 14px 18px; margin-bottom: 1.5rem; font-size: 0.9rem; color: var(--crimson); display: none; align-items: center; justify-content: space-between; font-weight: 500; }
    .search-banner.show { display: flex; }
    .clear-search { cursor: pointer; font-weight: 700; font-size: 0.85rem; transition: color 0.2s; }
    .clear-search:hover { color: var(--crimson-dark); }

    .posts-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; gap: 1.5rem; }
    .posts-header h2 { font-size: 1.3rem; font-weight: 700; color: var(--dark); letter-spacing: 0.02em; }
    .posts-header-controls { display: flex; gap: 1rem; align-items: center; }
    .sort-select { border: 1.5px solid var(--border); padding: 8px 14px; border-radius: 8px; font-size: 0.88rem; color: var(--gray); background: white; cursor: pointer; font-family: 'Noto Sans JP', sans-serif; font-weight: 500; transition: all 0.2s; }
    .sort-select:hover { border-color: var(--crimson); color: var(--dark); }
    .sort-select:focus { outline: none; border-color: var(--crimson); box-shadow: 0 0 0 3px rgba(139, 0, 0, 0.1); }

    .post-card { background: white; border: 1px solid var(--border); border-left: 4px solid var(--gold); border-radius: 12px; padding: 1.5rem 1.7rem; margin-bottom: 1.3rem; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; position: relative; overflow: hidden; }
    .post-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, var(--gold), transparent); opacity: 0; transition: opacity 0.3s; }
    .post-card:hover { box-shadow: 0 8px 32px rgba(139,0,0,0.12); transform: translateY(-4px); border-left-color: var(--crimson); }
    .post-card:hover::before { opacity: 1; }
    .post-card.lecture { border-left-color: #e65100; }
    .post-card.circle { border-left-color: #2e7d32; }
    .post-card.campus { border-left-color: #1565c0; }
    .post-card.qa { border-left-color: #6a1b9a; }
    .post-card.job { border-left-color: #ff9800; }

    .post-meta { display: flex; align-items: center; gap: 12px; margin-bottom: 0.8rem; flex-wrap: wrap; }
    .category-tag { font-size: 0.72rem; font-weight: 700; padding: 5px 12px; border-radius: 20px; letter-spacing: 0.05em; }
    .faculty-tag { font-size: 0.72rem; padding: 5px 12px; border-radius: 18px; background: var(--crimson-pale); color: var(--crimson); font-weight: 600; }
    .cat-lecture { background: #fff3e0; color: #e65100; }
    .cat-circle { background: #e8f5e9; color: #2e7d32; }
    .cat-campus { background: #e3f2fd; color: #1565c0; }
    .cat-qa { background: #f3e5f5; color: #6a1b9a; }
    .author { font-size: 0.82rem; color: var(--gray); font-weight: 600; }
    .post-time { font-size: 0.78rem; color: var(--gray-light); margin-left: auto; }
    .post-title { font-size: 1.13rem; font-weight: 700; margin-bottom: 0.7rem; line-height: 1.4; color: var(--dark); letter-spacing: 0.01em; }
    .post-body { font-size: 0.91rem; color: var(--gray); line-height: 1.6; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .post-footer { display: flex; gap: 1.2rem; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #f0f0f0; }
    .post-action { display: flex; align-items: center; gap: 6px; font-size: 0.82rem; color: var(--gray-light); cursor: pointer; transition: all 0.2s; font-weight: 500; }
    .post-action:hover { color: var(--crimson); }
    .post-action.liked { color: var(--crimson); font-weight: 700; }
    .delete-btn { color: #d00; }
    .stars { color: var(--gold); font-size: 0.9rem; }
    
    .extra-meta { margin-bottom: 0.6rem; display: flex; gap: 0.8rem; flex-wrap: wrap; font-size: 0.85rem; align-items: center; }

    .qa-card { background: white; border: 1.5px solid #e8d5f5; border-left: 4px solid #6a1b9a; border-radius: 12px; padding: 1.6rem 1.8rem; margin-bottom: 1.3rem; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative; }
    .qa-card:hover { box-shadow: 0 8px 32px rgba(106, 27, 154, 0.15); transform: translateY(-4px); }
    .qa-status { font-size: 0.75rem; font-weight: 700; padding: 6px 12px; border-radius: 20px; letter-spacing: 0.05em; }
    .qa-status.answered { background: #e8f5e9; color: #2e7d32; }
    .qa-status.open { background: #fff3e0; color: #e65100; }

    .loading { text-align: center; padding: 4rem 2rem; color: var(--gray); font-size: 0.95rem; }
    .loading::after { content: ''; display: inline-block; width: 20px; height: 20px; margin-left: 8px; border: 3px solid rgba(139, 0, 0, 0.1); border-top-color: var(--crimson); border-radius: 50%; animation: spin 0.8s linear infinite; vertical-align: middle; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .skeleton-card { background: white; border: 1px solid var(--border); border-radius: 12px; padding: 1.6rem 1.8rem; margin-bottom: 1.3rem; }
    .skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: loading 1.5s infinite; border-radius: 8px; }
    .skeleton-title { height: 24px; margin-bottom: 1rem; width: 70%; }
    .skeleton-text { height: 16px; margin-bottom: 0.5rem; width: 100%; }
    .skeleton-text:last-child { width: 85%; }
    @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    
    .empty-tab { text-align: center; padding: 5rem 2rem 4rem; color: var(--gray); }
    .empty-icon { font-size: 4rem; margin-bottom: 1.5rem; opacity: 0.8; }
    .empty-title { font-size: 1.2rem; font-weight: 700; margin-bottom: 0.8rem; color: var(--dark); }
    .empty-text { font-size: 0.95rem; margin-bottom: 2rem; color: var(--gray-light); line-height: 1.6; }
    .empty-action { display: inline-block; background: var(--gold); color: var(--dark); padding: 10px 24px; border-radius: 8px; font-weight: 700; cursor: pointer; text-decoration: none; transition: all 0.2s; }
    .empty-action:hover { background: var(--gold-light); transform: translateY(-2px); }

    .sidebar { display: flex; flex-direction: column; gap: 2rem; }
    .sidebar-card { background: white; border: 1px solid var(--border); border-radius: 14px; overflow: hidden; transition: all 0.3s; }
    .sidebar-card:hover { box-shadow: 0 4px 20px rgba(139, 0, 0, 0.08); }
    .sidebar-card-header { background: linear-gradient(135deg, var(--crimson) 0%, var(--crimson-dark) 100%); padding: 14px 16px; color: white; font-size: 0.9rem; font-weight: 700; letter-spacing: 0.05em; }
    .sidebar-card-body { padding: 1.4rem 1.2rem; }

    /* category tabs inside trend card */
    .trend-tabs { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; margin-bottom: 0.8rem; }
    .trend-tab {
      display: block;
      padding: 7px 6px;
      font-size: 0.82rem;
      font-weight: 700;
      background: white;
      color: var(--crimson);
      border: 2px solid var(--crimson);
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s, color 0.2s, transform 0.1s;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .trend-tab:hover {
      background: var(--crimson);
      color: white;
      transform: translateY(-1px);
    }
    .trend-tab.active {
      background: var(--crimson-dark);
      color: white;
      border-color: var(--crimson-dark);
    }

    .trend-item { display: flex; align-items: flex-start; gap: 12px; padding: 0.75rem 0; border-bottom: 1px solid #f5f5f5; cursor: pointer; transition: all 0.2s; }
    .trend-item:hover { padding-left: 4px; color: var(--crimson); }
    .trend-item:last-child { border-bottom: none; }
    .trend-item-content { flex: 1; display: flex; flex-direction: column; gap: 4px; }
    .trend-num { font-size: 1.3rem; font-weight: 900; color: var(--gold); min-width: 24px; font-family: 'Playfair Display', serif; }
    .trend-text { font-size: 0.85rem; color: var(--dark); line-height: 1.5; font-weight: 500; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
    .trend-likes { font-size: 0.75rem; color: var(--gray-light); font-weight: 600; }
    .trend-loading { text-align: center; padding: 1rem 0; color: var(--gray); font-size: 0.9rem; }
    .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .stat-box { text-align: center; padding: 1.2rem 0.8rem; background: linear-gradient(135deg, rgba(139,0,0,0.05) 0%, rgba(200,169,81,0.05) 100%); border-radius: 10px; transition: all 0.2s; }
    .stat-box:hover { background: linear-gradient(135deg, rgba(139,0,0,0.08) 0%, rgba(200,169,81,0.08) 100%); }
    .stat-num { font-size: 1.6rem; font-weight: 900; color: var(--crimson); font-family: 'Playfair Display', serif; }
    .stat-label { font-size: 0.75rem; color: var(--gray); margin-top: 6px; font-weight: 600; letter-spacing: 0.05em; }

    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.55); z-index: 1000; align-items: center; justify-content: center; padding: 1.5rem; backdrop-filter: blur(2px); }
    .modal-overlay.open { display: flex; animation: fadeIn 0.25s ease; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .modal { background: white; border-radius: 18px; width: 100%; max-width: 580px; overflow: hidden; animation: slideUp 0.35s cubic-bezier(0.4, 0, 0.2, 1); max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); }
    .modal-wide { max-width: 680px; }
    @keyframes slideUp { from { transform: translateY(40px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .modal-header { background: linear-gradient(135deg, var(--crimson) 0%, var(--crimson-dark) 100%); padding: 1.5rem 1.8rem; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1; box-shadow: 0 2px 8px rgba(139, 0, 0, 0.15); }
    .modal-header h3 { color: white; font-size: 1.1rem; font-weight: 700; }
    .modal-close { color: white; background: rgba(255,255,255,0.2); border: none; font-size: 1.5rem; cursor: pointer; line-height: 1; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 8px; transition: all 0.2s; }
    .modal-close:hover { background: rgba(255,255,255,0.35); }
    .modal-body { padding: 2rem; }
    .form-group { margin-bottom: 1.4rem; }
    .post-auth-box { border: 1.5px solid var(--border); border-radius: 10px; padding: 0.9rem; margin-bottom: 1.1rem; background: #fcfbfb; }
    .post-auth-options { display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 0.45rem; }
    .post-auth-option { display: inline-flex; align-items: center; gap: 6px; font-size: 0.84rem; color: var(--dark); }
    .post-auth-note { font-size: 0.76rem; color: var(--gray); margin-top: 0.5rem; line-height: 1.6; }
    .post-auth-actions { margin-top: 0.65rem; display: flex; gap: 0.5rem; align-items: stretch; flex-wrap: wrap; padding: 0.7rem; border: 1.5px solid rgba(139, 0, 0, 0.16); border-radius: 10px; background: linear-gradient(135deg, rgba(139,0,0,0.04) 0%, rgba(200,169,81,0.08) 100%); }
    .btn-login-inline { width: 100%; background: linear-gradient(135deg, var(--crimson) 0%, var(--crimson-dark) 100%); color: #fff; border: none; border-radius: 10px; padding: 10px 12px; font-size: 0.82rem; font-weight: 800; cursor: pointer; box-shadow: 0 3px 10px rgba(139,0,0,0.22); }
    .btn-login-inline:hover { transform: translateY(-1px); box-shadow: 0 5px 14px rgba(139,0,0,0.28); }
    .post-auth-hint { display: block; width: 100%; font-size: 0.76rem; color: var(--gray); line-height: 1.5; }
    .form-label { display: block; font-size: 0.85rem; font-weight: 700; color: var(--dark); margin-bottom: 0.55rem; letter-spacing: 0.02em; }
    .form-input, .form-select, .form-textarea { width: 100%; border: 1.5px solid var(--border); border-radius: 10px; padding: 11px 14px; font-size: 0.95rem; font-family: 'Noto Sans JP', sans-serif; color: var(--dark); outline: none; background: white; transition: all 0.2s; }
    .form-input:hover, .form-select:hover, .form-textarea:hover { border-color: var(--gray-lighter); }
    .form-input:focus, .form-select:focus, .form-textarea:focus { border-color: var(--crimson); box-shadow: 0 0 0 4px rgba(139, 0, 0, 0.1); }
    .form-textarea { resize: vertical; min-height: 110px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1.2rem; }
    .btn-submit { width: 100%; background: linear-gradient(135deg, var(--crimson) 0%, var(--crimson-dark) 100%); color: white; border: none; padding: 12px; border-radius: 10px; font-size: 0.98rem; font-weight: 700; cursor: pointer; font-family: 'Noto Sans JP', sans-serif; margin-top: 0.8rem; transition: all 0.2s; box-shadow: 0 4px 12px rgba(139, 0, 0, 0.25); }
    .btn-submit:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(139, 0, 0, 0.35); }
    .btn-submit:disabled { background: var(--gray-lighter); cursor: not-allowed; transform: none; }

    .qa-detail { padding: 2rem; }
    .qa-question-box { background: linear-gradient(135deg, #f8f3ff 0%, #f3f0ff 100%); border-left: 5px solid #7b1fa2; border-radius: 0 12px 12px 0; padding: 1.5rem 1.6rem; margin-bottom: 2rem; box-shadow: 0 2px 12px rgba(123, 31, 162, 0.08); }
    .qa-question-box .q-label { font-size: 0.78rem; font-weight: 700; color: #7b1fa2; margin-bottom: 0.7rem; letter-spacing: 0.05em; }
    .qa-question-box .q-text { font-size: 1.05rem; font-weight: 700; color: var(--dark); line-height: 1.6; }
    .answers-section h4 { font-size: 1rem; font-weight: 700; margin-bottom: 1.5rem; color: var(--dark); }
    .answer-item { background: white; border: 1.5px solid var(--border); border-radius: 12px; padding: 1.4rem; margin-bottom: 1rem; transition: all 0.2s; }
    .answer-item:hover { box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08); }
    .answer-meta { display: flex; gap: 10px; margin-bottom: 0.8rem; align-items: center; flex-wrap: wrap; }
    .answer-author { font-size: 0.85rem; font-weight: 700; color: var(--dark); }
    .answer-time { font-size: 0.78rem; color: var(--gray-light); }
    .best-badge { font-size: 0.72rem; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); color: #2e7d32; padding: 4px 10px; border-radius: 12px; font-weight: 700; }
    .answer-text { font-size: 0.92rem; color: var(--gray); line-height: 1.8; }
    .answer-input-area { margin-top: 1.5rem; border-top: 2px solid #f5f5f5; padding-top: 1.5rem; }
    .answer-input-area h4 { font-size: 0.95rem; font-weight: 700; margin-bottom: 1rem; }

    .post-detail { padding: 2rem; }
    .post-detail-header { display: flex; align-items: center; gap: 10px; margin-bottom: 1.5rem; flex-wrap: wrap; }
    .post-detail-meta { font-size: 0.85rem; font-weight: 600; color: var(--gray); }
    .post-detail-time { font-size: 0.78rem; color: var(--gray-light); }
    .post-detail-title { font-size: 1.4rem; font-weight: 700; color: var(--dark); margin-bottom: 1.5rem; line-height: 1.6; }
    .post-detail-body { font-size: 0.95rem; color: var(--gray); line-height: 1.8; margin-bottom: 1.5rem; }
    .post-detail-stats { display: flex; gap: 2rem; padding: 1.2rem; background: linear-gradient(135deg, rgba(139,0,0,0.05) 0%, rgba(200,169,81,0.05) 100%); border-radius: 10px; margin-bottom: 2rem; font-weight: 600; }
    
    .comments-section h4 { font-size: 1rem; font-weight: 700; margin-bottom: 1.5rem; color: var(--dark); }
    .comment-item { background: #f9f9f9; border: 1px solid var(--border); border-radius: 10px; padding: 1.2rem; margin-bottom: 1rem; transition: all 0.2s; }
    .comment-item:hover { background: white; box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06); }
    .comment-meta { display: flex; gap: 8px; margin-bottom: 0.7rem; align-items: center; flex-wrap: wrap; }
    .comment-author { font-size: 0.82rem; font-weight: 700; color: var(--dark); }
    .comment-time { font-size: 0.75rem; color: var(--gray-light); }
    .comment-delete { font-size: 0.85rem; color: #d00; cursor: pointer; margin-left: 0.5rem; }
    .comment-text { font-size: 0.9rem; color: var(--gray); line-height: 1.6; }
    .comment-input-area { margin-top: 1.5rem; border-top: 2px solid #f5f5f5; padding-top: 1.5rem; }
    .comment-input-area h5 { font-size: 0.9rem; font-weight: 700; margin-bottom: 0.8rem; color: var(--dark); }
    .ann-item { padding: 6px 0; border-bottom: 1px solid #eee; }

    /* Admin tabs */
    .admin-tabs { display: flex; gap: 8px; border-bottom: 2px solid #f0f0f0; margin-bottom: 1.5rem; }
    .admin-tab-btn { background: none; border: none; padding: 10px 16px; font-size: 0.9rem; font-weight: 600; color: var(--gray-light); cursor: pointer; transition: all 0.2s; border-bottom: 3px solid transparent; margin-bottom: -2px; }
    .admin-tab-btn.active { color: var(--crimson); border-bottom-color: var(--crimson); }
    .admin-tab-content { display: none; }
    .admin-tab-content.active { display: block; }
    .admin-tab-body { max-height: 500px; overflow-y: auto; }

    /* PR badge */
    .pr-badge { display: inline-block; background: linear-gradient(135deg, #ff6b6b 0%, #ff8e8e 100%); color: white; padding: 4px 10px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; margin-left: 8px; letter-spacing: 0.05em; }

    /* Pinned post */
    .post-pinned { background: linear-gradient(135deg, rgba(200, 169, 81, 0.15) 0%, rgba(200, 169, 81, 0.05) 100%); border: 2px solid #c8a951; }
    .post-pinned::before { content: '📌 ピン留め'; display: block; font-size: 0.75rem; color: #c8a951; font-weight: 700; margin-bottom: 8px; }
    .modal-admin { max-width: 600px; }

    /* ニックネーム設定モーダル */
    .nickname-modal { max-width: 420px; }

    /* Footer */
    .site-footer { border-top: 1px solid var(--border); padding: 1.5rem 1.5rem; text-align: center; }
    .site-footer p { font-size: 0.75rem; color: var(--gray-light); line-height: 1.7; max-width: 700px; margin: 0 auto; }

    /* Star rating */
    .star-rating { display: flex; flex-direction: row-reverse; justify-content: flex-end; gap: 4px; margin-top: 4px; }
    .star-rating input[type="radio"] { display: none; }
    .star-rating label { font-size: 2rem; color: #ddd; cursor: pointer; transition: color 0.15s; line-height: 1; }
    .star-rating input:checked ~ label,
    .star-rating label:hover,
    .star-rating label:hover ~ label { color: var(--gold); }

    /* Optional fields toggle */
    .btn-toggle-optional { width: 100%; background: linear-gradient(135deg, var(--crimson-pale) 0%, #fff5f5 100%); border: 1.5px solid var(--crimson-light); border-radius: 8px; padding: 11px 14px; font-size: 0.88rem; color: var(--crimson); cursor: pointer; margin: 0.75rem 0 0; transition: all 0.2s; font-family: 'Noto Sans JP', sans-serif; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 6px; }
    .btn-toggle-optional:hover { background: var(--crimson); color: #fff; border-color: var(--crimson); }
    .btn-toggle-optional::before { content: '＋'; font-size: 1rem; font-weight: 900; }
    .btn-toggle-optional.open::before { content: '－'; }
    .lecture-optional { overflow: hidden; max-height: 0; transition: max-height 0.4s ease; }
    .lecture-optional.open { max-height: 1000px; }
    .lecture-optional-inner { padding-top: 1rem; }

    /* extra_fields display on card */
    .extra-fields-bar { font-size: 0.75rem; color: var(--gray-light); margin-top: 4px; }

    /* Post modal notice */
    .post-notice { font-size: 0.78rem; color: var(--gray-light); text-align: center; margin-top: 0.6rem; padding-top: 0.8rem; border-top: 1px solid #f0f0f0; }

    /* Report button */
    .report-btn { font-size: 0.72rem; color: var(--gray-lighter); cursor: pointer; padding: 2px 6px; border-radius: 4px; transition: all 0.2s; margin-left: auto; opacity: 0; flex-shrink: 0; }
    .post-card:hover .report-btn, .qa-card:hover .report-btn { opacity: 1; }
    .report-btn:hover { color: #e65100; background: #fff3e0; opacity: 1; }
    @media (max-width: 768px) { .report-btn { opacity: 1; } }

    /* Report reason options */
    .report-reasons { display: flex; flex-direction: column; gap: 0.6rem; margin-bottom: 1.2rem; }
    .report-reason-label { display: flex; align-items: center; gap: 10px; padding: 10px 14px; border: 1.5px solid var(--border); border-radius: 8px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s; }
    .report-reason-label:hover { border-color: var(--crimson); background: var(--crimson-pale); }
    .report-reason-label input[type="radio"] { accent-color: var(--crimson); }

    @media (max-width: 992px) {
      .main { grid-template-columns: 1fr 220px; padding: 1.2rem 1rem; gap: 1.2rem; }

      /* Header */
      .header-inner { height: 54px; }
      .tabs { top: 54px; }
      .logo-jp { font-size: 1.2rem; }
      .nickname-badge { padding: 5px 11px; font-size: 0.76rem; }
      .btn-mypage { padding: 5px 10px; font-size: 0.72rem; }
      .btn-post { padding: 7px 14px; font-size: 0.8rem; }
      .btn-admin { padding: 5px 10px; font-size: 0.78rem; }

      /* Hero */
      .hero { padding: 1.6rem 1.2rem 1.4rem; }
      .hero h1 { font-size: 1.1rem; }
      .hero p { font-size: 0.85rem; margin-bottom: 1rem; }

      /* Announcement */
      .announcement-container { padding: 12px 16px; gap: 10px; }
      .announcement-icon { font-size: 26px; }
      .announcement-title { font-size: 1rem; }
      .announcement-body { font-size: 0.88rem; }

      /* Faculty bar */
      .faculty-bar { padding: 0.6rem 0.8rem; }
      .faculty-bar-inner { gap: 6px; }
      .faculty-label { font-size: 0.7rem; }
      .faculty-chip { padding: 5px 10px; font-size: 0.74rem; }

      /* Posts */
      .posts-header { flex-direction: column; align-items: flex-start; margin-bottom: 1rem; gap: 0.6rem; }
      .posts-header h2 { font-size: 1rem; }
      .post-card { padding: 1.2rem 1.3rem; margin-bottom: 1rem; }
      .post-title { font-size: 0.97rem; margin-bottom: 0.6rem; }
      .post-body { font-size: 0.85rem; }
      .post-footer { gap: 0.9rem; margin-top: 0.8rem; padding-top: 0.8rem; }
      .post-action { font-size: 0.78rem; }
      .category-tag { font-size: 0.68rem; padding: 4px 9px; }
      .faculty-tag { font-size: 0.68rem; padding: 4px 9px; }

      /* Sidebar */
      .sidebar { gap: 1rem; }
      .sidebar-card-body { padding: 1rem 0.9rem; }
      .sidebar-card-header { padding: 10px 12px; font-size: 0.85rem; }
    }

    @media (max-width: 768px) {
      .main { grid-template-columns: 1fr; padding: 1rem 0.9rem; gap: 1rem; }
      .sidebar { order: -1; }
      .posts-section { order: 0; }

      /* Header: hide English logo subtitle to save space */
      .header-inner { height: 52px; }
      .tabs { top: 52px; }
      .logo-en { display: none; }
      .logo-jp { font-size: 1.15rem; }
      .nickname-badge { padding: 5px 10px; font-size: 0.74rem; }
      .btn-mypage { padding: 5px 9px; font-size: 0.7rem; }
    }

    @media (max-width: 480px) {
      /* Header */
      .header-inner { height: 50px; }
      .tabs { top: 50px; }
      .logo-jp { font-size: 1.05rem; }
      .nickname-badge { max-width: 80px; overflow: hidden; text-overflow: ellipsis; padding: 5px 8px; font-size: 0.72rem; }
      .btn-mypage { padding: 5px 8px; font-size: 0.68rem; }
      .btn-post { padding: 6px 12px; font-size: 0.78rem; }

      /* Hero */
      .hero { padding: 1.3rem 1rem 1.2rem; }
      .hero h1 { font-size: 0.97rem; line-height: 1.6; }
      .hero p { font-size: 0.82rem; margin-bottom: 0.9rem; }
      .search-input { padding: 9px 12px; font-size: 0.85rem; }
      .search-btn { padding: 9px 14px; font-size: 0.83rem; }

      /* Posts */
      .post-card { padding: 1rem 1.1rem; }
      .post-action { font-size: 0.75rem; }

      /* Modal */
      .modal-body { padding: 1.2rem; }
      .form-label { font-size: 0.82rem; }

      /* Announcement */
      .announcement-title { font-size: 0.95rem; }
      .announcement-body { font-size: 0.82rem; }
    }

  /* ─── 受験生サポートパネル ─── */
  #juken-panel { display: none; max-width: 1100px; margin: 0 auto; padding: 0 1.2rem 64px; }

  /* メニューカード — 3つ常時表示 */
  .juken-menu { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.8rem; padding: 1.4rem 0 1.6rem; }
  @media (max-width: 900px) { .juken-menu { grid-template-columns: repeat(2, 1fr); } }
  @media (max-width: 600px) { .juken-menu { grid-template-columns: 1fr; } }
  .juken-menu-card { display: flex; align-items: center; gap: 0.8rem; padding: 1rem 1.1rem; background: var(--white); border: 1.5px solid var(--border); border-radius: 12px; cursor: pointer; transition: all 0.2s; text-align: left; font-family: 'Noto Sans JP', sans-serif; user-select: none; }
  .juken-menu-card:hover { border-color: var(--crimson); box-shadow: 0 2px 10px rgba(139,0,0,0.1); transform: translateY(-1px); }
  .juken-menu-card.active { border-color: var(--crimson); background: var(--crimson-pale); box-shadow: 0 2px 10px rgba(139,0,0,0.15); }
  .juken-menu-icon { font-size: 1.6rem; flex-shrink: 0; }
  .juken-menu-label { font-size: 0.82rem; font-weight: 700; color: var(--dark); line-height: 1.35; }
  .juken-menu-card.active .juken-menu-label { color: var(--crimson); }
  .juken-menu-desc { font-size: 0.72rem; color: var(--gray); margin-top: 2px; }
  .juken-subpanel { display: none; }
  .juken-subpanel.active { display: block; }

  .juken-section-head { margin-bottom: 1.2rem; }
  .juken-section-head h2 { font-size: 1.2rem; font-weight: 900; color: var(--dark); }
  .juken-section-head p { font-size: 0.85rem; color: var(--gray); margin-top: 0.25rem; }
  .juken-section-divider { width: 32px; height: 3px; background: var(--crimson); border-radius: 2px; margin: 0.4rem 0 0; }

  /* Q&A list in juken panel */
  .juken-qa-grid { display: flex; flex-direction: column; gap: 0.7rem; }
  .juken-qa-card { background: var(--white); border: 1.5px solid var(--border); border-radius: 10px; padding: 1rem 1.1rem; cursor: pointer; transition: border-color 0.2s; }
  .juken-qa-card:hover { border-color: var(--crimson); }
  .juken-qa-card.my-question { border-color: var(--gold-dark); box-shadow: 0 2px 10px rgba(200,169,81,0.18); background: #fffdf5; }
  .juken-qa-section-title { font-size: 0.78rem; font-weight: 800; color: var(--gray); margin: 0.2rem 0 0.45rem; letter-spacing: 0.02em; }
  .juken-qa-card-meta { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; margin-bottom: 0.4rem; }
  .juken-qa-faculty { font-size: 0.68rem; background: var(--crimson-pale); color: var(--crimson); padding: 2px 8px; border-radius: 4px; font-weight: 600; }
  .juken-qa-my-badge { font-size: 0.68rem; background: #fff8e1; color: #8a5d00; padding: 2px 8px; border-radius: 4px; font-weight: 700; }
  .juken-qa-title { font-size: 0.92rem; font-weight: 700; color: var(--dark); margin-bottom: 0.25rem; }
  .juken-qa-body { font-size: 0.8rem; color: var(--gray); overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical; }
  .juken-qa-footer { margin-top: 0.5rem; display: flex; gap: 1rem; font-size: 0.75rem; color: var(--gray-light); }

  /* Taikenki / faculty-comment forms */
  .juken-form-box { background: var(--white); border: 1.5px solid var(--border); border-radius: 12px; padding: 1.4rem; max-width: 640px; }
  .juken-form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 0.8rem; }
  @media (max-width: 600px) { .juken-form-row { grid-template-columns: 1fr; } }
  </style>
  </head>
  <body>

  <header>
    <div class="header-inner">
      <a class="logo" href="#"><span class="logo-jp">ワセダノート</span><span class="logo-en">WASEDA NOTE</span></a>
      <div class="header-right">
        <button class="btn-google-auth" id="googleAuthBtn" onclick="handleGoogleAuthClick()">Googleでログイン</button>
        <button class="btn-mypage" id="myPageBtn" onclick="openMyPageModal()">📌 マイページ</button>
        <div class="nickname-badge" id="nicknameBadge" onclick="openNicknameModal()">👤 設定中...</div>
        <button class="btn-admin" id="adminBtn" style="display:none;margin-right:0.5rem;" onclick="openAdminModal()">⚙️ 管理</button>
        <button class="btn-post" onclick="openPostModal()">＋ 投稿する</button>
      </div>
    </div>
  </header>

  <div id="announcementBanner" class="announcement-banner" style="display:none;">
    <div class="announcement-container">
      <span class="announcement-icon">📢</span>
      <div class="announcement-content">
        <div class="announcement-title" id="announcementTitle"></div>
        <div class="announcement-body" id="announcementBody"></div>
      </div>
      <button class="announcement-close" onclick="closeAnnouncementBanner()">✕</button>
    </div>
  </div>

  <a href="juken.html" class="juken-banner">📚 早稲田を目指している方はこちら →</a>

  <div class="hero">
    <h1>早稲田生のための、早稲田生による情報共有</h1>
    <p>授業の口コミ・サークル・キャンパスライフをみんなでシェアしよう</p>
    <div class="search-bar">
      <input class="search-input" type="text" id="searchInput" placeholder="🔍 授業名・キーワードで検索..." onkeydown="if(event.key==='Enter')doSearch()">
      <button class="search-btn" onclick="doSearch()">検索</button>
    </div>
  </div>

  <div class="faculty-bar">
    <div class="faculty-bar-inner">
      <span class="faculty-label">学部：</span>
      <button class="faculty-chip active" onclick="selectFaculty('all',this)">すべて</button>
      <button class="faculty-chip" onclick="selectFaculty('seikei',this)">政治経済</button>
      <button class="faculty-chip" onclick="selectFaculty('ho',this)">法</button>
      <button class="faculty-chip" onclick="selectFaculty('shogaku',this)">商</button>
      <button class="faculty-chip" onclick="selectFaculty('kyoiku',this)">教育</button>
      <button class="faculty-chip" onclick="selectFaculty('bun',this)">文</button>
      <button class="faculty-chip" onclick="selectFaculty('bunkagaku',this)">文化構想</button>
      <button class="faculty-chip" onclick="selectFaculty('kiso',this)">基幹理工</button>
      <button class="faculty-chip" onclick="selectFaculty('sozo',this)">創造理工</button>
      <button class="faculty-chip" onclick="selectFaculty('sentan',this)">先進理工</button>
      <button class="faculty-chip" onclick="selectFaculty('ningen',this)">人間科学</button>
      <button class="faculty-chip" onclick="selectFaculty('sports',this)">スポーツ科学</button>
      <button class="faculty-chip" onclick="selectFaculty('kokusai',this)">国際教養</button>
      <button class="faculty-chip" onclick="selectFaculty('shakou',this)">社会科学</button>
    </div>
  </div>

  <div class="tabs">
    <div class="tabs-inner" id="tabsInner">
      <div class="tab active" onclick="switchTab('all',this)" data-label="all">📋 すべて</div>
      <div class="tab" onclick="switchTab('lecture',this)" data-label="lecture">📚 授業</div>
      <div class="tab" onclick="switchTab('circle',this)" data-label="circle">🎯 サークル</div>
      <div class="tab" onclick="switchTab('campus',this)" data-label="campus">🏫 キャンパス</div>
      <div class="tab" onclick="switchTab('qa',this)" data-label="qa">❓ Q&amp;A</div>
      <div class="tab" onclick="switchTab('juken',this)" data-label="juken">🎓 受験生サポート</div>
    </div>
    <button class="tabs-scroll-btn" id="tabsScrollBtn" onclick="scrollTabsRight()" aria-label="もっと見る">›</button>
  </div>

  <div class="main">
    <div class="posts-section">
      <div id="search-banner" class="search-banner">
        <span id="search-banner-text"></span>
        <span class="clear-search" onclick="clearSearch()">✕ クリア</span>
      </div>
      <div class="posts-header">
        <h2 id="section-title">新着投稿</h2>
        <div class="posts-header-controls">
          <button class="btn-post" id="categoryPostBtn" style="margin: 0;" onclick="openPostModalWithCategory()">＋ 投稿する</button>
          <select class="sort-select" id="sortSelect" onchange="updateSort()"><option value="newest">新着順</option><option value="popular">人気順（24時間）</option></select>
        </div>
      </div>
      <div id="posts-container"><div class="loading">読み込み中...</div></div>
    </div>

    <aside class="sidebar">
      <div class="sidebar-card">
        <div class="sidebar-card-header">🔥 トレンド</div>
        <div class="sidebar-card-body">
          <div class="trend-tabs">
            <button class="trend-tab active" data-cat="lecture">授業口コミ</button>
            <button class="trend-tab" data-cat="circle">サークル</button>
            <button class="trend-tab" data-cat="campus">キャンパスライフ</button>
            <button class="trend-tab" data-cat="qa">Q&amp;A</button>
          </div>
          <div id="trendContainer"><div class="trend-loading">読み込み中...</div></div>
        </div>
      </div>
    </aside>
  </div>

  <!-- 受験生サポートパネル -->
  <div id="juken-panel">

    <!-- メニューカード -->
    <div class="juken-menu">
      <button class="juken-menu-card active" onclick="switchJukenSubTab('qa-study', this)">
        <span class="juken-menu-icon">❓</span>
        <div><div class="juken-menu-label">勉強の質問に答える</div><div class="juken-menu-desc">受験対策の経験を共有</div></div>
      </button>
      <button class="juken-menu-card" onclick="switchJukenSubTab('qa-life', this)">
        <span class="juken-menu-icon">🏫</span>
        <div><div class="juken-menu-label">大学生活の質問に答える</div><div class="juken-menu-desc">キャンパス・生活の実情を共有</div></div>
      </button>
      <button class="juken-menu-card" onclick="switchJukenSubTab('taikenki', this)">
        <span class="juken-menu-icon">🏆</span>
        <div><div class="juken-menu-label">合格体験記を書く</div><div class="juken-menu-desc">受験勉強・参考書など</div></div>
      </button>
      <button class="juken-menu-card" onclick="switchJukenSubTab('fc', this)">
        <span class="juken-menu-icon">💬</span>
        <div><div class="juken-menu-label">学部コメントを書く</div><div class="juken-menu-desc">雰囲気・就職・男女比など</div></div>
      </button>
    </div>

    <!-- Sub-panel ①: 勉強の質問に答える -->
    <div class="juken-subpanel active" id="juken-sub-qa-study">
      <div class="juken-section-head">
        <h2>❓ 受験生からの質問（勉強）</h2>
        <div class="juken-section-divider"></div>
        <p>受験勉強・科目対策・過去問などの質問一覧です。あなたの経験で受験生を助けましょう。</p>
      </div>
      <div id="juken-qa-study-list" class="juken-qa-grid"><div class="loading">読み込み中...</div></div>
    </div>

    <!-- Sub-panel ②: 大学生活の質問に答える -->
    <div class="juken-subpanel" id="juken-sub-qa-life">
      <div class="juken-section-head">
        <h2>🏫 受験生からの質問（大学生活）</h2>
        <div class="juken-section-divider"></div>
        <p>キャンパスの雰囲気・通学・一人暮らし・時間割など、大学生活に関する質問一覧です。</p>
      </div>
      <div id="juken-qa-life-list" class="juken-qa-grid"><div class="loading">読み込み中...</div></div>
    </div>

    <!-- Sub-panel ③: 合格体験記を書く -->
    <div class="juken-subpanel" id="juken-sub-taikenki">
      <div class="juken-section-head">
        <h2>🏆 合格体験記を書く</h2>
        <div class="juken-section-divider"></div>
        <p>あなたの受験体験を後輩に伝えてください。</p>
      </div>
      <div class="juken-form-box">
          <div class="juken-form-row">
            <div class="form-group">
              <label class="form-label">ニックネーム <span style="color:#e74c3c">*</span></label>
              <input class="form-input" type="text" id="tk-author" placeholder="匿名OK" maxlength="20">
            </div>
            <div class="form-group">
              <label class="form-label">合格学部 <span style="color:#e74c3c">*</span></label>
              <select class="form-select" id="tk-faculty">
                <option value="">選択してください</option>
                <option value="seikei">政治経済学部</option><option value="ho">法学部</option>
                <option value="shogaku">商学部</option><option value="kyoiku">教育学部</option>
                <option value="bun">文学部</option><option value="bunkagaku">文化構想学部</option>
                <option value="kiso">基幹理工学部</option><option value="sozo">創造理工学部</option>
                <option value="sentan">先進理工学部</option><option value="ningen">人間科学部</option>
                <option value="sports">スポーツ科学部</option><option value="kokusai">国際教養学部</option>
                <option value="shakou">社会科学部</option>
              </select>
            </div>
          </div>
          <div class="juken-form-row">
            <div class="form-group">
              <label class="form-label">受験方式</label>
              <select class="form-select" id="tk-exam-type">
                <option value="">選択（任意）</option>
                <option value="一般">一般</option><option value="共テ利用">共テ利用</option>
                <option value="AO">AO</option><option value="推薦">推薦</option>
                <option value="その他">その他</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">勉強開始時期</label>
              <select class="form-select" id="tk-study-start">
                <option value="">選択（任意）</option>
                <option value="中学生以前">中学生以前</option><option value="高1">高1</option>
                <option value="高2">高2</option><option value="高3春">高3春</option>
                <option value="高3夏">高3夏</option><option value="高3秋以降">高3秋以降</option>
              </select>
            </div>
          </div>
          <div class="juken-form-row">
            <div class="form-group">
              <label class="form-label">1日の平均勉強時間</label>
              <select class="form-select" id="tk-daily-hours">
                <option value="">選択（任意）</option>
                <option value="1時間未満">1時間未満</option><option value="1-3時間">1〜3時間</option>
                <option value="3-5時間">3〜5時間</option><option value="5-8時間">5〜8時間</option>
                <option value="8時間以上">8時間以上</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">一番大変だった科目</label>
              <input class="form-input" type="text" id="tk-hard-subject" placeholder="例：英語">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">使った参考書・サービス</label>
            <input class="form-input" type="text" id="tk-references" placeholder="例：ターゲット1900、スタディサプリ">
          </div>
          <div class="form-group">
            <label class="form-label">後輩へのアドバイス <span style="color:#e74c3c">*</span></label>
            <textarea class="form-textarea" id="tk-advice" placeholder="受験生へ伝えたいことを自由に書いてください..." style="min-height:100px"></textarea>
          </div>
          <button class="btn-submit" onclick="submitTaikenki(this)">体験記を投稿する</button>
        </div>
    </div>

    <!-- Sub-panel ④: 学部コメントを書く -->
    <div class="juken-subpanel" id="juken-sub-fc">
      <div class="juken-section-head">
        <h2>💬 学部コメントを書く</h2>
        <div class="juken-section-divider"></div>
        <p>受験生へ、あなたの学部のリアルを教えてあげよう</p>
      </div>
      <div class="juken-form-box">
        <div class="form-group">
          <label class="form-label">ニックネーム <span style="color:#e74c3c">*</span></label>
          <input class="form-input" type="text" id="fc-author" placeholder="匿名OK" maxlength="20">
        </div>
        <div class="form-group">
          <label class="form-label">学部 <span style="color:#e74c3c">*</span></label>
          <select class="form-select" id="fc-faculty">
            <option value="">選択してください</option>
            <option value="seikei">政治経済学部</option><option value="ho">法学部</option>
            <option value="shogaku">商学部</option><option value="kyoiku">教育学部</option>
            <option value="bun">文学部</option><option value="bunkagaku">文化構想学部</option>
            <option value="kiso">基幹理工学部</option><option value="sozo">創造理工学部</option>
            <option value="sentan">先進理工学部</option><option value="ningen">人間科学部</option>
            <option value="sports">スポーツ科学部</option><option value="kokusai">国際教養学部</option>
            <option value="shakou">社会科学部</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">コメント <span style="color:#e74c3c">*</span></label>
          <textarea class="form-textarea" id="fc-comment" placeholder="授業の雰囲気・就職・男女比など、受験生に伝えたいことを..." style="min-height:90px"></textarea>
        </div>
        <button class="btn-submit" onclick="submitFacultyComment(this)">コメントを投稿する</button>
      </div>
    </div>

  </div>

  <!-- 投稿モーダル -->
  <div class="modal-overlay" id="postModal">
    <div class="modal">
      <div class="modal-header">
        <h3>✏️ 新規投稿</h3>
        <button class="modal-close" onclick="closePostModal()">×</button>
      </div>
      <div class="modal-body">
        <div class="post-auth-box">
          <label class="form-label" id="postAuthLabel" style="margin-bottom:0;">投稿方法 <span style="color:#e74c3c;">*</span></label>
          <div class="post-auth-options" id="postAuthOptions">
            <label class="post-auth-option"><input type="radio" name="postAuthMode" value="login" onchange="onPostAuthModeChange()"> ログインして投稿（追跡・削除・マイページ対応）</label>
            <label class="post-auth-option"><input type="radio" name="postAuthMode" value="guest" onchange="onPostAuthModeChange()"> ログインせず投稿（追跡不可）</label>
          </div>
          <div class="post-auth-actions" id="postAuthActions" style="display:none;">
            <button type="button" class="btn-login-inline" onclick="handleGoogleAuthClick('post-modal')">この画面のままGoogleでログイン</button>
            <span class="post-auth-hint">ログイン完了後は投稿画面に自動で戻ります。</span>
          </div>
          <div class="post-auth-note" id="postAuthNote"></div>
        </div>

        <div class="form-group">
          <label class="form-label">ニックネーム <span style="color:#e74c3c;">*</span></label>
          <input class="form-input" type="text" id="postNickname" placeholder="例：waseda_taro" maxlength="20">
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">カテゴリ</label>
            <select class="form-select" id="postCategory" onchange="onCategoryChange(this.value)">
              <option value="lecture">📚 授業口コミ</option>
              <option value="circle">🎯 サークル情報</option>
              <option value="campus">🏫 キャンパスライフ</option>
              <option value="qa">❓ Q&amp;A（質問）</option>
            </select>
          </div>
        </div>

        <!-- 授業口コミ専用フィールド -->
        <div id="lecture-fields" class="category-fields">
          <!-- 必須フィールド -->
          <div class="form-group">
            <label class="form-label">授業名 <span style="color:#e74c3c;">*</span></label>
            <input class="form-input" type="text" id="lectureName" placeholder="例：政治経済学入門">
          </div>
          <div class="form-group">
            <label class="form-label">評価 <span style="color:#e74c3c;">*</span></label>
            <div class="star-rating">
              <input type="radio" id="star5" name="lectureStars" value="5"><label for="star5">★</label>
              <input type="radio" id="star4" name="lectureStars" value="4"><label for="star4">★</label>
              <input type="radio" id="star3" name="lectureStars" value="3"><label for="star3">★</label>
              <input type="radio" id="star2" name="lectureStars" value="2"><label for="star2">★</label>
              <input type="radio" id="star1" name="lectureStars" value="1"><label for="star1">★</label>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">レビュー <span style="color:#e74c3c;">*</span></label>
            <textarea class="form-textarea" id="lectureBody" placeholder="授業の感想や評価を書いてください..."></textarea>
          </div>
          <!-- 任意フィールドトグル -->
          <button type="button" class="btn-toggle-optional" id="lectureOptionalToggle" onclick="toggleLectureOptional()">詳細を追加する</button>
          <div class="lecture-optional" id="lectureOptional">
            <div class="lecture-optional-inner">
              <div class="form-group">
                <label class="form-label">学部</label>
                <select class="form-select" id="lectureFaculty">
                  <option value="">学部を選択（任意）</option>
                  <option value="seikei">政治経済学部</option>
                  <option value="ho">法学部</option>
                  <option value="shogaku">商学部</option>
                  <option value="kyoiku">教育学部</option>
                  <option value="bun">文学部</option>
                  <option value="bunkagaku">文化構想学部</option>
                  <option value="kiso">基幹理工学部</option>
                  <option value="sozo">創造理工学部</option>
                  <option value="sentan">先進理工学部</option>
                  <option value="ningen">人間科学部</option>
                  <option value="sports">スポーツ科学部</option>
                  <option value="kokusai">国際教養学部</option>
                  <option value="shakou">社会科学部</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">担当教員名</label>
                <input class="form-input" type="text" id="lectureTeacher" placeholder="例：田中 太郎（任意）">
              </div>
              <div class="form-group">
                <label class="form-label">学期</label>
                <select class="form-select" id="lectureSemester">
                  <option value="">選択（任意）</option>
                  <option value="春学期">春学期</option>
                  <option value="秋学期">秋学期</option>
                  <option value="通年">通年</option>
                  <option value="集中講義">集中講義</option>
                </select>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">曜日</label>
                  <select class="form-select" id="lectureDay">
                    <option value="">選択（任意）</option>
                    <option value="月">月曜</option>
                    <option value="火">火曜</option>
                    <option value="水">水曜</option>
                    <option value="木">木曜</option>
                    <option value="金">金曜</option>
                    <option value="土">土曜</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">時限</label>
                  <select class="form-select" id="lecturePeriod">
                    <option value="">選択（任意）</option>
                    <option value="1">1限</option>
                    <option value="2">2限</option>
                    <option value="3">3限</option>
                    <option value="4">4限</option>
                    <option value="5">5限</option>
                    <option value="6">6限</option>
                  </select>
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">評価方法</label>
                <select class="form-select" id="lectureExamType">
                  <option value="">選択（任意）</option>
                  <option value="テスト">テスト</option>
                  <option value="レポート">レポート</option>
                  <option value="両方">テスト＋レポート</option>
                  <option value="その他">その他</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">出席</label>
                <select class="form-select" id="lectureAttendance">
                  <option value="">選択（任意）</option>
                  <option value="毎回">毎回</option>
                  <option value="時々">時々</option>
                  <option value="なし">なし</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">単位の取りやすさ</label>
                <select class="form-select" id="lectureCredits">
                  <option value="">選択（任意）</option>
                  <option value="楽">楽</option>
                  <option value="普通">普通</option>
                  <option value="難しい">難しい</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <!-- サークル専用フィールド -->
        <div id="circle-fields" class="category-fields" style="display:none;">
          <div class="form-group">
            <label class="form-label">サークル名 <span style="color:#e74c3c;">*</span></label>
            <input class="form-input" type="text" id="circleName" placeholder="例：ダンスサークル WASEDA">
          </div>
          <div class="form-group">
            <label class="form-label">サークルの種類</label>
            <select class="form-select" id="circleType">
              <option value="">種類を選択（任意）</option>
              <option value="sports">運動系</option>
              <option value="culture">文化系</option>
              <option value="other">その他</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">内容 <span style="color:#e74c3c;">*</span></label>
            <textarea class="form-textarea" id="circleBody" placeholder="サークルの説明、募集情報などを書いてください..."></textarea>
          </div>
        </div>

        <!-- キャンパスライフ専用フィールド -->
        <div id="campus-fields" class="category-fields" style="display:none;">
          <div class="form-group">
            <label class="form-label">タイトル <span style="color:#e74c3c;">*</span></label>
            <input class="form-input" type="text" id="campusTitle" placeholder="例：紅葉の季節の早稲田キャンパス">
          </div>
          <div class="form-group">
            <label class="form-label">場所</label>
            <select class="form-select" id="campusLocation">
              <option value="">場所を選択（任意）</option>
              <option value="waseda">早稲田キャンパス</option>
              <option value="nishi">西早稲田キャンパス</option>
              <option value="toyama">戸山キャンパス</option>
              <option value="tokorozawa">所沢キャンパス</option>
              <option value="other">その他</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">日時</label>
            <input class="form-input" type="text" id="campusDateTime" placeholder="例：2月27日（木）14時頃（任意）">
          </div>
          <div class="form-group">
            <label class="form-label">学部 <span style="color:#e74c3c;">*</span></label>
            <select class="form-select" id="campusFaculty">
              <option value="">学部を選択</option>
              <option value="seikei">政治経済学部</option>
              <option value="ho">法学部</option>
              <option value="shogaku">商学部</option>
              <option value="kyoiku">教育学部</option>
              <option value="bun">文学部</option>
              <option value="bunkagaku">文化構想学部</option>
              <option value="kiso">基幹理工学部</option>
              <option value="sozo">創造理工学部</option>
              <option value="sentan">先進理工学部</option>
              <option value="ningen">人間科学部</option>
              <option value="sports">スポーツ科学部</option>
              <option value="kokusai">国際教養学部</option>
              <option value="shakou">社会科学部</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">内容 <span style="color:#e74c3c;">*</span></label>
            <textarea class="form-textarea" id="campusBody" placeholder="詳しい内容を書いてください..."></textarea>
          </div>
        </div>

        <!-- Q&A専用フィールド -->
        <div id="qa-fields" class="category-fields" style="display:none;">
          <div class="form-group">
            <label class="form-label">質問タイトル <span style="color:#e74c3c;">*</span></label>
            <input class="form-input" type="text" id="qaTitle" placeholder="例：どの学部の授業を取るのがおすすめ？">
          </div>
          <div class="form-group">
            <label class="form-label">学部 <span style="color:#e74c3c;">*</span></label>
            <select class="form-select" id="qaFaculty">
              <option value="">学部を選択</option>
              <option value="seikei">政治経済学部</option>
              <option value="ho">法学部</option>
              <option value="shogaku">商学部</option>
              <option value="kyoiku">教育学部</option>
              <option value="bun">文学部</option>
              <option value="bunkagaku">文化構想学部</option>
              <option value="kiso">基幹理工学部</option>
              <option value="sozo">創造理工学部</option>
              <option value="sentan">先進理工学部</option>
              <option value="ningen">人間科学部</option>
              <option value="sports">スポーツ科学部</option>
              <option value="kokusai">国際教養学部</option>
              <option value="shakou">社会科学部</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">詳細 <span style="color:#e74c3c;">*</span></label>
            <textarea class="form-textarea" id="qaBody" placeholder="質問の詳細を書いてください..."></textarea>
          </div>
        </div>

        <button class="btn-submit" id="submitBtn" onclick="submitPost()">投稿する</button>
        <p class="post-notice">投稿内容には責任を持ち、良識ある投稿をお願いします。</p>
      </div>
    </div>
  </div>

  <footer class="site-footer">
    <p>ワセダノートは早稲田大学の公式サービスではありません。本サービスに投稿された内容は投稿者個人の意見であり、運営は投稿内容の正確性・適切性について一切の責任を負いません。利用者は良識ある投稿を心がけてください。</p>
  </footer>

  <!-- 通報モーダル -->
  <div class="modal-overlay" id="reportModal">
    <div class="modal" style="max-width:400px;">
      <div class="modal-header">
        <h3>🚩 通報</h3>
        <button class="modal-close" onclick="closeReportModal()">×</button>
      </div>
      <div class="modal-body">
        <p style="font-size:0.88rem;color:var(--gray);margin-bottom:1.2rem;">通報理由を選択してください。悪質な投稿は削除される場合があります。</p>
        <div class="report-reasons">
          <label class="report-reason-label"><input type="radio" name="reportReason" value="不適切なコンテンツ"> 不適切なコンテンツ</label>
          <label class="report-reason-label"><input type="radio" name="reportReason" value="スパム"> スパム</label>
          <label class="report-reason-label"><input type="radio" name="reportReason" value="誹謗中傷"> 誹謗中傷</label>
          <label class="report-reason-label"><input type="radio" name="reportReason" value="その他"> その他</label>
        </div>
        <button class="btn-submit" onclick="submitReport()">通報する</button>
      </div>
    </div>
  </div>

  <!-- 管理パネルモーダル -->
  <!-- admin modal with tabs -->
  <div class="modal-overlay" id="adminModal">
    <div class="modal modal-admin">
      <div class="modal-header">
        <h3>⚙️ 管理パネル</h3>
        <button class="modal-close" onclick="closeAdminModal()">×</button>
      </div>
      <div class="admin-tabs">
        <button class="admin-tab-btn active" data-tab="announcements" onclick="switchAdminTab('announcements')">📢 お知らせ管理</button>
        <button class="admin-tab-btn" data-tab="jobs" onclick="switchAdminTab('jobs')">💼 求人・PR管理</button>
        <button class="admin-tab-btn" data-tab="posts" onclick="switchAdminTab('posts')">📝 投稿管理</button>
        <button class="admin-tab-btn" data-tab="reports" onclick="switchAdminTab('reports')">🚩 通報管理</button>
      </div>
      <div class="modal-body admin-tab-body">
        <!-- お知らせ管理 tab -->
        <div id="tab-announcements" class="admin-tab-content active">
          <h4>📢 お知らせを作成</h4>
          <div class="form-group">
            <label class="form-label">タイトル</label>
            <input class="form-input" type="text" id="announceTitle" placeholder="お知らせタイトル">
          </div>
          <div class="form-group">
            <label class="form-label">内容</label>
            <textarea class="form-textarea" id="announceBody" placeholder="お知らせ内容"></textarea>
          </div>
          <label style="display:flex;gap:8px;margin-bottom:1rem;align-items:center;">
            <input type="checkbox" id="announceActive" checked>
            <span>有効にする</span>
          </label>
          <button class="btn-submit" onclick="submitAnnouncement()">お知らせを投稿</button>
          <hr style="margin:1.5rem 0;">
          <h4>📋 一覧</h4>
          <div id="announcementList"></div>
        </div>

        <!-- 求人・PR管理 tab -->
        <div id="tab-jobs" class="admin-tab-content" style="display:none;">
          <h4>💼 求人・PRを作成</h4>
          <div class="form-group">
            <label class="form-label">企業名</label>
            <input class="form-input" type="text" id="jobCompany" placeholder="企業名">
          </div>
          <div class="form-group">
            <label class="form-label">職種・タイトル</label>
            <input class="form-input" type="text" id="jobTitle" placeholder="例：エンジニア募集">
          </div>
          <div class="form-group">
            <label class="form-label">説明</label>
            <textarea class="form-textarea" id="jobDesc" placeholder="求人の詳細情報"></textarea>
          </div>
          <label style="display:flex;gap:8px;margin-bottom:1rem;align-items:center;">
            <input type="checkbox" id="jobPR" checked>
            <span>PRバッジを表示</span>
          </label>
          <button class="btn-submit" onclick="submitJob()">求人を投稿</button>
          <hr style="margin:1.5rem 0;">
          <h4>📋 投稿済み求人</h4>
          <div id="jobPostList"></div>
        </div>

        <!-- 投稿管理 tab -->
        <div id="tab-posts" class="admin-tab-content" style="display:none;">
          <h4>📝 投稿を管理</h4>
          <p style="color:#666;margin-bottom:1rem;">投稿一覧から削除・ピン留めを操作できます</p>
          <div id="adminPostList" style="max-height:400px;overflow-y:auto;"></div>
        </div>

        <!-- 通報管理 tab -->
        <div id="tab-reports" class="admin-tab-content" style="display:none;">
          <h4>🚩 通報一覧（未対応）</h4>
          <p style="color:#666;margin-bottom:1rem;">未解決の通報を確認・対応できます</p>
          <div id="adminReportList" style="max-height:400px;overflow-y:auto;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- 投稿詳細モーダル（コメント表示用） -->
  <div class="modal-overlay" id="postDetailModal">
    <div class="modal modal-wide">
      <div class="modal-header">
        <h3 id="detailModalTitle">投稿詳細</h3>
        <button class="modal-close" onclick="closePostDetailModal()">×</button>
      </div>
      <div id="post-detail-content"></div>
    </div>
  </div>

  <!-- Q&Aモーダル -->
  <div class="modal-overlay" id="qaModal">
    <div class="modal modal-wide">
      <div class="modal-header">
        <h3>❓ Q&amp;A スレッド</h3>
        <button class="modal-close" onclick="closeQaModal()">×</button>
      </div>
      <div id="qa-detail-content"></div>
    </div>
  </div>

  <!-- ニックネームモーダル -->
  <div class="modal-overlay" id="nicknameModal">
    <div class="modal nickname-modal">
      <div class="modal-header">
        <h3>👤 ニックネーム設定</h3>
        <button class="modal-close" onclick="closeNicknameModal()">×</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">ニックネーム</label>
          <input class="form-input" type="text" id="nicknameInput" placeholder="例：waseda_taro" maxlength="20">
        </div>
        <button class="btn-submit" onclick="saveNickname()">保存する</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="myPageModal">
    <div class="modal modal-wide">
      <div class="modal-header">
        <h3>📌 マイページ</h3>
        <button class="modal-close" onclick="closeMyPageModal()">×</button>
      </div>
      <div class="modal-body">
        <div id="myPageSummary" style="font-size:0.86rem;color:var(--gray);margin-bottom:1rem;">読み込み中...</div>
        <div id="myPageList"></div>
      </div>
    </div>
  </div>

  <script>
  // Supabase初期化（CDNのエクスポートの違いに対応する）
  const SUPABASE_URL = 'https://hazntivymzywhowtdtcc.supabase.co';
  const SUPABASE_ANON_KEY = 'sb_publishable_Mr1wt5ZOoLtmYqPEoIKeUw_cM4ZPSbN';
  let db;
  try {
    const supabaseOptions = { auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true } };
    if (typeof createClient === 'function') {
      db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, supabaseOptions);
    } else if (window.supabase && typeof window.supabase.createClient === 'function') {
      db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, supabaseOptions);
    } else {
      throw new Error('Supabase client not found');
    }
  } catch (e) {
    console.error('Supabase init error:', e);
  }

  const FACULTIES = {
    seikei:'政治経済学部', ho:'法学部', shogaku:'商学部', kyoiku:'教育学部',
    bun:'文学部', bunkagaku:'文化構想学部', kiso:'基幹理工学部', sozo:'創造理工学部',
    sentan:'先進理工学部', ningen:'人間科学部', sports:'スポーツ科学部',
    kokusai:'国際教養学部', shakou:'社会科学部'
  };

  let currentTab = 'all';
  let currentFaculty = 'all';
  let currentSort = 'newest';
  let currentTrendCategory = 'lecture';
  let searchQuery = '';
  let currentUser = localStorage.getItem('waseda_nickname') || 'ゲスト';
  let googleAuthUser = null;
  const AUTH_REDIRECT_URL = 'https://waseda-ten.vercel.app/index.html';
  const TRUSTED_AUTH_HOSTS = ['waseda-ten.vercel.app'];
  const POST_AUTH_RETURN_KEY = 'waseda_post_auth_return';
  const POST_AUTH_DRAFT_KEY = 'waseda_post_auth_draft';
  const POST_AUTH_DRAFT_TS_KEY = 'waseda_post_auth_draft_ts';

  function getGoogleDisplayName(user) {
    return user?.user_metadata?.name || user?.user_metadata?.full_name || user?.email || 'ログイン中ユーザー';
  }

  function getAuthRedirectUrl() {
    try {
      const url = new URL(window.location.href);
      const isHttp = url.protocol === 'http:' || url.protocol === 'https:';
      const isTrustedHost = TRUSTED_AUTH_HOSTS.includes(url.hostname);
      if (isHttp && isTrustedHost) return `${url.origin}${url.pathname}`;
    } catch (e) {
      console.warn('redirect URL parse failed:', e);
    }
    return AUTH_REDIRECT_URL;
  }

  function renderAccountSummary() {
    const nick = document.getElementById('nicknameBadge');
    const myPageBtn = document.getElementById('myPageBtn');
    if (nick) {
      const name = (currentUser || '').trim();
      nick.textContent = name && name !== 'ゲスト' ? `👤 ニックネーム: ${name}` : '👤 ニックネームを設定';
      nick.title = googleAuthUser
        ? '現在はログイン投稿モードです。クリックでニックネームを変更できます。'
        : '現在は未ログインです。クリックでニックネームを設定できます。';
    }
    if (myPageBtn) {
      myPageBtn.textContent = googleAuthUser ? '📌 マイページ（追跡中）' : '📌 マイページ（ログインで追跡）';
      myPageBtn.title = googleAuthUser ? 'あなたの投稿を確認・削除できます' : 'ログインするとあなたの投稿を追跡・削除できます';
    }
  }

  function renderGoogleAuthButton() {
    const btn = document.getElementById('googleAuthBtn');
    if (!btn) return;
    if (googleAuthUser) {
      btn.classList.add('logged-in');
      btn.innerHTML = `<span class="google-g">G</span><span class="google-user-name">${escHtml(getGoogleDisplayName(googleAuthUser))}</span>`;
      btn.title = 'クリックでログアウト';
    } else {
      btn.classList.remove('logged-in');
      btn.textContent = 'Googleでログイン（投稿追跡）';
      btn.title = 'ログインすると投稿を追跡・削除できます';
    }
    renderAccountSummary();
  }

  function savePostDraftBeforeAuth() {
    const modal = document.getElementById('postModal');
    if (!modal?.classList.contains('open')) return;
    const draft = {
      authMode: getPostAuthMode(),
      category: document.getElementById('postCategory')?.value || 'lecture',
      fields: {}
    };
    const fieldIds = [
      'postNickname', 'postCategory',
      'lectureName', 'lectureBody', 'lectureFaculty', 'lectureTeacher', 'lectureSemester', 'lectureDay', 'lecturePeriod', 'lectureExamType', 'lectureAttendance', 'lectureCredits',
      'circleName', 'circleType', 'circleBody',
      'campusTitle', 'campusLocation', 'campusDateTime', 'campusFaculty', 'campusBody',
      'qaTitle', 'qaFaculty', 'qaBody'
    ];
    fieldIds.forEach(id => {
      const el = document.getElementById(id);
      if (el) draft.fields[id] = el.value;
    });
    const selectedStar = document.querySelector('input[name="lectureStars"]:checked');
    if (selectedStar) draft.fields.lectureStars = selectedStar.value;
    const nowTs = String(Date.now());
    const draftStr = JSON.stringify(draft);
    sessionStorage.setItem(POST_AUTH_DRAFT_KEY, draftStr);
    sessionStorage.setItem(POST_AUTH_RETURN_KEY, '1');
    sessionStorage.setItem(POST_AUTH_DRAFT_TS_KEY, nowTs);
    localStorage.setItem(POST_AUTH_DRAFT_KEY, draftStr);
    localStorage.setItem(POST_AUTH_RETURN_KEY, '1');
    localStorage.setItem(POST_AUTH_DRAFT_TS_KEY, nowTs);
  }

  function restorePostDraftAfterAuthIfNeeded() {
    const sessionReturn = sessionStorage.getItem(POST_AUTH_RETURN_KEY) === '1';
    const localReturn = localStorage.getItem(POST_AUTH_RETURN_KEY) === '1';
    const shouldReturn = sessionReturn || localReturn;
    if (!shouldReturn) return;

    const tsRaw = sessionStorage.getItem(POST_AUTH_DRAFT_TS_KEY) || localStorage.getItem(POST_AUTH_DRAFT_TS_KEY) || '0';
    const ageMs = Date.now() - Number(tsRaw || 0);
    if (Number.isFinite(ageMs) && ageMs > 10 * 60 * 1000) {
      sessionStorage.removeItem(POST_AUTH_RETURN_KEY);
      sessionStorage.removeItem(POST_AUTH_DRAFT_KEY);
      sessionStorage.removeItem(POST_AUTH_DRAFT_TS_KEY);
      localStorage.removeItem(POST_AUTH_RETURN_KEY);
      localStorage.removeItem(POST_AUTH_DRAFT_KEY);
      localStorage.removeItem(POST_AUTH_DRAFT_TS_KEY);
      return;
    }

    sessionStorage.removeItem(POST_AUTH_RETURN_KEY);
    localStorage.removeItem(POST_AUTH_RETURN_KEY);
    let draft = null;
    try {
      const draftStr = sessionStorage.getItem(POST_AUTH_DRAFT_KEY) || localStorage.getItem(POST_AUTH_DRAFT_KEY) || '{}';
      draft = JSON.parse(draftStr);
    } catch {
      draft = null;
    }
    sessionStorage.removeItem(POST_AUTH_DRAFT_KEY);
    sessionStorage.removeItem(POST_AUTH_DRAFT_TS_KEY);
    localStorage.removeItem(POST_AUTH_DRAFT_KEY);
    localStorage.removeItem(POST_AUTH_DRAFT_TS_KEY);

    openPostModal();
    const loginRadio = document.querySelector('input[name="postAuthMode"][value="login"]');
    const guestRadio = document.querySelector('input[name="postAuthMode"][value="guest"]');
    if (loginRadio) loginRadio.checked = true;
    if (guestRadio) guestRadio.checked = false;

    if (draft?.fields) {
      Object.entries(draft.fields).forEach(([id, value]) => {
        if (id === 'lectureStars') return;
        const el = document.getElementById(id);
        if (el && typeof value === 'string') el.value = value;
      });
      if (draft.fields.lectureStars) {
        const starRadio = document.querySelector(`input[name="lectureStars"][value="${draft.fields.lectureStars}"]`);
        if (starRadio) starRadio.checked = true;
      }
    }

    const category = draft?.category || document.getElementById('postCategory')?.value || 'lecture';
    const categorySelect = document.getElementById('postCategory');
    if (categorySelect) categorySelect.value = category;
    onCategoryChange(category);
    onPostAuthModeChange();
  }

  async function handleGoogleAuthClick(source = 'header') {
    if (!db?.auth) { alert('ログイン機能を初期化できませんでした'); return; }
    if (googleAuthUser) {
      const { error } = await db.auth.signOut();
      if (error) alert('ログアウトに失敗しました: ' + error.message);
      return;
    }
    if (source === 'post-modal') savePostDraftBeforeAuth();
    const redirectTo = getAuthRedirectUrl();
    const { error } = await db.auth.signInWithOAuth({
      provider: 'google',
      options: { redirectTo }
    });
    if (error) {
      alert('Googleログインに失敗しました: ' + error.message + '\n\n確認事項:\n1) SupabaseでGoogleプロバイダ有効化\n2) Redirect URLに ' + redirectTo + ' を登録\n3) ネット接続とブラウザ拡張のブロック確認\n4) VS Codeプレビューではなく通常ブラウザで開いて実行');
    }
  }

  async function initGoogleAuth() {
    if (!db?.auth) return;
    const { data, error } = await db.auth.getSession();
    if (!error) googleAuthUser = data?.session?.user || null;
    syncNicknameFromGoogle();
    renderGoogleAuthButton();
    restorePostDraftAfterAuthIfNeeded();
    if (document.getElementById('postModal')?.classList.contains('open')) {
      fillPostNickname();
      onPostAuthModeChange();
    }
    db.auth.onAuthStateChange((_event, session) => {
      googleAuthUser = session?.user || null;
      syncNicknameFromGoogle();
      renderGoogleAuthButton();
      restorePostDraftAfterAuthIfNeeded();
      if (document.getElementById('myPageModal')?.classList.contains('open')) loadMyPagePosts();
      if (document.getElementById('postModal')?.classList.contains('open')) {
        fillPostNickname();
        onPostAuthModeChange();
      }
    });
  }

  // デバイスID（本人確認用・自動生成）
  function getDeviceId() {
    let id = localStorage.getItem('waseda_device_id');
    if (!id) {
      id = 'dev_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now().toString(36);
      localStorage.setItem('waseda_device_id', id);
    }
    return id;
  }

  function getOwnerKey(user = googleAuthUser) {
    return user?.id ? `auth:${user.id}` : null;
  }

  async function getResolvedAuthUser() {
    if (googleAuthUser?.id) return googleAuthUser;
    if (!db?.auth) return null;
    try {
      const { data, error } = await db.auth.getSession();
      if (error) return null;
      const sessionUser = data?.session?.user || null;
      if (sessionUser?.id) {
        googleAuthUser = sessionUser;
        syncNicknameFromGoogle();
        renderGoogleAuthButton();
      }
      return sessionUser;
    } catch {
      return null;
    }
  }

  function isOwnerKeyColumnError(error) {
    const msg = `${error?.message || ''} ${error?.details || ''}`;
    return /owner_key/i.test(msg) && /(column|schema|does not exist|unknown)/i.test(msg);
  }

  function createOwnerPayload(base) {
    const ownerKey = getOwnerKey();
    return { ...base, device_id: getDeviceId(), owner_key: ownerKey };
  }

  function isMyContent(item, myIds) {
    if (!item || !googleAuthUser?.id) return false;
    const ownerKey = getOwnerKey();
    return !!(ownerKey && item.owner_key && item.owner_key === ownerKey);
  }

  function syncNicknameFromGoogle() {
    if (!googleAuthUser) return;
    const saved = (localStorage.getItem('waseda_nickname') || '').trim();
    if (saved && saved !== 'ゲスト') return;
    const display = getGoogleDisplayName(googleAuthUser).trim();
    if (!display) return;
    currentUser = display.slice(0, 20);
    localStorage.setItem('waseda_nickname', currentUser);
    updateNicknameBadge();
  }

  function getMyQuestionIds() {
    try { return new Set(JSON.parse(localStorage.getItem('waseda_my_question_ids') || '[]')); }
    catch { return new Set(); }
  }

  function rememberMyQuestionId(id) {
    if (!id) return;
    const set = getMyQuestionIds();
    set.add(String(id));
    const arr = [...set];
    if (arr.length > 300) arr.splice(0, arr.length - 300);
    localStorage.setItem('waseda_my_question_ids', JSON.stringify(arr));
  }

  function getOwnedPostIdsKey(userId) {
    return `waseda_owned_post_ids_${userId}`;
  }

  function getOwnedPostIds(userId) {
    if (!userId) return [];
    try {
      const parsed = JSON.parse(localStorage.getItem(getOwnedPostIdsKey(userId)) || '[]');
      return Array.isArray(parsed) ? parsed : [];
    } catch {
      return [];
    }
  }

  function rememberOwnedPostId(postId, userId) {
    if (!postId || !userId) return;
    const set = new Set(getOwnedPostIds(userId).map(String));
    set.add(String(postId));
    const arr = [...set];
    if (arr.length > 500) arr.splice(0, arr.length - 500);
    localStorage.setItem(getOwnedPostIdsKey(userId), JSON.stringify(arr));
  }

  function removeOwnedPostId(postId, userId) {
    if (!postId || !userId) return;
    const set = new Set(getOwnedPostIds(userId).map(String));
    set.delete(String(postId));
    localStorage.setItem(getOwnedPostIdsKey(userId), JSON.stringify([...set]));
  }

  function canManagePost(post) {
    return isAdmin || isMyContent(post);
  }

  function canManageComment(comment) {
    return isAdmin || isMyContent(comment);
  }

  let allPosts = [];
  let answersCountMap = {};

  // ニックネーム
  function updateNicknameBadge() { renderAccountSummary(); }
  function openNicknameModal() { document.getElementById('nicknameInput').value = currentUser === 'ゲスト' && googleAuthUser ? getGoogleDisplayName(googleAuthUser).slice(0, 20) : currentUser; document.getElementById('nicknameModal').classList.add('open'); }
  function closeNicknameModal() { document.getElementById('nicknameModal').classList.remove('open'); }
  function saveNickname() { const val = document.getElementById('nicknameInput').value.trim(); if (!val) { alert('ニックネームを入力してください'); return; } currentUser = val; localStorage.setItem('waseda_nickname', val); updateNicknameBadge(); checkAdmin(); closeNicknameModal(); }

  function getCategoryLabel(category) {
    const labels = {
      lecture: '授業口コミ',
      circle: 'サークル情報',
      campus: 'キャンパスライフ',
      qa: 'Q&A',
      juken: '受験生掲示板',
      juken_qa: '受験Q&A（勉強）',
      juken_life_qa: '受験Q&A（大学生活）',
      taikenki: '合格体験記'
    };
    return labels[category] || category;
  }

  function openMyPageModal() {
    document.getElementById('myPageModal').classList.add('open');
    loadMyPagePosts();
  }

  function closeMyPageModal() {
    document.getElementById('myPageModal').classList.remove('open');
  }

  async function loadMyPagePosts() {
    const summaryEl = document.getElementById('myPageSummary');
    const listEl = document.getElementById('myPageList');
    if (!summaryEl || !listEl) return;
    const resolvedUser = await getResolvedAuthUser();
    if (!db) {
      summaryEl.textContent = 'DB未接続';
      listEl.innerHTML = '';
      return;
    }
    if (!resolvedUser?.id) {
      summaryEl.textContent = 'マイページはログインユーザー向け機能です';
      listEl.innerHTML = '<div style="text-align:center;color:var(--gray);padding:1.2rem 0;">投稿追跡・削除・一覧表示を使うにはGoogleログインして投稿してください。<br><span style="font-size:0.78rem;">未ログインの投稿は追跡・削除できません。</span></div>';
      return;
    }
    try {
      summaryEl.textContent = '読み込み中...';
      const ownerKey = getOwnerKey(resolvedUser);
      let byOwner = [];
      let byOwnerErr = null;

      ({ data: byOwner, error: byOwnerErr } = await db.from('posts').select('*').eq('owner_key', ownerKey).order('created_at', { ascending: false }).limit(80));

      // 旧データ互換: owner_key に auth: プレフィックスなしで保存されている可能性を考慮
      if (!byOwnerErr && (!byOwner || byOwner.length === 0)) {
        const { data: legacyRows, error: legacyErr } = await db.from('posts').select('*').eq('owner_key', resolvedUser.id).order('created_at', { ascending: false }).limit(80);
        if (!legacyErr && Array.isArray(legacyRows) && legacyRows.length) byOwner = legacyRows;
      }

      if (byOwnerErr && !isOwnerKeyColumnError(byOwnerErr)) throw byOwnerErr;

      // フェイルセーフ: owner_key が使えない環境でも、ログイン投稿時にローカル記録した投稿IDから補完
      const localOwnedIds = getOwnedPostIds(resolvedUser.id);
      if (localOwnedIds.length) {
        const { data: localRows, error: localErr } = await db
          .from('posts')
          .select('*')
          .in('id', localOwnedIds)
          .limit(200);
        if (!localErr && Array.isArray(localRows) && localRows.length) {
          const merged = new Map();
          (byOwner || []).forEach(p => merged.set(String(p.id), p));
          localRows.forEach(p => merged.set(String(p.id), p));
          byOwner = [...merged.values()];
        }
      }

      const rows = (byOwner || []).sort((a, b) => new Date(b.created_at || 0) - new Date(a.created_at || 0));
      summaryEl.textContent = `Google連携追跡 | ニックネーム: @${currentUser} | 投稿数: ${rows.length}`;

      if (!rows.length) {
        listEl.innerHTML = '<div style="text-align:center;color:var(--gray);padding:1.2rem 0;">まだあなたの投稿がありません</div>';
        return;
      }

      listEl.innerHTML = rows.map(p => {
        const isQa = p.category === 'qa' || p.category === 'juken_qa' || p.category === 'juken_life_qa';
        const openFn = isQa ? `openQaDetail(${JSON.stringify(p.id)})` : `openPostDetail(${JSON.stringify(p.id)})`;
        return `<div style="border:1px solid var(--border);border-radius:8px;padding:0.8rem;margin-bottom:0.7rem;">
          <div style="display:flex;justify-content:space-between;gap:0.6rem;align-items:center;flex-wrap:wrap;">
            <span style="font-size:0.72rem;color:var(--gray);background:var(--crimson-pale);padding:2px 8px;border-radius:999px;">${escHtml(getCategoryLabel(p.category))}</span>
            <span style="font-size:0.73rem;color:var(--gray-light);">${formatTime(p.created_at)}</span>
          </div>
          <div style="margin-top:0.4rem;font-size:0.9rem;font-weight:700;color:var(--dark);">${escHtml(p.title || '(タイトルなし)')}</div>
          <div style="margin-top:0.2rem;font-size:0.8rem;color:var(--gray);">${escHtml((p.body || '').slice(0, 110))}</div>
          <div style="margin-top:0.5rem;display:flex;justify-content:space-between;align-items:center;">
            <span style="font-size:0.73rem;color:var(--gray-light);">❤️ ${p.likes || 0} / 💬 ${p.comments || 0}</span>
            <button class="btn-submit" style="margin-top:0;padding:6px 10px;font-size:0.74rem;" onclick="closeMyPageModal();${openFn}">詳細を見る</button>
          </div>
        </div>`;
      }).join('');
    } catch (e) {
      console.error(e);
      summaryEl.textContent = '読み込みに失敗しました';
      listEl.innerHTML = '';
    }
  }

  // 投稿取得
  async function loadPosts() {
    const container = document.getElementById('posts-container');
    container.innerHTML = '<div class="loading">読み込み中...</div>';
    try {
      let query = db.from('posts').select('*');
      if (currentTab !== 'all') query = query.eq('category', currentTab);
      if (currentFaculty !== 'all') query = query.eq('faculty', currentFaculty);
      if (searchQuery) query = query.or(`title.ilike.%${searchQuery}%,body.ilike.%${searchQuery}%`);

      // ソート処理
      if (currentSort === 'popular') {
        // 24時間以内の投稿をいいね数順で取得
        const since24h = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString();
        const { data: recentData, error: recentErr } = await query.gte('created_at', since24h).order('likes', { ascending: false });
        if (!recentErr && recentData && recentData.length > 0) {
          allPosts = recentData;
        } else {
          // 24時間以内に投稿がなければ全期間のいいね数順にフォールバック
          let fbQuery = db.from('posts').select('*');
          if (currentTab !== 'all') fbQuery = fbQuery.eq('category', currentTab);
          if (currentFaculty !== 'all') fbQuery = fbQuery.eq('faculty', currentFaculty);
          if (searchQuery) fbQuery = fbQuery.or(`title.ilike.%${searchQuery}%,body.ilike.%${searchQuery}%`);
          const { data: fbData, error: fbErr } = await fbQuery.order('likes', { ascending: false });
          if (fbErr) throw fbErr;
          allPosts = fbData || [];
        }
      } else {
        query = query.order('created_at', { ascending: false });
        const { data, error } = await query;
        if (error) throw error;
        allPosts = data || [];
      }

      // answers 件数を別テーブルから取得
      answersCountMap = {};
      try {
        const ids = allPosts.map(p => p.id).filter(Boolean);
        if (ids.length && db) {
          const { data: ansRows, error: ansErr } = await db.from('answers').select('post_id').in('post_id', ids);
          if (!ansErr && Array.isArray(ansRows)) ansRows.forEach(r => { answersCountMap[r.post_id] = (answersCountMap[r.post_id] || 0) + 1; });
        }
      } catch (e) { console.warn('answers count fetch failed', e); }

      renderPosts(allPosts);
      if (currentTab === 'all') loadTrendingPosts(currentTrendCategory);
    } catch (err) {
      console.error(err);
      container.innerHTML = '<div class="empty-tab"><div class="empty-icon">⚠️</div><div class="empty-title">データ読み込みエラー</div><div class="empty-text">申し訳ございません。データの取得に失敗しました。</div></div>';
    }
  }


  // トレンドポスト取得と描画
  async function loadTrendingPosts(category = currentTrendCategory) {
    try {
      if (!db) throw new Error('Supabase client not initialized');
      
      const container = document.getElementById('trendContainer');
      if (!container) return;

      // Calculate timestamp for 24 hours ago
      const now = new Date();
      const twentyFourHoursAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000).toISOString();

      // First try: get top 5 posts within 24h in the given category
      let { data: postsData, error: err1 } = await db.from('posts')
        .select('*')
        .eq('category', category)
        .gte('created_at', twentyFourHoursAgo)
        .order('likes', { ascending: false })
        .limit(5);

      // Fallback: most recent 5 posts in that category
      if (err1 || !postsData || postsData.length === 0) {
        const { data: recentData, error: err2 } = await db.from('posts')
          .select('*')
          .eq('category', category)
          .order('created_at', { ascending: false })
          .limit(5);
        if (err2) throw err2;
        postsData = recentData || [];
      }

      const posts = Array.isArray(postsData) ? postsData : [];

      if (!posts || posts.length === 0) {
        container.innerHTML = '<div style="color: var(--gray); font-size: 0.9rem; text-align: center; padding: 1rem;">投稿がまだありません</div>';
        return;
      }

      container.innerHTML = posts.map((p, idx) => {
        const title = escHtml(p.title);
        return `<div class="trend-item" onclick="scrollToPost(${JSON.stringify(p.id)})">
          <span class="trend-num">${idx + 1}</span>
          <div class="trend-item-content">
            <span class="trend-text">${title}</span>
            <span class="trend-likes">❤️ ${p.likes || 0}</span>
          </div>
        </div>`;
      }).join('');
    } catch (e) {
      console.error('loadTrendingPosts error:', e);
      const container = document.getElementById('trendContainer');
      if (container) {
        container.innerHTML = '<div style="color: var(--gray); font-size: 0.9rem; text-align: center; padding: 1rem;">投稿を読み込んでいます...</div>';
      }
    }
  }

  function switchTrendCategory(cat) {
    currentTrendCategory = cat;
    document.querySelectorAll('.trend-tab').forEach(t => {
      t.classList.toggle('active', t.getAttribute('data-cat') === cat);
    });
    const c = document.getElementById('trendContainer');
    if (c) c.innerHTML = '<div class="trend-loading">読み込み中...</div>';
    loadTrendingPosts(cat);
  }

  function setupTrendTabs() {
    document.querySelectorAll('.trend-tab').forEach(btn => {
      btn.addEventListener('click', () => switchTrendCategory(btn.getAttribute('data-cat')));
    });
  }

  // トレンドポストにスクロール・ハイライト
  function scrollToPost(postId) {
    const postElement = document.getElementById(`post-${postId}`);
    if (!postElement) {
      console.warn('Post not found:', postId);
      return;
    }

    // スクロール
    postElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

    // ハイライト効果
    postElement.style.backgroundColor = 'rgba(200, 169, 81, 0.15)';
    postElement.style.transition = 'background-color 0.3s ease';
    setTimeout(() => {
      postElement.style.backgroundColor = '';
    }, 2000);
  }

  function formatTime(ts) { const diff = Math.floor((Date.now() - new Date(ts)) / 1000); if (diff < 60) return 'たった今'; if (diff < 3600) return Math.floor(diff/60) + '分前'; if (diff < 86400) return Math.floor(diff/3600) + '時間前'; return Math.floor(diff/86400) + '日前'; }

  function renderPosts(posts) {
    const container = document.getElementById('posts-container');
    if (!posts.length) { container.innerHTML = '<div class="empty-tab"><div class="empty-icon">📭</div><div class="empty-title">まだ投稿がありません</div><div class="empty-text">このカテゴリで最初の投稿者になりませんか？<br/>あなたの経験やエピソードをシェアしてください。</div><button class="empty-action" onclick="openPostModalWithCategory()">+ 投稿を作成</button></div>'; return; }
    const catMap = { lecture:['cat-lecture','📚 授業口コミ'], circle:['cat-circle','🎯 サークル'], campus:['cat-campus','🏫 キャンパスライフ'], qa:['cat-qa','❓ Q&A'], job:['cat-job','💼 求人'] };

    // Sort: pinned first, then by created_at
    const sorted = posts.sort((a, b) => {
      if (a.pinned && !b.pinned) return -1;
      if (!a.pinned && b.pinned) return 1;
      return 0;
    });

    const likedSet = getLikedPosts();
    container.innerHTML = sorted.map(p => {
      const [cls, label] = catMap[p.category] || ['cat-campus','その他'];
      const fTag = p.faculty ? `<span class="faculty-tag">${FACULTIES[p.faculty]||p.faculty}</span>` : '';
      const timeStr = formatTime(p.created_at);
      const deleteBtn = canManagePost(p) ? `<span class="post-action delete-btn" onclick='event.stopPropagation(); deletePost(${JSON.stringify(p.id)})'>🗑️</span>` : '';
      const likedCls = likedSet.has(String(p.id)) ? ' liked' : '';
      const pinnedClass = p.pinned ? 'post-pinned' : '';
      const prBadge = (p.category === 'job' && p.is_pr) ? '<span class="pr-badge">PR</span>' : '';

      if (p.category === 'qa') {
        const ansCount = answersCountMap[p.id] || 0;
        const sc = p.solved ? 'answered' : 'open';
        const sl = p.solved ? '✅ 解決済み' : '🔓 回答募集中';
        return `<div class="qa-card ${pinnedClass}" id="post-${p.id}" onclick='openQaDetail(${JSON.stringify(p.id)})'>
          <div class="post-meta"><span class="category-tag cat-qa">❓ Q&amp;A</span><span class="qa-status ${sc}">${sl}</span>${fTag}<span class="post-time">${timeStr}</span></div>
          <div class="post-title">${escHtml(p.title)}</div>
          <div class="post-body">${escHtml(p.body)}</div>
          <div class="post-footer">
            <span class="post-action">💬 回答 ${ansCount}件</span>
            <span class="post-action${likedCls}" onclick='event.stopPropagation(); likePost(${JSON.stringify(p.id)}, this)'>❤️ <span class="like-count">${p.likes||0}</span></span>
            <span class="post-action">@${escHtml(p.author)}</span>
            ${deleteBtn}
            <span class="report-btn" onclick='event.stopPropagation(); openReportModal(${JSON.stringify(p.id)}, null)'>🚩 通報</span>
          </div></div>`;
      }

      // Category-specific metadata
      let extraMeta = '';
      if (p.category === 'lecture') {
        const stars = p.stars ? '⭐'.repeat(p.stars) : '';
        const teacher = p.lecture_teacher ? `<span style="font-size:0.8rem;color:var(--gray);">👨‍🏫 ${escHtml(p.lecture_teacher)}</span>` : '';
        let extraBar = '';
        if (p.extra_fields) {
          try {
            const ef = typeof p.extra_fields === 'string' ? JSON.parse(p.extra_fields) : p.extra_fields;
            const parts = [];
            if (ef.semester) parts.push(ef.semester);
            if (ef.schedule) parts.push(ef.schedule);
            if (ef.day) parts.push(`${ef.day}曜`);
            if (ef.period) parts.push(ef.period);
            if (ef.exam_type) parts.push(ef.exam_type);
            if (ef.attendance) parts.push(`出席${ef.attendance}`);
            if (ef.credits) parts.push(`単位:${ef.credits}`);
            if (parts.length) extraBar = `<div class="extra-fields-bar">${escHtml(parts.join(' | '))}</div>`;
          } catch(e) {}
        }
        extraMeta = `${teacher}${stars}${extraBar}`;
      } else if (p.category === 'circle') {
        const typeMap = { sports:'運動系', culture:'文化系', other:'その他' };
        const type = p.circle_type ? `<span style="font-size:0.8rem;background:#f0f0f0;padding:2px 8px;border-radius:4px;color:#555;">${typeMap[p.circle_type]||p.circle_type}</span>` : '';
        extraMeta = type;
      } else if (p.category === 'campus') {
        const locationMap = { waseda:'早稲田', nishi:'西早稲田', toyama:'戸山', tokorozawa:'所沢', other:'その他' };
        const loc = p.campus_location ? `<span style="font-size:0.8rem;color:var(--gray);">📍 ${locationMap[p.campus_location]||p.campus_location}</span>` : '';
        const dt = p.campus_datetime ? `<span style="font-size:0.8rem;color:var(--gray);">🕐 ${escHtml(p.campus_datetime)}</span>` : '';
        extraMeta = `${loc}${dt}`;
      }

      const postCardClass = p.category === 'job' ? 'post-card job' : `post-card ${p.category}`;
      return `<div class="${postCardClass} ${pinnedClass}" id="post-${p.id}" onclick='openPostDetail(${JSON.stringify(p.id)})'>
        <div class="post-meta"><span class="category-tag ${cls}">${label}${prBadge}</span>${fTag}<span class="author">@${escHtml(p.author)}</span><span class="post-time">${timeStr}</span></div>
        ${extraMeta ? `<div class="extra-meta">${extraMeta}</div>` : ''}
        <div class="post-title">${escHtml(p.title)}</div>
        <div class="post-body">${escHtml(p.body)}</div>
        <div class="post-footer">
          <span class="post-action${likedCls}" onclick='event.stopPropagation(); likePost(${JSON.stringify(p.id)}, this)'>❤️ <span class="like-count">${p.likes||0}</span></span>
          <span class="post-action">💬 ${p.comments||0}</span>
          ${deleteBtn}
          <span class="report-btn" onclick='event.stopPropagation(); openReportModal(${JSON.stringify(p.id)}, null)'>🚩 通報</span>
        </div></div>`;
    }).join('');
  }

  function escHtml(str) { return String(str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

  // いいね（1人1回、ローカルストレージで管理）
  function getLikedPosts() {
    try { return new Set(JSON.parse(localStorage.getItem('waseda_liked') || '[]')); }
    catch { return new Set(); }
  }
  function setPostLiked(id, liked) {
    const s = getLikedPosts();
    liked ? s.add(String(id)) : s.delete(String(id));
    localStorage.setItem('waseda_liked', JSON.stringify([...s]));
  }

  async function likePost(id, el) {
    try {
      if (!db) throw new Error('Supabase client not initialized');
      const alreadyLiked = getLikedPosts().has(String(id));
      const countEl = el && el.querySelector ? el.querySelector('.like-count') : null;
      const cur = countEl ? parseInt(countEl.textContent || '0') : 0;
      const newCount = alreadyLiked ? Math.max(0, cur - 1) : cur + 1;
      // 楽観的UI更新
      if (countEl) countEl.textContent = newCount;
      el.classList.toggle('liked', !alreadyLiked);
      setPostLiked(id, !alreadyLiked);
      const { error } = await db.from('posts').update({ likes: newCount }).eq('id', id);
      if (error) {
        // 失敗時は元に戻す
        if (countEl) countEl.textContent = cur;
        el.classList.toggle('liked', alreadyLiked);
        setPostLiked(id, alreadyLiked);
        console.error('Like update error', error);
      }
    } catch (e) { console.error(e); }
  }

  // 投稿削除
  async function deletePost(postId) {
    if (!confirm('この投稿を削除してもよろしいですか？')) return;
    try {
      if (!db) throw new Error('Supabase client not initialized');
      if (!isAdmin) {
        const { data: targetPost, error: getError } = await db
          .from('posts')
          .select('id, device_id, owner_key, author')
          .eq('id', postId)
          .single();
        if (getError) throw getError;
        if (!canManagePost(targetPost)) throw new Error('削除権限がありません');
      }
      const { error } = await db.from('posts').delete().eq('id', postId);
      if (error) throw error;
      if (googleAuthUser?.id) removeOwnedPostId(postId, googleAuthUser.id);
      // update local cache and UI
      allPosts = allPosts.filter(p => p.id !== postId);
      loadPosts();
      closePostDetailModal();
      closeQaModal();
    } catch (e) { console.error(e); alert('投稿の削除に失敗しました'); }
  }

  // コメント削除
  async function deleteComment(commentId, postId) {
    if (!confirm('このコメントを削除してもよろしいですか？')) return;
    try {
      if (!db) throw new Error('Supabase client not initialized');
      if (!isAdmin) {
        const { data: targetComment, error: getError } = await db
          .from('comments')
          .select('id, device_id, owner_key, author')
          .eq('id', commentId)
          .single();
        if (getError) throw getError;
        if (!canManageComment(targetComment)) throw new Error('削除権限がありません');
      }
      const { error } = await db.from('comments').delete().eq('id', commentId);
      if (error) throw error;
      // decrement count on post
      const post = allPosts.find(p => p.id === postId);
      if (post) {
        const newCount = (post.comments||0) - 1;
        await db.from('posts').update({ comments: newCount }).eq('id', postId);
        post.comments = newCount;
        // update list view as well
        renderPosts(allPosts);
      }
      await openPostDetail(postId);
    } catch (e) { console.error(e); alert('コメントの削除に失敗しました'); }
  }

  // ===== ADMIN SYSTEM =====
  let isAdmin = false;

  async function checkAdmin() {
    try {
      if (!db) { console.warn('[Admin] DB not initialized'); return; }
      const { data, error } = await db.from('admins').select('nickname').eq('nickname', currentUser).limit(1);
      if (error) { console.error('[Admin] checkAdmin error:', error); return; }
      if (data && data.length) {
        isAdmin = true;
        const btn = document.getElementById('adminBtn');
        if (btn) {
          btn.style.display = 'inline-block';
          console.log('[Admin] Admin privileges granted for:', currentUser);
        }
      }
    } catch (e) { console.error('[Admin] checkAdmin exception:', e); }
  }

  // Tab switching for admin modal
  function switchAdminTab(tab) {
    document.querySelectorAll('.admin-tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.admin-tab-content').forEach(content => { content.classList.remove('active'); content.style.display = 'none'; });
    event.target.classList.add('active');
    const contentEl = document.getElementById('tab-' + tab);
    if (contentEl) { contentEl.classList.add('active'); contentEl.style.display = 'block'; }
    if (tab === 'posts') renderAdminPostList();
    if (tab === 'jobs') renderAdminJobList();
    if (tab === 'reports') loadAdminReports();
  }

  // ===== REPORT SYSTEM =====
  let reportTargetPostId = null;
  let reportTargetCommentId = null;

  function openReportModal(postId, commentId) {
    reportTargetPostId = postId;
    reportTargetCommentId = commentId;
    document.querySelectorAll('input[name="reportReason"]').forEach(r => r.checked = false);
    document.getElementById('reportModal').classList.add('open');
  }
  function closeReportModal() {
    document.getElementById('reportModal').classList.remove('open');
    reportTargetPostId = null;
    reportTargetCommentId = null;
  }

  async function submitReport() {
    const reason = document.querySelector('input[name="reportReason"]:checked')?.value;
    if (!reason) { alert('通報理由を選択してください'); return; }
    try {
      if (!db) throw new Error('Supabase not initialized');
      const report = {
        post_id: reportTargetPostId,
        comment_id: reportTargetCommentId,
        reason,
        reporter_nickname: currentUser,
        resolved: false
      };
      const { error } = await db.from('reports').insert([report]);
      if (error) throw error;
      closeReportModal();
      alert('通報を受け付けました。ご協力ありがとうございます。');
    } catch (e) { console.error(e); alert('通報の送信に失敗しました'); }
  }

  async function loadAdminReports() {
    const list = document.getElementById('adminReportList');
    if (!list) return;
    list.innerHTML = '<div style="color:#aaa;font-size:0.9rem;">読み込み中...</div>';
    try {
      const { data, error } = await db.from('reports').select('*').eq('resolved', false).order('created_at', { ascending: false });
      if (error) throw error;
      if (!data || !data.length) { list.innerHTML = '<div style="color:#aaa;font-size:0.9rem;text-align:center;padding:1rem;">未対応の通報はありません</div>'; return; }

      // 通報された投稿・コメントの内容を一括取得
      const postIds = [...new Set(data.filter(r => r.post_id).map(r => r.post_id))];
      const commentIds = [...new Set(data.filter(r => r.comment_id).map(r => r.comment_id))];
      let postsMap = {}, commentsMap = {};
      if (postIds.length) {
        const { data: posts } = await db.from('posts').select('id, title, author, body').in('id', postIds);
        if (posts) posts.forEach(p => { postsMap[p.id] = p; });
      }
      if (commentIds.length) {
        const { data: comments } = await db.from('comments').select('id, text, author').in('id', commentIds);
        if (comments) comments.forEach(c => { commentsMap[c.id] = c; });
      }

      list.innerHTML = data.map(r => {
        const post = r.post_id ? postsMap[r.post_id] : null;
        const comment = r.comment_id ? commentsMap[r.comment_id] : null;
        const contentHtml = post
          ? `<div style="margin-top:8px;padding:8px 12px;background:white;border-radius:6px;border:1px solid #eee;">
               <div style="font-size:0.8rem;font-weight:700;color:var(--dark);margin-bottom:2px;">${escHtml(post.title)}</div>
               <div style="font-size:0.75rem;color:#888;">@${escHtml(post.author)}</div>
               <div style="font-size:0.78rem;color:#666;margin-top:4px;line-height:1.5;">${escHtml((post.body||'').slice(0,120))}${(post.body||'').length>120?'…':''}</div>
             </div>`
          : comment
          ? `<div style="margin-top:8px;padding:8px 12px;background:white;border-radius:6px;border:1px solid #eee;">
               <div style="font-size:0.75rem;color:#888;margin-bottom:2px;">コメント by @${escHtml(comment.author)}</div>
               <div style="font-size:0.78rem;color:#666;line-height:1.5;">${escHtml((comment.text||'').slice(0,120))}${(comment.text||'').length>120?'…':''}</div>
             </div>`
          : '';
        return `
        <div style="padding:0.9rem;background:#fff9f9;border:1px solid #f5c6cb;border-radius:8px;margin-bottom:0.8rem;">
          <div style="display:flex;justify-content:space-between;align-items:start;gap:8px;flex-wrap:wrap;">
            <div style="flex:1;min-width:0;">
              <div style="font-size:0.82rem;font-weight:700;color:#c0392b;margin-bottom:4px;">⚠️ ${escHtml(r.reason)}</div>
              <div style="font-size:0.78rem;color:#666;">通報者: @${escHtml(r.reporter_nickname)} · ${formatTime(r.created_at)}</div>
              ${contentHtml}
            </div>
            <div style="display:flex;gap:6px;flex-shrink:0;flex-direction:column;align-items:flex-end;">
              <button style="padding:4px 10px;background:#4caf50;color:white;border:none;border-radius:4px;cursor:pointer;font-size:0.78rem;white-space:nowrap;" onclick="markReportResolved(${JSON.stringify(r.id)})">✓ 確認済み</button>
              ${r.post_id ? `<button style="padding:4px 10px;background:#e53935;color:white;border:none;border-radius:4px;cursor:pointer;font-size:0.78rem;white-space:nowrap;" onclick="deleteReportedPost(${JSON.stringify(r.post_id)}, ${JSON.stringify(r.id)})">🗑️ 投稿を削除</button>` : ''}
            </div>
          </div>
        </div>`;
      }).join('');
    } catch (e) { console.error(e); list.innerHTML = '<div style="color:#e53935;font-size:0.9rem;">読み込みに失敗しました</div>'; }
  }

  async function markReportResolved(reportId) {
    try {
      const { error } = await db.from('reports').update({ resolved: true }).eq('id', reportId);
      if (error) throw error;
      loadAdminReports();
    } catch (e) { console.error(e); alert('更新に失敗しました'); }
  }

  async function deleteReportedPost(postId, reportId) {
    if (!confirm('この投稿を削除しますか？')) return;
    try {
      await db.from('posts').delete().eq('id', postId);
      await db.from('reports').update({ resolved: true }).eq('id', reportId);
      allPosts = allPosts.filter(p => p.id !== postId);
      renderPosts(allPosts);
      loadAdminReports();
    } catch (e) { console.error(e); alert('削除に失敗しました'); }
  }

  // ANNOUNCEMENTS
  async function loadAnnouncements() {
    try {
      if (!db) { console.warn('[Announcements] DB not initialized'); return []; }
      const { data, error } = await db.from('announcements').select('*').eq('active', true).order('created_at', { ascending: false });
      if (error) { console.error('[Announcements] loadAnnouncements error:', error); return []; }
      return Array.isArray(data) ? data : [];
    } catch (e) { console.error('[Announcements] loadAnnouncements exception:', e); return []; }
  }

  async function loadAllAnnouncements() {
    try {
      if (!db) { console.warn('[Announcements] DB not initialized'); return []; }
      const { data, error } = await db.from('announcements').select('*').order('created_at', { ascending: false });
      if (error) { console.error('[Announcements] loadAllAnnouncements error:', error); return []; }
      return Array.isArray(data) ? data : [];
    } catch (e) { console.error('[Announcements] loadAllAnnouncements exception:', e); return []; }
  }

  async function refreshAnnouncements() {
    const ann = await loadAnnouncements();
    const banner = document.getElementById('announcementBanner');
    if (banner) {
      if (ann && ann.length) {
        const latest = ann[0];
        document.getElementById('announcementTitle').textContent = escHtml(latest.title);
        document.getElementById('announcementBody').textContent = escHtml(latest.body);
        banner.style.display = 'block';
        console.log('[Announcements] Banner displayed:', latest.title);
      } else {
        banner.style.display = 'none';
        console.log('[Announcements] No active announcements');
      }
    }
  }

  function closeAnnouncementBanner() {
    const banner = document.getElementById('announcementBanner');
    if (banner) {
      banner.style.display = 'none';
      console.log('[Announcements] Banner closed by user');
    }
  }

  async function submitAnnouncement() {
    const title = document.getElementById('announceTitle')?.value?.trim();
    const body = document.getElementById('announceBody')?.value?.trim();
    const active = document.getElementById('announceActive')?.checked ?? true;
    if (!title || !body) { alert('タイトルと内容を入力してください'); return; }
    try {
      if (!db) throw new Error('Supabase not initialized');
      const { error } = await db.from('announcements').insert([{ title, body, active, author: currentUser }]);
      if (error) {
        console.error('[Announcements] submitAnnouncement DB error:', error);
        alert('お知らせ投稿 失敗: ' + error.message);
        return;
      }
      console.log('[Announcements] Posted successfully');
      document.getElementById('announceTitle').value = '';
      document.getElementById('announceBody').value = '';
      document.getElementById('announceActive').checked = true;
      await refreshAnnouncements();
      renderAdminAnnouncementList();
    } catch (e) { console.error('[Announcements] submitAnnouncement exception:', e); alert('お知らせ投稿 失敗: ' + e.message); }
  }

  async function deleteAnnouncement(id) {
    if (!confirm('このお知らせを削除しますか？')) return;
    try {
      if (!db) throw new Error('Supabase not initialized');
      const { error } = await db.from('announcements').delete().eq('id', id);
      if (error) { console.error('[Announcements] deleteAnnouncement error:', error); throw error; }
      console.log('[Announcements] Deleted announcement id:', id);
      await refreshAnnouncements();
      renderAdminAnnouncementList();
    } catch (e) { console.error('[Announcements] deleteAnnouncement exception:', e); alert('削除失敗: ' + e.message); }
  }

  async function toggleAnnouncementActive(id, currentActive) {
    try {
      if (!db) throw new Error('Supabase not initialized');
      const { error } = await db.from('announcements').update({ active: !currentActive }).eq('id', id);
      if (error) { console.error('[Announcements] toggleAnnouncementActive error:', error); throw error; }
      console.log('[Announcements] Toggled announcement id:', id);
      await refreshAnnouncements();
      renderAdminAnnouncementList();
    } catch (e) { console.error('[Announcements] toggleAnnouncementActive exception:', e); alert('変更失敗: ' + e.message); }
  }

  async function renderAdminAnnouncementList() {
    const list = document.getElementById('announcementList');
    if (!list) return;
    const ann = await loadAllAnnouncements();
    if (!ann.length) {
      list.innerHTML = '<p style="color:#999;そんなかいお知らせはありません。</p>';
      return;
    }
    list.innerHTML = ann.map(a => `<div style="padding:0.8rem;background:#f9f9f9;border-radius:6px;margin-bottom:0.8rem;font-size:0.9rem;">
      <div style="display:flex;justify-content:space-between;align-items:start;gap:8px;">
        <div style="flex:1;">
          <strong>${escHtml(a.title)}</strong>
          <div style="color:#666;font-size:0.85rem;margin-top:4px;">${escHtml(a.body)}</div>
          <div style="color:#999;font-size:0.8rem;margin-top:4px;">閉📋 ${new Date(a.created_at).toLocaleString('ja-JP')}</div>
        </div>
        <div style="display:flex;gap:6px;">
          <button style="padding:4px 8px;background:${a.active?'#4caf50':'#ccc'};color:white;border:none;border-radius:4px;cursor:pointer;font-size:0.8rem;" onclick="toggleAnnouncementActive(${JSON.stringify(a.id)}, ${a.active})">${a.active?'⚠':'OFF'}</button>
          <span class="delete-btn" style="cursor:pointer;padding:4px 8px;" onclick="deleteAnnouncement(${JSON.stringify(a.id)})">🗑️</span>
        </div>
      </div>
    </div>`).join('');
  }

  // JOBS & PR
  async function submitJob() {
    const company = document.getElementById('jobCompany')?.value?.trim();
    const title = document.getElementById('jobTitle')?.value?.trim();
    const desc = document.getElementById('jobDesc')?.value?.trim();
    const isPR = document.getElementById('jobPR')?.checked ?? true;
    if (!company || !title || !desc) { alert('すべてのフィールドを入力してください'); return; }
    try {
      if (!db) throw new Error('Supabase not initialized');
      const body = `${company} / ${desc}`;
      const newPost = { category: 'job', author: currentUser, title, body, likes: 0, comments: 0, is_pr: isPR };
      const { error } = await db.from('posts').insert([newPost]);
      if (error) { console.error('[Jobs] submitJob DB error:', error); throw error; }
      console.log('[Jobs] Job posted successfully');
      document.getElementById('jobCompany').value = '';
      document.getElementById('jobTitle').value = '';
      document.getElementById('jobDesc').value = '';
      document.getElementById('jobPR').checked = true;
      allPosts = [];
      loadPosts();
    } catch (e) { console.error('[Jobs] submitJob exception:', e); alert('求人投稿 失敗: ' + e.message); }
  }

  async function renderAdminJobList() {
    const list = document.getElementById('jobPostList');
    if (!list) return;
    const jobs = allPosts.filter(p => p.category === 'job');
    if (!jobs.length) {
      list.innerHTML = '<p style="color:#999;">投稿済み求人はありません。</p>';
      return;
    }
    list.innerHTML = jobs.map(j => `<div style="padding:0.8rem;background:#f9f9f9;border-radius:6px;margin-bottom:0.8rem;">
      <div style="display:flex;justify-content:space-between;align-items:start;">
        <div><strong>${escHtml(j.title)}</strong></div>
        <span class="delete-btn" style="cursor:pointer;" onclick="deletePost(${JSON.stringify(j.id)})">🗑️</span>
      </div>
      <div style="color:#666;font-size:0.85rem;margin-top:4px;margin-bottom:4px;">${escHtml(j.body)}</div>
      <div style="color:#999;font-size:0.8rem;">❤️ ${j.likes||0}</div>
    </div>`).join('');
  }

  // POST MANAGEMENT
  async function renderAdminPostList() {
    const list = document.getElementById('adminPostList');
    if (!list) return;
    if (!allPosts.length) {
      list.innerHTML = '<p style="color:#999;">投稿がありません。</p>';
      return;
    }
    list.innerHTML = allPosts.map(p => `<div style="padding:0.8rem;background:#f9f9f9;border-radius:6px;margin-bottom:0.8rem;border-left:4px solid ${p.pinned?'#c8a951':'#ddd'};">
      <div style="display:flex;justify-content:space-between;align-items:start;">
        <div style="flex:1;">
          ${p.pinned?'<span style="color:#c8a951;font-weight:700;">📌 PINNED</span><br>':''}
          <strong>${escHtml(p.title)}</strong>
          <div style="color:#666;font-size:0.85rem;margin-top:4px;">@${escHtml(p.author)}</div>
        </div>
        <div style="display:flex;gap:6px;">
          <button style="padding:4px 8px;background:${p.pinned?'#c8a951':'#999'};color:white;border:none;border-radius:4px;cursor:pointer;font-size:0.8rem;" onclick="togglePin(${JSON.stringify(p.id)}, ${p.pinned??false})">📌</button>
          <span class="delete-btn" style="cursor:pointer;padding:4px 8px;" onclick="deletePost(${JSON.stringify(p.id)})">🗑️</span>
        </div>
      </div>
    </div>`).join('');
  }

  async function togglePin(postId, currentPin) {
    try {
      if (!db) throw new Error('Supabase not initialized');
      const { error } = await db.from('posts').update({ pinned: !currentPin }).eq('id', postId);
      if (error) { console.error('[Posts] togglePin error:', error); throw error; }
      const post = allPosts.find(p => p.id === postId);
      if (post) post.pinned = !currentPin;
      loadPosts();
      renderAdminPostList();
      console.log('[Posts] Toggled pin: ' + postId);
    } catch (e) { console.error('[Posts] togglePin exception:', e); alert('ピン変更 失敗: ' + e.message); }
  }

  // ADMIN MODAL
  function openAdminModal() {
    if (!isAdmin) { console.warn('[Admin] Not admin'); return; }
    document.getElementById('adminModal').classList.add('open');
    renderAdminAnnouncementList();
  }

  function closeAdminModal() { document.getElementById('adminModal').classList.remove('open'); }


  // 検索
  function doSearch() { searchQuery = document.getElementById('searchInput').value.trim(); const banner = document.getElementById('search-banner'); if (searchQuery) { banner.classList.add('show'); document.getElementById('search-banner-text').textContent = `「${searchQuery}」の検索結果`; } else { banner.classList.remove('show'); } loadPosts(); }
  function clearSearch() { searchQuery = ''; document.getElementById('searchInput').value = ''; document.getElementById('search-banner').classList.remove('show'); loadPosts(); }

  // ソート更新
  function updateSort() { currentSort = document.getElementById('sortSelect').value || 'newest'; loadPosts(); }

  // タブ・学部切替
  function switchTab(tab, el) {
    currentTab = tab;
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    const mainArea = document.querySelector('.main');
    const jukenPanel = document.getElementById('juken-panel');
    if (tab === 'juken') {
      if (mainArea) mainArea.style.display = 'none';
      jukenPanel.style.display = 'block';
      switchJukenSubTab('qa-study', jukenPanel.querySelector('.juken-menu-card'));
    } else {
      if (mainArea) mainArea.style.display = '';
      jukenPanel.style.display = 'none';
      const titles = { all:'新着投稿', lecture:'授業口コミ', circle:'サークル情報', campus:'キャンパスライフ', qa:'Q&A' };
      document.getElementById('section-title').textContent = titles[tab] || tab;
      loadPosts();
      const sidebar = document.querySelector('.sidebar');
      if (sidebar) sidebar.style.display = (tab === 'all' ? 'flex' : 'none');
    }
  }
  function selectFaculty(f, el) { currentFaculty = f; document.querySelectorAll('.faculty-chip').forEach(c => c.classList.remove('active')); el.classList.add('active'); loadPosts(); }

  // 投稿モーダル
  function openPostModal() { 
    document.getElementById('postModal').classList.add('open'); 
    resetPostForm();
  }

  function getPostAuthMode() {
    if (googleAuthUser) return 'login';
    const checked = document.querySelector('input[name="postAuthMode"]:checked');
    if (checked?.value) return checked.value;
    return 'guest';
  }

  function onPostAuthModeChange() {
    const mode = getPostAuthMode();
    const authLabel = document.getElementById('postAuthLabel');
    const options = document.getElementById('postAuthOptions');
    const actions = document.getElementById('postAuthActions');
    const note = document.getElementById('postAuthNote');
    const loginRadio = document.querySelector('input[name="postAuthMode"][value="login"]');
    const guestRadio = document.querySelector('input[name="postAuthMode"][value="guest"]');
    if (!actions || !note || !authLabel || !options) return;

    if (googleAuthUser) {
      if (loginRadio) loginRadio.checked = true;
      if (guestRadio) guestRadio.checked = false;
      authLabel.innerHTML = '投稿方法（自動）';
      options.style.display = 'none';
      actions.style.display = 'none';
      note.textContent = 'ログイン投稿中: 以後の投稿は自動で追跡・削除・マイページ対応になります。';
      return;
    }

    authLabel.innerHTML = '投稿方法 <span style="color:#e74c3c;">*</span>';
    options.style.display = 'flex';
    if (mode === 'login') {
      actions.style.display = googleAuthUser ? 'none' : 'flex';
      note.textContent = googleAuthUser
        ? 'ログイン投稿: あなたの投稿は追跡・削除でき、マイページに表示されます。'
        : 'ログイン投稿を選択中です。下のボタンからログインすると、この投稿画面に戻って続きから投稿できます。';
    } else {
      actions.style.display = 'none';
      note.textContent = 'ゲスト投稿: ニックネーム投稿はできますが、追跡・削除・マイページ表示はできません。';
    }
  }

  function fillPostNickname() {
    const input = document.getElementById('postNickname');
    if (!input) return;
    const base = currentUser === 'ゲスト' && googleAuthUser ? getGoogleDisplayName(googleAuthUser).slice(0, 20) : currentUser;
    input.value = base && base !== 'ゲスト' ? base : '';
  }

  function resetPostForm() {
    const loginRadio = document.querySelector('input[name="postAuthMode"][value="login"]');
    const guestRadio = document.querySelector('input[name="postAuthMode"][value="guest"]');
    if (googleAuthUser) {
      if (loginRadio) loginRadio.checked = true;
      if (guestRadio) guestRadio.checked = false;
    } else {
      if (loginRadio) loginRadio.checked = false;
      if (guestRadio) guestRadio.checked = true;
    }
    fillPostNickname();
    onPostAuthModeChange();

    document.getElementById('postCategory').value = 'lecture';
    document.getElementById('lectureName').value = '';
    document.getElementById('lectureBody').value = '';
    // Reset star radio buttons
    document.querySelectorAll('input[name="lectureStars"]').forEach(r => r.checked = false);
    // Reset optional lecture fields
    document.getElementById('lectureFaculty').value = '';
    document.getElementById('lectureTeacher').value = '';
    document.getElementById('lectureSemester').value = '';
    document.getElementById('lectureDay').value = '';
    document.getElementById('lecturePeriod').value = '';
    document.getElementById('lectureExamType').value = '';
    document.getElementById('lectureAttendance').value = '';
    document.getElementById('lectureCredits').value = '';
    // Close optional section
    const optEl = document.getElementById('lectureOptional');
    const optBtn = document.getElementById('lectureOptionalToggle');
    if (optEl) optEl.classList.remove('open');
    if (optBtn) { optBtn.classList.remove('open'); optBtn.textContent = '詳細を追加する'; }
    document.getElementById('circleName').value = '';
    document.getElementById('circleType').value = '';
    document.getElementById('circleBody').value = '';
    document.getElementById('campusTitle').value = '';
    document.getElementById('campusLocation').value = '';
    document.getElementById('campusDateTime').value = '';
    document.getElementById('campusFaculty').value = '';
    document.getElementById('campusBody').value = '';
    document.getElementById('qaTitle').value = '';
    document.getElementById('qaFaculty').value = '';
    document.getElementById('qaBody').value = '';
    onCategoryChange('lecture');
  }

  function toggleLectureOptional() {
    const el = document.getElementById('lectureOptional');
    const btn = document.getElementById('lectureOptionalToggle');
    const isOpen = el.classList.toggle('open');
    btn.classList.toggle('open', isOpen);
    btn.textContent = isOpen ? '詳細を閉じる' : '詳細を追加する';
  }
  function openPostModalWithCategory(category = null) {
    if (category === null) category = currentTab === 'all' ? 'lecture' : (currentTab === 'qa' ? 'qa' : currentTab);
    document.getElementById('postModal').classList.add('open');
    resetPostForm();
    setTimeout(() => { document.getElementById('postCategory').value = category; onCategoryChange(category); }, 0);
  }
  function closePostModal() { document.getElementById('postModal').classList.remove('open'); }
  
  function onCategoryChange(category) {
    // Hide all category fields
    document.getElementById('lecture-fields').style.display = 'none';
    document.getElementById('circle-fields').style.display = 'none';
    document.getElementById('campus-fields').style.display = 'none';
    document.getElementById('qa-fields').style.display = 'none';
    
    // Show selected category fields
    if (category === 'lecture') {
      document.getElementById('lecture-fields').style.display = 'block';
    } else if (category === 'circle') {
      document.getElementById('circle-fields').style.display = 'block';
    } else if (category === 'campus') {
      document.getElementById('campus-fields').style.display = 'block';
    } else if (category === 'qa') {
      document.getElementById('qa-fields').style.display = 'block';
    }
  }

  // 投稿送信
  async function submitPost() {
    const resolvedUser = await getResolvedAuthUser();
    const authMode = resolvedUser?.id ? 'login' : getPostAuthMode();
    const nickname = (document.getElementById('postNickname')?.value || '').trim();
    if (!nickname) {
      alert('ニックネームを入力してください');
      return;
    }
    if (authMode === 'login' && !resolvedUser) {
      alert('ログイン投稿を選択したため、先にGoogleログインしてください。');
      return;
    }

    currentUser = nickname;
    localStorage.setItem('waseda_nickname', nickname);
    updateNicknameBadge();

    const category = document.getElementById('postCategory').value;
    let title, body, faculty, extraData = {};
    
    if (category === 'lecture') {
      // 授業口コミの場合
      const lectureName = document.getElementById('lectureName').value.trim();
      const starsEl = document.querySelector('input[name="lectureStars"]:checked');
      const lectureBody = document.getElementById('lectureBody').value.trim();

      if (!lectureName || !starsEl || !lectureBody) {
        alert('授業名、評価（星）、レビューは必須です');
        return;
      }

      const lectureTeacher = document.getElementById('lectureTeacher').value.trim();
      const lectureFaculty = document.getElementById('lectureFaculty').value;
      const semester = document.getElementById('lectureSemester').value;
      const day = document.getElementById('lectureDay').value;
      const period = document.getElementById('lecturePeriod').value;
      const examType = document.getElementById('lectureExamType').value;
      const attendance = document.getElementById('lectureAttendance').value;
      const credits = document.getElementById('lectureCredits').value;

      title = lectureName;
      body = lectureBody;
      faculty = lectureFaculty || null;

      const extraFields = {};
      if (semester) extraFields.semester = semester;
      if (day && period) extraFields.schedule = `${day}曜${period}限`;
      else if (day) extraFields.day = day;
      else if (period) extraFields.period = `${period}限`;
      if (examType) extraFields.exam_type = examType;
      if (attendance) extraFields.attendance = attendance;
      if (credits) extraFields.credits = credits;

      extraData = {
        lecture_teacher: lectureTeacher || null,
        stars: parseInt(starsEl.value),
        extra_fields: Object.keys(extraFields).length > 0 ? JSON.stringify(extraFields) : null
      };
      
    } else if (category === 'circle') {
      // サークルの場合
      const circleName = document.getElementById('circleName').value.trim();
      const circleType = document.getElementById('circleType').value;
      const circleBody = document.getElementById('circleBody').value.trim();
      
      if (!circleName || !circleBody) {
        alert('サークル名と内容は必須です');
        return;
      }
      
      title = circleName;
      body = circleBody;
      faculty = null; // サークルは学部非表示
      extraData = {
        circle_type: circleType || null
      };
      
    } else if (category === 'campus') {
      // キャンパスライフの場合
      const campusTitle = document.getElementById('campusTitle').value.trim();
      const campusLocation = document.getElementById('campusLocation').value;
      const campusDateTime = document.getElementById('campusDateTime').value.trim();
      const campusFaculty = document.getElementById('campusFaculty').value;
      const campusBody = document.getElementById('campusBody').value.trim();
      
      if (!campusTitle || !campusBody || !campusFaculty) {
        alert('タイトル、学部、内容は必須です');
        return;
      }
      
      title = campusTitle;
      body = campusBody;
      faculty = campusFaculty;
      extraData = {
        campus_location: campusLocation || null,
        campus_datetime: campusDateTime || null
      };
      
    } else if (category === 'qa') {
      // Q&Aの場合
      const qaTitle = document.getElementById('qaTitle').value.trim();
      const qaFaculty = document.getElementById('qaFaculty').value;
      const qaBody = document.getElementById('qaBody').value.trim();
      
      if (!qaTitle || !qaBody || !qaFaculty) {
        alert('質問タイトル、学部、詳細は必須です');
        return;
      }
      
      title = qaTitle;
      body = qaBody;
      faculty = qaFaculty;
      extraData = {};
    }

    const btn = document.getElementById('submitBtn');
    btn.disabled = true;
    btn.textContent = '投稿中...';
    
    const newPost = {
      category,
      faculty,
      author: nickname,
      title,
      body,
      likes: 0,
      comments: 0,
      ...extraData
    };

    let payload = authMode === 'login'
      ? { ...newPost, device_id: getDeviceId(), owner_key: getOwnerKey(resolvedUser) }
      : { ...newPost, device_id: getDeviceId(), owner_key: null };
    let { data: insertedPost, error } = await db.from('posts').insert([payload]).select('*').single();
    if (error && isOwnerKeyColumnError(error)) {
      delete payload.owner_key;
      ({ data: insertedPost, error } = await db.from('posts').insert([payload]).select('*').single());
    }
    btn.disabled = false;
    btn.textContent = '投稿する';
    
    if (error) {
      alert('投稿に失敗しました: ' + error.message);
      return;
    }

    if (authMode === 'login' && resolvedUser?.id && insertedPost?.id) {
      rememberOwnedPostId(insertedPost.id, resolvedUser.id);
    }

    closePostModal();
    resetPostForm();
    loadPosts();
  }

  // answers テーブルから指定投稿の回答を取得するヘルパー
  async function loadAnswers(postId) {
    try { if (!db) throw new Error('Supabase client not initialized'); const { data, error } = await db.from('answers').select('*').eq('post_id', postId).order('created_at', { ascending: false }); if (error) { console.error('loadAnswers error', error); return []; } return Array.isArray(data) ? data : []; } catch (e) { console.error(e); return []; }
  }

  // Q&A詳細
  async function openQaDetail(id) {
    try {
      if (!db) throw new Error('Supabase client not initialized');
      const { data: post, error } = await db.from('posts').select('*').eq('id', id).single();
      if (error || !post) return;

      const answers = await loadAnswers(id);
      const deleteQaIcon = canManagePost(post) ? `<span class="delete-btn" style="cursor:pointer;margin-left:10px;" onclick="deletePost(${JSON.stringify(post.id)})">🗑️</span>` : '';
      const ansHtml = !answers.length
        ? '<p style="color:#aaa;font-size:0.85rem;text-align:center;padding:1rem 0;">まだ回答がありません。最初に回答しよう！</p>'
        : answers.map(a => { const time = a.created_at ? formatTime(a.created_at) : (a.time || ''); return `<div class="answer-item"><div class="answer-meta"><span class="answer-author">@${escHtml(a.author)}</span>${a.best?'<span class="best-badge">✅ ベストアンサー</span>':''}<span class="answer-time">${time}</span></div><div class="answer-text">${escHtml(a.text)}</div></div>`; }).join('');

      document.getElementById('qa-detail-content').innerHTML = `
        <div class="qa-detail">
          <div class="qa-question-box">
            <div class="q-label">❓ 質問</div>
            <div class="q-text">${escHtml(post.title)}</div>
            <div style="font-size:0.85rem;color:var(--gray);margin-top:0.6rem;line-height:1.7">${escHtml(post.body)}</div>
            <div style="font-size:0.75rem;color:#aaa;margin-top:0.5rem">@${escHtml(post.author)} · ${formatTime(post.created_at)}${post.faculty?' · '+FACULTIES[post.faculty]:''}${deleteQaIcon}</div>
          </div>
          <div class="answers-section"><h4>💬 回答 ${answers.length}件</h4>${ansHtml}</div>
          <div class="answer-input-area">
            <h4>✏️ 回答する</h4>
            <textarea class="form-textarea" id="answerInput-${id}" placeholder="あなたの知識や経験をシェアしてください..." style="margin-bottom:0.7rem"></textarea>
            <button class="btn-submit" style="margin-top:0" onclick="submitAnswer(${JSON.stringify(id)})">回答を投稿</button>
          </div>
        </div>`;
      document.getElementById('qaModal').classList.add('open');
    } catch (e) { console.error(e); }
  }

  function closeQaModal() { document.getElementById('qaModal').classList.remove('open'); }

  // 投稿詳細（コメント表示）
  async function openPostDetail(postId) {
    try {
      if (!db) throw new Error('Supabase client not initialized');
      const { data: post, error } = await db.from('posts').select('*').eq('id', postId).single();
      if (error || !post || post.category === 'qa') return;

      const comments = await loadComments(postId);
      const catMap = { lecture: ['📚 授業口コミ', 'cat-lecture'], circle: ['🎯 サークル情報', 'cat-circle'], campus: ['🏫 キャンパスライフ', 'cat-campus'], job:['💼 求人', 'cat-job'] };
      const [catLabel, catCls] = catMap[post.category] || ['その他', 'cat-campus'];
      const fTag = post.faculty ? `<span class="faculty-tag">${FACULTIES[post.faculty]||post.faculty}</span>` : '';
      const timeStr = formatTime(post.created_at);
      const deletePostIcon = canManagePost(post) ? `<span class="delete-btn" style="cursor:pointer;margin-left:10px;" onclick="deletePost(${JSON.stringify(post.id)})">🗑️</span>` : '';

      // Category-specific metadata
      let extraInfo = '';
      if (post.category === 'lecture') {
        const stars = post.stars ? '⭐'.repeat(post.stars) : '';
        const teacher = post.lecture_teacher ? `<div style="margin-top:0.8rem;padding:0.8rem;background:#f9f9f9;border-radius:6px;border-left:3px solid var(--crimson);"><strong>👨‍🏫 担当教員：</strong> ${escHtml(post.lecture_teacher)}</div>` : '';
        extraInfo = `${stars?`<div style="margin-top:0.8rem;font-size:1.1rem;">${stars}</div>`:''}<div style="margin-top:0.5rem;color:var(--gray);font-size:0.9rem;">評価：${stars ? post.stars + '/' : ''}5</div>${teacher}`;
      } else if (post.category === 'circle') {
        const typeMap = { sports:'運動系', culture:'文化系', other:'その他' };
        const type = post.circle_type ? `<div style="margin-top:0.8rem;padding:0.6rem 12px;background:#f0f0f0;border-radius:4px;display:inline-block;color:#555;font-weight:600;">${typeMap[post.circle_type]||post.circle_type}</div>` : '';
        extraInfo = type;
      } else if (post.category === 'campus') {
        const locationMap = { waseda:'早稲田', nishi:'西早稲田', toyama:'戸山', tokorozawa:'所沢', other:'その他' };
        const loc = post.campus_location ? `<div><strong>📍 場所：</strong> ${locationMap[post.campus_location]||post.campus_location}</div>` : '';
        const dt = post.campus_datetime ? `<div><strong>🕐 日時：</strong> ${escHtml(post.campus_datetime)}</div>` : '';
        extraInfo = (loc || dt) ? `<div style="margin-top:0.8rem;padding:0.8rem;background:#f9f9f9;border-radius:6px;border-left:3px solid var(--crimson);font-size:0.95rem;">${loc}${dt}</div>` : '';
      }

      const cmtHtml = !comments.length
        ? '<p style="color:#aaa;font-size:0.9rem;text-align:center;padding:2rem 0;">コメントがまだありません。最初のコメントを書いてみませんか？</p>'
        : comments.map(c => {
            const delIcon = canManageComment(c) ? `<span class="comment-delete" onclick="deleteComment(${JSON.stringify(c.id)}, ${JSON.stringify(postId)})">🗑️</span>` : '';
            const reportIcon = `<span class="comment-delete" style="color:var(--gray-lighter);margin-left:4px;" onclick="openReportModal(null, ${JSON.stringify(c.id)})">🚩</span>`;
            return `<div class="comment-item"><div class="comment-meta"><span class="comment-author">@${escHtml(c.author)}</span><span class="comment-time">${formatTime(c.created_at)}</span>${delIcon}${reportIcon}</div><div class="comment-text">${escHtml(c.text)}</div></div>`;
          }).join('');

      const catHtml = `<span class="category-tag ${catCls}">${catLabel}</span>`;
      document.getElementById('detailModalTitle').textContent = post.title;
      document.getElementById('post-detail-content').innerHTML = `
        <div class="post-detail">
          <div class="post-detail-header">
            ${catHtml}${fTag}<span class="post-detail-meta">@${escHtml(post.author)}</span><span class="post-detail-time">${timeStr}</span>${deletePostIcon}
          </div>
          <div class="post-detail-title">${escHtml(post.title)}</div>
          ${extraInfo ? `<div style="margin-bottom:1rem;">${extraInfo}</div>` : ''}
          <div class="post-detail-body">${escHtml(post.body)}</div>
          <div class="post-detail-stats">
            <span>❤️ ${post.likes||0}</span>
            <span>💬 ${comments.length}件のコメント</span>
          </div>
          <div class="comments-section">
            <h4>コメント</h4>
            ${cmtHtml}
            <div class="comment-input-area">
              <h5>コメントを追加</h5>
              <textarea class="form-textarea" id="commentInput-${postId}" placeholder="あなたの意見や感想をシェアしてください..." style="margin-bottom:0.7rem"></textarea>
              <button class="btn-submit" style="margin-top:0" onclick="submitComment(${JSON.stringify(postId)})">コメントを投稿</button>
            </div>
          </div>
        </div>
      `;
      document.getElementById('postDetailModal').classList.add('open');
    } catch (e) { console.error(e); }
  }

  function closePostDetailModal() { document.getElementById('postDetailModal').classList.remove('open'); }

  async function loadComments(postId) {
    try {
      if (!db) throw new Error('Supabase client not initialized');
      const { data, error } = await db.from('comments').select('*').eq('post_id', postId).order('created_at', { ascending: false });
      if (error) { console.error('loadComments error', error); return []; }
      return Array.isArray(data) ? data : [];
    } catch (e) { console.error(e); return []; }
  }

  async function submitComment(postId) {
    const input = document.getElementById(`commentInput-${postId}`);
    const text = input?.value?.trim();
    if (!text) { alert('コメントを入力してください'); return; }

    try {
      if (!db) throw new Error('Supabase client not initialized');
      let payload = createOwnerPayload({ post_id: postId, author: currentUser, text });
      let { error: insertErr } = await db.from('comments').insert([payload]);
      if (insertErr && isOwnerKeyColumnError(insertErr)) {
        delete payload.owner_key;
        ({ error: insertErr } = await db.from('comments').insert([payload]));
      }
      if (insertErr) { alert('コメント投稿に失敗しました: ' + insertErr.message); return; }

      // posts テーブルのコメント数を更新
      const post = allPosts.find(p => p.id === postId);
      if (post) {
        const newCount = (post.comments || 0) + 1;
        await db.from('posts').update({ comments: newCount }).eq('id', postId);
        post.comments = newCount;
      }

      // モーダルを再表示
      await openPostDetail(postId);
    } catch (e) { console.error(e); alert('コメント投稿に失敗しました'); }
  }

  async function submitAnswer(postId) {
    const input = document.getElementById('answerInput-' + postId);
    const text = input.value.trim();
    if (!text) { alert('回答を入力してください'); return; }
    try {
      if (!db) throw new Error('Supabase client not initialized');
      let payload = createOwnerPayload({ post_id: postId, author: currentUser, text });
      let insertRes = await db.from('answers').insert([payload]);
      if (insertRes.error && isOwnerKeyColumnError(insertRes.error)) {
        delete payload.owner_key;
        insertRes = await db.from('answers').insert([payload]);
      }
      const insertErr = insertRes.error;
      if (insertErr) throw insertErr;
      input.value = '';
      openQaDetail(postId);
      loadPosts();
    } catch (e) { console.error(e); alert('回答の投稿に失敗しました'); }
  }

  // モーダル外クリックで閉じる
  document.getElementById('postModal').addEventListener('click', e => { if (e.target===document.getElementById('postModal')) closePostModal(); });
  document.getElementById('postDetailModal').addEventListener('click', e => { if (e.target===document.getElementById('postDetailModal')) closePostDetailModal(); });
  document.getElementById('qaModal').addEventListener('click', e => { if (e.target===document.getElementById('qaModal')) closeQaModal(); });
  document.getElementById('nicknameModal').addEventListener('click', e => { if (e.target===document.getElementById('nicknameModal')) closeNicknameModal(); });
  document.getElementById('myPageModal').addEventListener('click', e => { if (e.target===document.getElementById('myPageModal')) closeMyPageModal(); });
  document.getElementById('adminModal').addEventListener('click', e => { if (e.target===document.getElementById('adminModal')) closeAdminModal(); });
  document.getElementById('reportModal').addEventListener('click', e => { if (e.target===document.getElementById('reportModal')) closeReportModal(); });

  // ─── 受験生サポートパネル ───

  const jukenSubLoaded = new Set();

  function switchJukenSubTab(tab, el) {
    document.querySelectorAll('.juken-menu-card').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.juken-subpanel').forEach(p => p.classList.remove('active'));
    if (el) el.classList.add('active');
    const panel = document.getElementById('juken-sub-' + tab);
    if (panel) panel.classList.add('active');
    if (!jukenSubLoaded.has(tab)) {
      jukenSubLoaded.add(tab);
      if (tab === 'qa-study') loadJukenQa('study');
      if (tab === 'qa-life') loadJukenQa('life');
    }
  }

  // 受験生質問一覧（勉強 / 大学生活）
  async function loadJukenQa(kind = 'study') {
    const isLife = kind === 'life';
    const el = document.getElementById(isLife ? 'juken-qa-life-list' : 'juken-qa-study-list');
    if (!db) { el.innerHTML = '<div class="loading">DB未接続</div>'; return; }
    try {
      const myIds = getMyQuestionIds();
      const categories = isLife ? ['juken_life_qa'] : ['juken_qa'];
      const { data, error } = await db.from('posts').select('*')
        .in('category', categories).order('created_at',{ascending:false}).limit(30);
      if (error) throw error;
      if (!data || !data.length) {
        el.innerHTML = `<div style="text-align:center;padding:2rem;border:1.5px dashed var(--border);border-radius:10px;color:var(--gray)">
          <div style="font-size:2rem;margin-bottom:.5rem">${isLife ? '🏫' : '❓'}</div>
          <div style="font-weight:700;margin-bottom:.3rem">まだ質問がありません</div>
          <div style="font-size:0.82rem;">受験生ページの「${isLife ? '大学生活Q&A' : '勉強Q&A'}」タブから投稿できます。</div></div>`;
        return;
      }
      const sorted = [...data].sort((a, b) => {
        const mineA = isMyContent(a, myIds) ? 1 : 0;
        const mineB = isMyContent(b, myIds) ? 1 : 0;
        if (mineA !== mineB) return mineB - mineA;
        return new Date(b.created_at || 0) - new Date(a.created_at || 0);
      });
      const mine = [];
      const others = [];
      sorted.forEach(p => {
        const isMine = isMyContent(p, myIds);
        if (isMine) mine.push(p); else others.push(p);
      });

      const renderCard = (p) => {
        const isMine = isMyContent(p, myIds);
        const myTag = isMine ? '<span class="juken-qa-my-badge">🧷 あなたの質問</span>' : '';
        const fTag = p.faculty ? `<span class="juken-qa-faculty">${escHtml(FACULTIES[p.faculty]||p.faculty)}</span>` : '';
        const ans = answersCountMap[p.id] || 0;
        return `<div class="juken-qa-card${isMine ? ' my-question' : ''}" onclick="openQaDetail(${JSON.stringify(p.id)})">
          <div class="juken-qa-card-meta">${myTag}${fTag}<span style="font-size:0.7rem;color:var(--gray-light)">@${escHtml(p.author)} · ${formatTime(p.created_at)}</span></div>
          <div class="juken-qa-title">${escHtml(p.title)}</div>
          <div class="juken-qa-body">${escHtml(p.body)}</div>
          <div class="juken-qa-footer"><span>💬 回答 ${ans}件</span><span>❤️ ${p.likes||0}</span></div>
        </div>`;
      };

      const mineSection = mine.length
        ? `<div class="juken-qa-section-title">🧷 あなたの質問（${mine.length}）</div>${mine.map(p => renderCard(p)).join('')}`
        : '';
      const othersSection = others.length
        ? `<div class="juken-qa-section-title">📚 みんなの質問</div>${others.map(p => renderCard(p)).join('')}`
        : '';

      el.innerHTML = `${mineSection}${othersSection}`;
    } catch(e) { console.error(e); el.innerHTML = '<div class="loading">読み込みエラー</div>'; }
  }

  // 合格体験記投稿
  async function submitTaikenki(btn) {
    const author  = document.getElementById('tk-author').value.trim();
    const faculty = document.getElementById('tk-faculty').value;
    const advice  = document.getElementById('tk-advice').value.trim();
    if (!author)  { alert('ニックネームを入力してください'); return; }
    if (!faculty) { alert('合格学部を選択してください'); return; }
    if (!advice)  { alert('後輩へのアドバイスを入力してください'); return; }
    if (!db) { alert('DB未接続'); return; }
    btn.disabled = true; btn.textContent = '投稿中...';
    try {
      const ef = {};
      const examType    = document.getElementById('tk-exam-type').value;
      const studyStart  = document.getElementById('tk-study-start').value;
      const dailyHours  = document.getElementById('tk-daily-hours').value;
      const references  = document.getElementById('tk-references').value.trim();
      const hardSubject = document.getElementById('tk-hard-subject').value.trim();
      if (examType)    ef.exam_type    = examType;
      if (studyStart)  ef.study_start  = studyStart;
      if (dailyHours)  ef.daily_hours  = dailyHours;
      if (references)  ef.references   = references;
      if (hardSubject) ef.hard_subject = hardSubject;
      const { error } = await db.from('posts').insert([{
        category: 'taikenki', author, faculty,
        title: advice.slice(0, 40), body: advice,
        extra_fields: Object.keys(ef).length ? JSON.stringify(ef) : null,
        likes: 0, comments: 0, device_id: getDeviceId()
      }]);
      if (error) throw error;
      ['tk-author','tk-faculty','tk-exam-type','tk-study-start','tk-daily-hours','tk-references','tk-hard-subject','tk-advice']
        .forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
      alert('体験記を投稿しました！ありがとうございます。');
    } catch(e) { console.error(e); alert('投稿に失敗しました: ' + (e?.message || e?.code || JSON.stringify(e))); }
    finally { btn.disabled = false; btn.textContent = '体験記を投稿する'; }
  }

  // 学部コメント投稿
  async function submitFacultyComment(btn) {
    const author  = document.getElementById('fc-author').value.trim();
    const faculty = document.getElementById('fc-faculty').value;
    const comment = document.getElementById('fc-comment').value.trim();
    if (!author)  { alert('ニックネームを入力してください'); return; }
    if (!faculty) { alert('学部を選択してください'); return; }
    if (!comment) { alert('コメントを入力してください'); return; }
    if (!db) { alert('DB未接続'); return; }
    btn.disabled = true; btn.textContent = '投稿中...';
    try {
      const { error } = await db.from('posts').insert([{
        category: 'faculty_comment', author, faculty,
        title: comment.slice(0, 40), body: comment,
        likes: 0, comments: 0, device_id: getDeviceId()
      }]);
      if (error) throw error;
      ['fc-author','fc-faculty','fc-comment'].forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
      alert('コメントを投稿しました！ありがとうございます。');
    } catch(e) { console.error(e); alert('投稿に失敗しました: ' + (e?.message || e?.code || JSON.stringify(e))); }
    finally { btn.disabled = false; btn.textContent = 'コメントを投稿する'; }
  }

  // タブスクロールボタン
  function scrollTabsRight() {
    document.getElementById('tabsInner').scrollBy({ left: 140, behavior: 'smooth' });
  }
  function updateScrollBtn() {
    const inner = document.getElementById('tabsInner');
    const btn = document.getElementById('tabsScrollBtn');
    if (!inner || !btn) return;
    const atEnd = inner.scrollLeft + inner.clientWidth >= inner.scrollWidth - 4;
    btn.classList.toggle('hidden', atEnd);
  }
  document.getElementById('tabsInner').addEventListener('scroll', updateScrollBtn);
  window.addEventListener('resize', updateScrollBtn);

  // 初期化
  initGoogleAuth();
  updateNicknameBadge();
  checkAdmin();
  setupTrendTabs();
  loadPosts();
  refreshAnnouncements();
  updateScrollBtn();
  </script>
  </body>
  </html>
