<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãƒ¯ã‚»ãƒ€ãƒãƒ¼ãƒˆ - æ—©ç¨²ç”°ç”Ÿã®æƒ…å ±å…±æœ‰æ²ç¤ºæ¿</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root {
    --crimson: #8B0000; --crimson-light: #A50000; --crimson-pale: #f9f0f0;
    --gold: #C8A951; --gold-light: #e8c96a;
    --dark: #1a1a1a; --gray: #6b6b6b; --white: #ffffff; --border: #e8e0e0;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Noto Sans JP', sans-serif; background: #faf8f8; color: var(--dark); min-height: 100vh; }

  header { background: var(--crimson); padding: 0 2rem; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 20px rgba(139,0,0,0.3); }
  .header-inner { max-width: 1100px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; height: 60px; }
  .logo { display: flex; align-items: baseline; gap: 8px; text-decoration: none; }
  .logo-jp { font-size: 1.4rem; font-weight: 900; color: var(--white); letter-spacing: 0.05em; }
  .logo-en { font-family: 'Playfair Display', serif; font-size: 0.75rem; color: var(--gold-light); letter-spacing: 0.15em; }
  .header-right { display: flex; align-items: center; gap: 0.8rem; }
  .nickname-badge { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 5px 14px; border-radius: 20px; font-size: 0.8rem; cursor: pointer; }
  .btn-post { background: var(--gold); color: var(--dark); border: none; padding: 7px 18px; border-radius: 6px; font-weight: 700; font-size: 0.85rem; cursor: pointer; font-family: 'Noto Sans JP', sans-serif; }
  .btn-post:hover { background: var(--gold-light); }

  .hero { background: linear-gradient(135deg, var(--crimson) 0%, #5a0000 100%); padding: 2.5rem 2rem 2rem; text-align: center; }
  .hero h1 { font-size: 1.1rem; color: var(--gold-light); letter-spacing: 0.2em; margin-bottom: 0.4rem; font-weight: 500; }
  .hero p { color: rgba(255,255,255,0.7); font-size: 0.85rem; margin-bottom: 1.4rem; }
  .search-bar { max-width: 600px; margin: 0 auto; display: flex; gap: 8px; }
  .search-input { flex: 1; border: none; border-radius: 8px; padding: 0.7rem 1.1rem; font-size: 0.9rem; font-family: 'Noto Sans JP', sans-serif; outline: none; }
  .search-btn { background: var(--gold); border: none; border-radius: 8px; padding: 0 1.2rem; font-size: 1.1rem; cursor: pointer; }

  .faculty-bar { background: white; border-bottom: 1px solid var(--border); padding: 0.7rem 2rem; overflow-x: auto; }
  .faculty-bar-inner { max-width: 1100px; margin: 0 auto; display: flex; gap: 8px; white-space: nowrap; align-items: center; }
  .faculty-label { font-size: 0.75rem; color: var(--gray); font-weight: 700; margin-right: 4px; flex-shrink: 0; }
  .faculty-chip { padding: 4px 14px; border-radius: 20px; font-size: 0.78rem; font-weight: 500; cursor: pointer; border: 1.5px solid var(--border); background: white; color: var(--gray); transition: all 0.15s; white-space: nowrap; font-family: 'Noto Sans JP', sans-serif; }
  .faculty-chip:hover { border-color: var(--crimson); color: var(--crimson); }
  .faculty-chip.active { background: var(--crimson); color: white; border-color: var(--crimson); }

  .tabs { background: white; border-bottom: 2px solid var(--border); padding: 0 2rem; position: sticky; top: 60px; z-index: 90; }
  .tabs-inner { max-width: 1100px; margin: 0 auto; display: flex; }
  .tab { padding: 0.9rem 1.2rem; font-size: 0.85rem; font-weight: 500; color: var(--gray); cursor: pointer; border-bottom: 3px solid transparent; margin-bottom: -2px; transition: all 0.2s; }
  .tab:hover { color: var(--crimson); }
  .tab.active { color: var(--crimson); border-bottom-color: var(--crimson); font-weight: 700; }

  .main { max-width: 1100px; margin: 0 auto; padding: 2rem; display: grid; grid-template-columns: 1fr 290px; gap: 2rem; }

  .search-banner { background: var(--crimson-pale); border: 1px solid #f0d8d8; border-radius: 8px; padding: 0.7rem 1rem; margin-bottom: 1rem; font-size: 0.85rem; color: var(--crimson); display: none; align-items: center; justify-content: space-between; }
  .search-banner.show { display: flex; }
  .clear-search { cursor: pointer; font-weight: 700; font-size: 0.8rem; }

  .posts-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.2rem; }
  .posts-header h2 { font-size: 1.1rem; font-weight: 700; }
  .sort-select { border: 1px solid var(--border); padding: 5px 10px; border-radius: 6px; font-size: 0.8rem; color: var(--gray); background: white; cursor: pointer; font-family: 'Noto Sans JP', sans-serif; }

  .post-card { background: white; border: 1px solid var(--border); border-radius: 12px; padding: 1.2rem 1.4rem; margin-bottom: 1rem; transition: box-shadow 0.2s, transform 0.2s; cursor: pointer; }
  .post-card:hover { box-shadow: 0 4px 20px rgba(139,0,0,0.1); transform: translateY(-1px); }
  .post-meta { display: flex; align-items: center; gap: 8px; margin-bottom: 0.6rem; flex-wrap: wrap; }
  .category-tag { font-size: 0.7rem; font-weight: 700; padding: 3px 10px; border-radius: 20px; }
  .faculty-tag { font-size: 0.7rem; padding: 3px 10px; border-radius: 20px; background: var(--crimson-pale); color: var(--crimson); font-weight: 600; }
  .cat-lecture { background: #fff3e0; color: #e65100; }
  .cat-circle { background: #e8f5e9; color: #2e7d32; }
  .cat-campus { background: #e3f2fd; color: #1565c0; }
  .cat-qa { background: #f3e5f5; color: #6a1b9a; }
  .author { font-size: 0.8rem; color: var(--gray); font-weight: 500; }
  .post-time { font-size: 0.75rem; color: #aaa; margin-left: auto; }
  .post-title { font-size: 1rem; font-weight: 700; margin-bottom: 0.5rem; line-height: 1.4; }
  .post-body { font-size: 0.85rem; color: var(--gray); line-height: 1.7; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
  .post-footer { display: flex; gap: 1rem; margin-top: 0.9rem; padding-top: 0.9rem; border-top: 1px solid #f0f0f0; }
  .post-action { display: flex; align-items: center; gap: 5px; font-size: 0.8rem; color: #aaa; cursor: pointer; transition: color 0.2s; }
  .post-action:hover { color: var(--crimson); }
  .post-action.liked { color: var(--crimson); }
  .stars { color: var(--gold); font-size: 0.85rem; }

  .qa-card { background: white; border: 1.5px solid #e8d5f5; border-radius: 12px; padding: 1.2rem 1.4rem; margin-bottom: 1rem; cursor: pointer; transition: box-shadow 0.2s, transform 0.2s; }
  .qa-card:hover { box-shadow: 0 4px 20px rgba(106,27,154,0.1); transform: translateY(-1px); }
  .qa-status { font-size: 0.72rem; font-weight: 700; padding: 3px 10px; border-radius: 20px; }
  .qa-status.answered { background: #e8f5e9; color: #2e7d32; }
  .qa-status.open { background: #fff3e0; color: #e65100; }

  .loading { text-align: center; padding: 3rem; color: var(--gray); font-size: 0.9rem; }
  .empty-tab { text-align: center; padding: 4rem 2rem; color: var(--gray); }
  .empty-tab .empty-icon { font-size: 3rem; margin-bottom: 1rem; }

  .sidebar { display: flex; flex-direction: column; gap: 1.5rem; }
  .sidebar-card { background: white; border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
  .sidebar-card-header { background: var(--crimson); padding: 0.8rem 1.2rem; color: white; font-size: 0.85rem; font-weight: 700; }
  .sidebar-card-body { padding: 1rem 1.2rem; }
  .trend-item { display: flex; align-items: flex-start; gap: 10px; padding: 0.55rem 0; border-bottom: 1px solid #f5f5f5; cursor: pointer; }
  .trend-item:last-child { border-bottom: none; }
  .trend-num { font-size: 1.1rem; font-weight: 900; color: var(--crimson); min-width: 22px; font-family: 'Playfair Display', serif; }
  .trend-text { font-size: 0.82rem; color: var(--dark); line-height: 1.4; }
  .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.8rem; }
  .stat-box { text-align: center; padding: 0.8rem; background: var(--crimson-pale); border-radius: 8px; }
  .stat-num { font-size: 1.4rem; font-weight: 900; color: var(--crimson); font-family: 'Playfair Display', serif; }
  .stat-label { font-size: 0.7rem; color: var(--gray); margin-top: 2px; }

  .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; padding: 1rem; }
  .modal-overlay.open { display: flex; }
  .modal { background: white; border-radius: 16px; width: 100%; max-width: 560px; overflow: hidden; animation: slideUp 0.3s ease; max-height: 90vh; overflow-y: auto; }
  .modal-wide { max-width: 620px; }
  @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  .modal-header { background: var(--crimson); padding: 1.2rem 1.5rem; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1; }
  .modal-header h3 { color: white; font-size: 1rem; font-weight: 700; }
  .modal-close { color: white; background: none; border: none; font-size: 1.4rem; cursor: pointer; line-height: 1; }
  .modal-body { padding: 1.5rem; }
  .form-group { margin-bottom: 1.1rem; }
  .form-label { display: block; font-size: 0.82rem; font-weight: 700; color: var(--dark); margin-bottom: 0.4rem; }
  .form-input, .form-select, .form-textarea { width: 100%; border: 1.5px solid var(--border); border-radius: 8px; padding: 0.6rem 0.9rem; font-size: 0.9rem; font-family: 'Noto Sans JP', sans-serif; color: var(--dark); outline: none; background: white; }
  .form-input:focus, .form-select:focus, .form-textarea:focus { border-color: var(--crimson); }
  .form-textarea { resize: vertical; min-height: 90px; }
  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
  .btn-submit { width: 100%; background: var(--crimson); color: white; border: none; padding: 0.9rem; border-radius: 8px; font-size: 0.95rem; font-weight: 700; cursor: pointer; font-family: 'Noto Sans JP', sans-serif; margin-top: 0.5rem; }
  .btn-submit:hover { background: var(--crimson-light); }
  .btn-submit:disabled { background: #ccc; cursor: not-allowed; }

  .qa-detail { padding: 1.5rem; }
  .qa-question-box { background: #f8f3ff; border-left: 4px solid #7b1fa2; border-radius: 0 8px 8px 0; padding: 1rem 1.2rem; margin-bottom: 1.5rem; }
  .qa-question-box .q-label { font-size: 0.75rem; font-weight: 700; color: #7b1fa2; margin-bottom: 0.5rem; }
  .qa-question-box .q-text { font-size: 0.95rem; font-weight: 700; }
  .answers-section h4 { font-size: 0.9rem; font-weight: 700; margin-bottom: 1rem; color: var(--gray); }
  .answer-item { background: white; border: 1px solid var(--border); border-radius: 10px; padding: 1rem; margin-bottom: 0.8rem; }
  .answer-meta { display: flex; gap: 8px; margin-bottom: 0.5rem; align-items: center; }
  .answer-author { font-size: 0.8rem; font-weight: 700; }
  .answer-time { font-size: 0.75rem; color: #aaa; }
  .best-badge { font-size: 0.7rem; background: #e8f5e9; color: #2e7d32; padding: 2px 8px; border-radius: 10px; font-weight: 700; }
  .answer-text { font-size: 0.87rem; color: var(--gray); line-height: 1.7; }
  .answer-input-area { margin-top: 1.2rem; border-top: 1px solid var(--border); padding-top: 1.2rem; }
  .answer-input-area h4 { font-size: 0.88rem; font-weight: 700; margin-bottom: 0.6rem; }

  /* ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« */
  .nickname-modal { max-width: 400px; }

  @media (max-width: 768px) {
    .main { grid-template-columns: 1fr; padding: 1rem; }
    .sidebar { display: none; }
    .tab { padding: 0.7rem 0.8rem; font-size: 0.78rem; }
    .form-row { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<header>
  <div class="header-inner">
    <a class="logo" href="#"><span class="logo-jp">ãƒ¯ã‚»ãƒ€ãƒãƒ¼ãƒˆ</span><span class="logo-en">WASEDA NOTE</span></a>
    <div class="header-right">
      <div class="nickname-badge" id="nicknameBadge" onclick="openNicknameModal()">ğŸ‘¤ è¨­å®šä¸­...</div>
      <button class="btn-post" onclick="openPostModal()">ï¼‹ æŠ•ç¨¿ã™ã‚‹</button>
    </div>
  </div>
</header>

<div class="hero">
  <h1>æ—©ç¨²ç”°ç”Ÿã®ãŸã‚ã®ã€æ—©ç¨²ç”°ç”Ÿã«ã‚ˆã‚‹æƒ…å ±å…±æœ‰</h1>
  <p>æˆæ¥­ã®å£ã‚³ãƒŸãƒ»ã‚µãƒ¼ã‚¯ãƒ«ãƒ»ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹ãƒ©ã‚¤ãƒ•ã‚’ã¿ã‚“ãªã§ã‚·ã‚§ã‚¢ã—ã‚ˆã†</p>
  <div class="search-bar">
    <input class="search-input" type="text" id="searchInput" placeholder="ğŸ” æˆæ¥­åãƒ»ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢..." onkeydown="if(event.key==='Enter')doSearch()">
    <button class="search-btn" onclick="doSearch()">æ¤œç´¢</button>
  </div>
</div>

<div class="faculty-bar">
  <div class="faculty-bar-inner">
    <span class="faculty-label">å­¦éƒ¨ï¼š</span>
    <button class="faculty-chip active" onclick="selectFaculty('all',this)">ã™ã¹ã¦</button>
    <button class="faculty-chip" onclick="selectFaculty('seikei',this)">æ”¿æ²»çµŒæ¸ˆ</button>
    <button class="faculty-chip" onclick="selectFaculty('ho',this)">æ³•</button>
    <button class="faculty-chip" onclick="selectFaculty('shogaku',this)">å•†</button>
    <button class="faculty-chip" onclick="selectFaculty('kyoiku',this)">æ•™è‚²</button>
    <button class="faculty-chip" onclick="selectFaculty('bun',this)">æ–‡</button>
    <button class="faculty-chip" onclick="selectFaculty('bunkagaku',this)">æ–‡åŒ–æ§‹æƒ³</button>
    <button class="faculty-chip" onclick="selectFaculty('kiso',this)">åŸºå¹¹ç†å·¥</button>
    <button class="faculty-chip" onclick="selectFaculty('sozo',this)">å‰µé€ ç†å·¥</button>
    <button class="faculty-chip" onclick="selectFaculty('sentan',this)">å…ˆé€²ç†å·¥</button>
    <button class="faculty-chip" onclick="selectFaculty('ningen',this)">äººé–“ç§‘å­¦</button>
    <button class="faculty-chip" onclick="selectFaculty('sports',this)">ã‚¹ãƒãƒ¼ãƒ„ç§‘å­¦</button>
    <button class="faculty-chip" onclick="selectFaculty('kokusai',this)">å›½éš›æ•™é¤Š</button>
    <button class="faculty-chip" onclick="selectFaculty('shakou',this)">ç¤¾ä¼šç§‘å­¦</button>
  </div>
</div>

<div class="tabs">
  <div class="tabs-inner">
    <div class="tab active" onclick="switchTab('all',this)">ğŸ“‹ ã™ã¹ã¦</div>
    <div class="tab" onclick="switchTab('lecture',this)">ğŸ“š æˆæ¥­å£ã‚³ãƒŸ</div>
    <div class="tab" onclick="switchTab('circle',this)">ğŸ¯ ã‚µãƒ¼ã‚¯ãƒ«</div>
    <div class="tab" onclick="switchTab('campus',this)">ğŸ« ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹ãƒ©ã‚¤ãƒ•</div>
    <div class="tab" onclick="switchTab('qa',this)">â“ Q&amp;A</div>
  </div>
</div>

<div class="main">
  <div class="posts-section">
    <div id="search-banner" class="search-banner">
      <span id="search-banner-text"></span>
      <span class="clear-search" onclick="clearSearch()">âœ• ã‚¯ãƒªã‚¢</span>
    </div>
    <div class="posts-header">
      <h2 id="section-title">æ–°ç€æŠ•ç¨¿</h2>
      <select class="sort-select"><option>æ–°ç€é †</option></select>
    </div>
    <div id="posts-container"><div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div></div>
  </div>

  <aside class="sidebar">
    <div class="sidebar-card">
      <div class="sidebar-card-header">ğŸ”¥ ãƒˆãƒ¬ãƒ³ãƒ‰</div>
      <div class="sidebar-card-body">
        <div class="trend-item"><span class="trend-num">1</span><span class="trend-text">æ˜¥å­¦æœŸã®æ¥½å˜æˆæ¥­ã¾ã¨ã‚</span></div>
        <div class="trend-item"><span class="trend-num">2</span><span class="trend-text">æ—©ç¨²ç”°ç¥­ã‚µãƒ¼ã‚¯ãƒ«å‡ºå±•æƒ…å ±</span></div>
        <div class="trend-item"><span class="trend-num">3</span><span class="trend-text">3å·é¤¨ã‚³ãƒ³ãƒ“ãƒ‹ãƒªãƒ‹ãƒ¥ãƒ¼ã‚¢ãƒ«</span></div>
        <div class="trend-item"><span class="trend-num">4</span><span class="trend-text">ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ³å ±å‘Šã‚¹ãƒ¬ãƒƒãƒ‰</span></div>
        <div class="trend-item"><span class="trend-num">5</span><span class="trend-text">æ”¿çµŒã®å¿…ä¿®å¤‰æ›´ã«ã¤ã„ã¦</span></div>
      </div>
    </div>
    <div class="sidebar-card">
      <div class="sidebar-card-header">ğŸ“Š çµ±è¨ˆ</div>
      <div class="sidebar-card-body">
        <div class="stats-grid">
          <div class="stat-box"><div class="stat-num" id="stat-posts">-</div><div class="stat-label">æŠ•ç¨¿æ•°</div></div>
          <div class="stat-box"><div class="stat-num" id="stat-qa">-</div><div class="stat-label">Q&amp;Aæ•°</div></div>
        </div>
      </div>
    </div>
  </aside>
</div>

<!-- æŠ•ç¨¿ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-overlay" id="postModal">
  <div class="modal">
    <div class="modal-header">
      <h3>âœï¸ æ–°è¦æŠ•ç¨¿</h3>
      <button class="modal-close" onclick="closePostModal()">Ã—</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">ã‚«ãƒ†ã‚´ãƒª</label>
          <select class="form-select" id="postCategory" onchange="onCategoryChange(this)">
            <option value="lecture">ğŸ“š æˆæ¥­å£ã‚³ãƒŸ</option>
            <option value="circle">ğŸ¯ ã‚µãƒ¼ã‚¯ãƒ«æƒ…å ±</option>
            <option value="campus">ğŸ« ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹ãƒ©ã‚¤ãƒ•</option>
            <option value="qa">â“ Q&amp;Aï¼ˆè³ªå•ï¼‰</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">å­¦éƒ¨</label>
          <select class="form-select" id="postFaculty">
            <option value="">å­¦éƒ¨ã‚’é¸æŠï¼ˆä»»æ„ï¼‰</option>
            <option value="seikei">æ”¿æ²»çµŒæ¸ˆå­¦éƒ¨</option>
            <option value="ho">æ³•å­¦éƒ¨</option>
            <option value="shogaku">å•†å­¦éƒ¨</option>
            <option value="kyoiku">æ•™è‚²å­¦éƒ¨</option>
            <option value="bun">æ–‡å­¦éƒ¨</option>
            <option value="bunkagaku">æ–‡åŒ–æ§‹æƒ³å­¦éƒ¨</option>
            <option value="kiso">åŸºå¹¹ç†å·¥å­¦éƒ¨</option>
            <option value="sozo">å‰µé€ ç†å·¥å­¦éƒ¨</option>
            <option value="sentan">å…ˆé€²ç†å·¥å­¦éƒ¨</option>
            <option value="ningen">äººé–“ç§‘å­¦éƒ¨</option>
            <option value="sports">ã‚¹ãƒãƒ¼ãƒ„ç§‘å­¦éƒ¨</option>
            <option value="kokusai">å›½éš›æ•™é¤Šå­¦éƒ¨</option>
            <option value="shakou">ç¤¾ä¼šç§‘å­¦éƒ¨</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label" id="title-label">ã‚¿ã‚¤ãƒˆãƒ«</label>
        <input class="form-input" type="text" id="postTitle" placeholder="ä¾‹ï¼šæ”¿æ²»çµŒæ¸ˆå­¦ã®æˆæ¥­ã«ã¤ã„ã¦">
      </div>
      <div class="form-group">
        <label class="form-label" id="body-label">å†…å®¹</label>
        <textarea class="form-textarea" id="postBody" placeholder="è©³ã—ã„å†…å®¹ã‚’æ›¸ã„ã¦ãã ã•ã„..."></textarea>
      </div>
      <div class="form-group" id="lectureExtra" style="display:none;">
        <label class="form-label">æˆæ¥­è©•ä¾¡</label>
        <select class="form-select" id="postStars">
          <option value="5">â­â­â­â­â­ ã¨ã¦ã‚‚è‰¯ã„</option>
          <option value="4">â­â­â­â­ è‰¯ã„</option>
          <option value="3">â­â­â­ æ™®é€š</option>
          <option value="2">â­â­ å¾®å¦™</option>
          <option value="1">â­ è‰¯ããªã„</option>
        </select>
      </div>
      <button class="btn-submit" id="submitBtn" onclick="submitPost()">æŠ•ç¨¿ã™ã‚‹</button>
    </div>
  </div>
</div>

<!-- Q&Aãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-overlay" id="qaModal">
  <div class="modal modal-wide">
    <div class="modal-header">
      <h3>â“ Q&amp;A ã‚¹ãƒ¬ãƒƒãƒ‰</h3>
      <button class="modal-close" onclick="closeQaModal()">Ã—</button>
    </div>
    <div id="qa-detail-content"></div>
  </div>
</div>

<!-- ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-overlay" id="nicknameModal">
  <div class="modal nickname-modal">
    <div class="modal-header">
      <h3>ğŸ‘¤ ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ è¨­å®š</h3>
      <button class="modal-close" onclick="closeNicknameModal()">Ã—</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ </label>
        <input class="form-input" type="text" id="nicknameInput" placeholder="ä¾‹ï¼šwaseda_taro" maxlength="20">
      </div>
      <button class="btn-submit" onclick="saveNickname()">ä¿å­˜ã™ã‚‹</button>
    </div>
  </div>
</div>

<script>
// SupabaseåˆæœŸåŒ–
const SUPABASE_URL = 'https://hazntivymzywhowtdtcc.supabase.co';
const SUPABASE_ANON_KEY = 'sb_publishable_Mr1wt5ZOoLtmYqPEoIKeUw_cM4ZPSbN';
const { createClient } = supabase;
const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const FACULTIES = {
  seikei:'æ”¿æ²»çµŒæ¸ˆå­¦éƒ¨', ho:'æ³•å­¦éƒ¨', shogaku:'å•†å­¦éƒ¨', kyoiku:'æ•™è‚²å­¦éƒ¨',
  bun:'æ–‡å­¦éƒ¨', bunkagaku:'æ–‡åŒ–æ§‹æƒ³å­¦éƒ¨', kiso:'åŸºå¹¹ç†å·¥å­¦éƒ¨', sozo:'å‰µé€ ç†å·¥å­¦éƒ¨',
  sentan:'å…ˆé€²ç†å·¥å­¦éƒ¨', ningen:'äººé–“ç§‘å­¦éƒ¨', sports:'ã‚¹ãƒãƒ¼ãƒ„ç§‘å­¦éƒ¨',
  kokusai:'å›½éš›æ•™é¤Šå­¦éƒ¨', shakou:'ç¤¾ä¼šç§‘å­¦éƒ¨'
};

let currentTab = 'all';
let currentFaculty = 'all';
let searchQuery = '';
let currentUser = localStorage.getItem('waseda_nickname') || 'ã‚²ã‚¹ãƒˆ';
let allPosts = [];

// ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ 
function updateNicknameBadge() {
  document.getElementById('nicknameBadge').textContent = 'ğŸ‘¤ ' + currentUser;
}

function openNicknameModal() {
  document.getElementById('nicknameInput').value = currentUser;
  document.getElementById('nicknameModal').classList.add('open');
}

function closeNicknameModal() {
  document.getElementById('nicknameModal').classList.remove('open');
}

function saveNickname() {
  const val = document.getElementById('nicknameInput').value.trim();
  if (!val) { alert('ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  currentUser = val;
  localStorage.setItem('waseda_nickname', val);
  updateNicknameBadge();
  closeNicknameModal();
}

// æŠ•ç¨¿å–å¾—
async function loadPosts() {
  document.getElementById('posts-container').innerHTML = '<div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>';
  try {
    let query = db.from('posts').select('*').order('created_at', { ascending: false });
    if (currentTab !== 'all') query = query.eq('category', currentTab);
    if (currentFaculty !== 'all') query = query.eq('faculty', currentFaculty);
    if (searchQuery) query = query.or(`title.ilike.%${searchQuery}%,body.ilike.%${searchQuery}%`);

    const { data, error } = await query;
    if (error) throw error;
    allPosts = data || [];
    renderPosts(allPosts);
    updateStats();
  } catch (err) {
    console.error(err);
    document.getElementById('posts-container').innerHTML = '<div class="empty-tab"><div class="empty-icon">âš ï¸</div><p>ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</p></div>';
  }
}

function updateStats() {
  const total = allPosts.length;
  const qa = allPosts.filter(p => p.category === 'qa').length;
  document.getElementById('stat-posts').textContent = total.toLocaleString();
  document.getElementById('stat-qa').textContent = qa.toLocaleString();
}

function formatTime(ts) {
  const diff = Math.floor((Date.now() - new Date(ts)) / 1000);
  if (diff < 60) return 'ãŸã£ãŸä»Š';
  if (diff < 3600) return Math.floor(diff/60) + 'åˆ†å‰';
  if (diff < 86400) return Math.floor(diff/3600) + 'æ™‚é–“å‰';
  return Math.floor(diff/86400) + 'æ—¥å‰';
}

function renderPosts(posts) {
  const container = document.getElementById('posts-container');
  if (!posts.length) {
    container.innerHTML = '<div class="empty-tab"><div class="empty-icon">ğŸ“­</div><p>æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æœ€åˆã®æŠ•ç¨¿è€…ã«ãªã‚ã†ï¼</p></div>';
    return;
  }
  const catMap = {
    lecture:['cat-lecture','ğŸ“š æˆæ¥­å£ã‚³ãƒŸ'],
    circle:['cat-circle','ğŸ¯ ã‚µãƒ¼ã‚¯ãƒ«'],
    campus:['cat-campus','ğŸ« ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹ãƒ©ã‚¤ãƒ•'],
    qa:['cat-qa','â“ Q&A']
  };

  container.innerHTML = posts.map(p => {
    const [cls, label] = catMap[p.category] || ['cat-campus','ãã®ä»–'];
    const fTag = p.faculty ? `<span class="faculty-tag">${FACULTIES[p.faculty]||p.faculty}</span>` : '';
    const timeStr = formatTime(p.created_at);

    if (p.category === 'qa') {
      const answers = Array.isArray(p.answers) ? p.answers : [];
      const sc = p.solved ? 'answered' : 'open';
      const sl = p.solved ? 'âœ… è§£æ±ºæ¸ˆã¿' : 'ğŸ”“ å›ç­”å‹Ÿé›†ä¸­';
      return `<div class="qa-card" onclick="openQaDetail(${p.id})">
        <div class="post-meta"><span class="category-tag cat-qa">â“ Q&amp;A</span><span class="qa-status ${sc}">${sl}</span>${fTag}<span class="post-time">${timeStr}</span></div>
        <div class="post-title">${escHtml(p.title)}</div>
        <div class="post-body">${escHtml(p.body)}</div>
        <div class="post-footer">
          <span class="post-action">ğŸ’¬ å›ç­” ${answers.length}ä»¶</span>
          <span class="post-action">â¤ï¸ ${p.likes||0}</span>
          <span class="post-action">@${escHtml(p.author)}</span>
        </div></div>`;
    }

    const stars = p.stars ? 'â­'.repeat(p.stars) : '';
    return `<div class="post-card">
      <div class="post-meta"><span class="category-tag ${cls}">${label}</span>${fTag}<span class="author">@${escHtml(p.author)}</span>${stars?`<span class="stars">${stars}</span>`:''}<span class="post-time">${timeStr}</span></div>
      <div class="post-title">${escHtml(p.title)}</div>
      <div class="post-body">${escHtml(p.body)}</div>
      <div class="post-footer">
        <span class="post-action" onclick="likePost(${p.id}, this)">â¤ï¸ <span class="like-count">${p.likes||0}</span></span>
        <span class="post-action">ğŸ’¬ ${p.comments||0}</span>
      </div></div>`;
  }).join('');
}

function escHtml(str) {
  return String(str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ã„ã„ã­
async function likePost(id, el) {
  const countEl = el.querySelector('.like-count');
  const cur = parseInt(countEl.textContent);
  const newCount = cur + 1;
  countEl.textContent = newCount;
  await db.from('posts').update({ likes: newCount }).eq('id', id);
}

// æ¤œç´¢
function doSearch() {
  searchQuery = document.getElementById('searchInput').value.trim();
  const banner = document.getElementById('search-banner');
  if (searchQuery) { banner.classList.add('show'); document.getElementById('search-banner-text').textContent = `ã€Œ${searchQuery}ã€ã®æ¤œç´¢çµæœ`; }
  else { banner.classList.remove('show'); }
  loadPosts();
}

function clearSearch() {
  searchQuery = '';
  document.getElementById('searchInput').value = '';
  document.getElementById('search-banner').classList.remove('show');
  loadPosts();
}

// ã‚¿ãƒ–ãƒ»å­¦éƒ¨åˆ‡æ›¿
function switchTab(tab, el) {
  currentTab = tab;
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  const titles = { all:'æ–°ç€æŠ•ç¨¿', lecture:'æˆæ¥­å£ã‚³ãƒŸ', circle:'ã‚µãƒ¼ã‚¯ãƒ«æƒ…å ±', campus:'ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹ãƒ©ã‚¤ãƒ•', qa:'Q&A' };
  document.getElementById('section-title').textContent = titles[tab];
  loadPosts();
}

function selectFaculty(f, el) {
  currentFaculty = f;
  document.querySelectorAll('.faculty-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  loadPosts();
}

// æŠ•ç¨¿ãƒ¢ãƒ¼ãƒ€ãƒ«
function openPostModal() { document.getElementById('postModal').classList.add('open'); }
function closePostModal() { document.getElementById('postModal').classList.remove('open'); }

function onCategoryChange(sel) {
  const isL = sel.value === 'lecture', isQ = sel.value === 'qa';
  document.getElementById('lectureExtra').style.display = isL ? 'block' : 'none';
  document.getElementById('title-label').textContent = isQ ? 'è³ªå•ã‚¿ã‚¤ãƒˆãƒ«' : 'ã‚¿ã‚¤ãƒˆãƒ«';
  document.getElementById('body-label').textContent = isQ ? 'è³ªå•ã®è©³ç´°' : 'å†…å®¹';
  document.getElementById('postTitle').placeholder = isQ ? 'ä¾‹ï¼šæ”¿çµŒã®å¿…ä¿®ç™»éŒ²ã®æ–¹æ³•ã¯ï¼Ÿ' : 'ä¾‹ï¼šãƒã‚¯ãƒ­çµŒæ¸ˆå­¦ã®å£ã‚³ãƒŸ';
}

// æŠ•ç¨¿é€ä¿¡
async function submitPost() {
  const title = document.getElementById('postTitle').value.trim();
  const body = document.getElementById('postBody').value.trim();
  const category = document.getElementById('postCategory').value;
  const faculty = document.getElementById('postFaculty').value;
  if (!title || !body) { alert('ã‚¿ã‚¤ãƒˆãƒ«ã¨å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

  const btn = document.getElementById('submitBtn');
  btn.disabled = true;
  btn.textContent = 'æŠ•ç¨¿ä¸­...';

  const stars = category === 'lecture' ? parseInt(document.getElementById('postStars').value) : null;
  const newPost = {
    category, faculty: faculty || null, author: currentUser,
    title, body, likes: 0, comments: 0,
    stars, answers: [], solved: false
  };

  const { error } = await db.from('posts').insert([newPost]);
  btn.disabled = false;
  btn.textContent = 'æŠ•ç¨¿ã™ã‚‹';

  if (error) { alert('æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message); return; }

  closePostModal();
  document.getElementById('postTitle').value = '';
  document.getElementById('postBody').value = '';
  loadPosts();
}

// Q&Aè©³ç´°
async function openQaDetail(id) {
  const { data: post, error } = await db.from('posts').select('*').eq('id', id).single();
  if (error || !post) return;

  const answers = Array.isArray(post.answers) ? post.answers : [];
  const ansHtml = !answers.length
    ? '<p style="color:#aaa;font-size:0.85rem;text-align:center;padding:1rem 0;">ã¾ã å›ç­”ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æœ€åˆã«å›ç­”ã—ã‚ˆã†ï¼</p>'
    : answers.map(a => `<div class="answer-item"><div class="answer-meta"><span class="answer-author">@${escHtml(a.author)}</span>${a.best?'<span class="best-badge">âœ… ãƒ™ã‚¹ãƒˆã‚¢ãƒ³ã‚µãƒ¼</span>':''}<span class="answer-time">${a.time}</span></div><div class="answer-text">${escHtml(a.text)}</div></div>`).join('');

  document.getElementById('qa-detail-content').innerHTML = `
    <div class="qa-detail">
      <div class="qa-question-box">
        <div class="q-label">â“ è³ªå•</div>
        <div class="q-text">${escHtml(post.title)}</div>
        <div style="font-size:0.85rem;color:var(--gray);margin-top:0.6rem;line-height:1.7">${escHtml(post.body)}</div>
        <div style="font-size:0.75rem;color:#aaa;margin-top:0.5rem">@${escHtml(post.author)} Â· ${formatTime(post.created_at)}${post.faculty?' Â· '+FACULTIES[post.faculty]:''}</div>
      </div>
      <div class="answers-section"><h4>ğŸ’¬ å›ç­” ${answers.length}ä»¶</h4>${ansHtml}</div>
      <div class="answer-input-area">
        <h4>âœï¸ å›ç­”ã™ã‚‹</h4>
        <textarea class="form-textarea" id="answerInput-${id}" placeholder="ã‚ãªãŸã®çŸ¥è­˜ã‚„çµŒé¨“ã‚’ã‚·ã‚§ã‚¢ã—ã¦ãã ã•ã„..." style="margin-bottom:0.7rem"></textarea>
        <button class="btn-submit" style="margin-top:0" onclick="submitAnswer(${id})">å›ç­”ã‚’æŠ•ç¨¿</button>
      </div>
    </div>`;
  document.getElementById('qaModal').classList.add('open');
}

function closeQaModal() { document.getElementById('qaModal').classList.remove('open'); }

async function submitAnswer(postId) {
  const input = document.getElementById('answerInput-' + postId);
  const text = input.value.trim();
  if (!text) { alert('å›ç­”ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

  const { data: post } = await db.from('posts').select('answers').eq('id', postId).single();
  const answers = Array.isArray(post?.answers) ? post.answers : [];
  answers.push({ id: Date.now(), author: currentUser, time: 'ãŸã£ãŸä»Š', text, best: false });

  const { error } = await db.from('posts').update({ answers, solved: true }).eq('id', postId);
  if (error) { alert('å›ç­”ã®æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ'); return; }

  input.value = '';
  openQaDetail(postId);
  loadPosts();
}

// ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
document.getElementById('postModal').addEventListener('click', e => { if (e.target===document.getElementById('postModal')) closePostModal(); });
document.getElementById('qaModal').addEventListener('click', e => { if (e.target===document.getElementById('qaModal')) closeQaModal(); });
document.getElementById('nicknameModal').addEventListener('click', e => { if (e.target===document.getElementById('nicknameModal')) closeNicknameModal(); });

// åˆæœŸåŒ–
updateNicknameBadge();
loadPosts();
</script>
</body>
</html>
