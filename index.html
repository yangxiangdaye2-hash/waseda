<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ワセダノート - 早稲田生の情報共有掲示板</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root {
    --crimson: #8B0000; --crimson-light: #A50000; --crimson-dark: #700000; --crimson-pale: #f9f0f0;
    --gold: #C8A951; --gold-light: #e8c96a; --gold-dark: #b8941f;
    --dark: #1a1a1a; --gray: #6b6b6b; --gray-light: #9a9a9a; --gray-lighter: #d5d5d5;
    --white: #ffffff; --border: #e8e0e0; --bg: #faf8f8; --bg-light: #ffffff;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Noto Sans JP', sans-serif; background: var(--bg); color: var(--dark); min-height: 100vh; line-height: 1.6; }

  header { background: linear-gradient(135deg, var(--crimson) 0%, var(--crimson-dark) 100%); padding: 0 2rem; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 25px rgba(139, 0, 0, 0.25); }
  .header-inner { max-width: 1200px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; height: 70px; }
  .logo { display: flex; align-items: baseline; gap: 10px; text-decoration: none; transition: transform 0.2s ease; }
  .logo:hover { transform: scaleX(1.02); }
  .logo-jp { font-size: 1.5rem; font-weight: 900; color: var(--white); letter-spacing: 0.06em; }
  .logo-en { font-family: 'Playfair Display', serif; font-size: 0.75rem; color: var(--gold-light); letter-spacing: 0.15em; }
  .header-right { display: flex; align-items: center; gap: 1rem; }
  .nickname-badge { background: rgba(255,255,255,0.18); border: 1.5px solid rgba(255,255,255,0.4); color: white; padding: 7px 16px; border-radius: 25px; font-size: 0.82rem; cursor: pointer; transition: all 0.2s; font-weight: 500; }
  .nickname-badge:hover { background: rgba(255,255,255,0.25); border-color: rgba(255,255,255,0.6); }
  .btn-post { background: var(--gold); color: var(--crimson); border: none; padding: 9px 22px; border-radius: 8px; font-weight: 700; font-size: 0.88rem; cursor: pointer; font-family: 'Noto Sans JP', sans-serif; transition: all 0.2s; box-shadow: 0 2px 8px rgba(200, 169, 81, 0.25); }
  .btn-post:hover { background: var(--gold-light); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(200, 169, 81, 0.35); }

  .hero { background: linear-gradient(135deg, var(--crimson) 0%, var(--crimson-dark) 100%); padding: 3rem 2rem 2.5rem; text-align: center; }
  .hero h1 { font-size: 1.35rem; color: var(--white); letter-spacing: 0.05em; margin-bottom: 0.6rem; font-weight: 700; line-height: 1.5; }
  .hero p { color: rgba(255,255,255,0.8); font-size: 0.95rem; margin-bottom: 1.6rem; font-weight: 400; }
  .search-bar { max-width: 700px; margin: 0 auto; display: flex; gap: 10px; }
  .search-input { flex: 1; border: none; border-radius: 10px; padding: 12px 18px; font-size: 0.95rem; font-family: 'Noto Sans JP', sans-serif; outline: none; transition: box-shadow 0.2s; }
  .search-input:focus { box-shadow: 0 0 0 4px rgba(200, 169, 81, 0.2); }
  .search-btn { background: var(--gold); border: none; border-radius: 10px; padding: 0 24px; font-size: 1.1rem; cursor: pointer; transition: all 0.2s; font-weight: 700; }
  .search-btn:hover { background: var(--gold-light); transform: scale(1.05); }

  .faculty-bar { background: var(--white); border-bottom: 2px solid #f0ede0; padding: 1rem 2rem; overflow-x: auto; -webkit-overflow-scrolling: touch; }
  .faculty-bar-inner { max-width: 1200px; margin: 0 auto; display: flex; gap: 10px; white-space: nowrap; align-items: center; }
  .faculty-label { font-size: 0.8rem; color: var(--gray); font-weight: 700; margin-right: 8px; flex-shrink: 0; letter-spacing: 0.05em; }
  .faculty-chip { padding: 8px 16px; border-radius: 25px; font-size: 0.8rem; font-weight: 600; cursor: pointer; border: 1.5px solid var(--border); background: white; color: var(--gray); transition: all 0.25s; white-space: nowrap; font-family: 'Noto Sans JP', sans-serif; }
  .faculty-chip:hover { border-color: var(--crimson); color: var(--crimson); background: var(--crimson-pale); }
  .faculty-chip.active { background: var(--crimson); color: white; border-color: var(--crimson); font-weight: 700; box-shadow: 0 2px 8px rgba(139, 0, 0, 0.2); }

  .tabs { background: var(--white); border-bottom: 3px solid #f0ede0; position: sticky; top: 70px; z-index: 90; box-shadow: 0 2px 12px rgba(0,0,0,0.08); overflow-x: auto; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
  .tabs::-webkit-scrollbar { display: none; }
  .tabs-inner { max-width: 1200px; margin: 0 auto; display: flex; gap: 0; padding: 0 2rem; }
  .tab { padding: 15px 18px; font-size: 0.95rem; font-weight: 600; color: var(--gray); cursor: pointer; border-bottom: 3px solid transparent; margin-bottom: -3px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); white-space: nowrap; letter-spacing: 0.02em; user-select: none; position: relative; }
  .tab:hover { color: var(--crimson); background: rgba(139, 0, 0, 0.04); }
  .tab.active { color: var(--crimson); border-bottom-color: var(--crimson); font-weight: 700; }


    .main { max-width: 1200px; margin: 0 auto; padding: 2.5rem 2rem; display: grid; grid-template-columns: 1fr 320px; gap: 2.5rem; }

    .search-banner { background: linear-gradient(135deg, rgba(139,0,0,0.08) 0%, rgba(200,169,81,0.08) 100%); border: 1.5px solid rgba(139,0,0,0.15); border-radius: 12px; padding: 14px 18px; margin-bottom: 1.5rem; font-size: 0.9rem; color: var(--crimson); display: none; align-items: center; justify-content: space-between; font-weight: 500; }
    .search-banner.show { display: flex; }
    .clear-search { cursor: pointer; font-weight: 700; font-size: 0.85rem; transition: color 0.2s; }
    .clear-search:hover { color: var(--crimson-dark); }

    .posts-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; gap: 1.5rem; }
    .posts-header h2 { font-size: 1.3rem; font-weight: 700; color: var(--dark); letter-spacing: 0.02em; }
    .posts-header-controls { display: flex; gap: 1rem; align-items: center; }
    .sort-select { border: 1.5px solid var(--border); padding: 8px 14px; border-radius: 8px; font-size: 0.88rem; color: var(--gray); background: white; cursor: pointer; font-family: 'Noto Sans JP', sans-serif; font-weight: 500; transition: all 0.2s; }
    .sort-select:hover { border-color: var(--crimson); color: var(--dark); }
    .sort-select:focus { outline: none; border-color: var(--crimson); box-shadow: 0 0 0 3px rgba(139, 0, 0, 0.1); }

    .post-card { background: white; border: 1px solid var(--border); border-left: 4px solid var(--gold); border-radius: 12px; padding: 1.6rem 1.8rem; margin-bottom: 1.3rem; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; position: relative; overflow: hidden; }
    .post-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, var(--gold), transparent); opacity: 0; transition: opacity 0.3s; }
    .post-card:hover { box-shadow: 0 8px 32px rgba(139,0,0,0.12); transform: translateY(-4px); border-left-color: var(--crimson); }
    .post-card:hover::before { opacity: 1; }
    .post-card.lecture { border-left-color: #e65100; }
    .post-card.circle { border-left-color: #2e7d32; }
    .post-card.campus { border-left-color: #1565c0; }
    .post-card.qa { border-left-color: #6a1b9a; }
    
    .post-meta { display: flex; align-items: center; gap: 12px; margin-bottom: 0.9rem; flex-wrap: wrap; }
    .category-tag { font-size: 0.72rem; font-weight: 700; padding: 5px 12px; border-radius: 20px; letter-spacing: 0.05em; }
    .faculty-tag { font-size: 0.72rem; padding: 5px 12px; border-radius: 18px; background: var(--crimson-pale); color: var(--crimson); font-weight: 600; }
    .cat-lecture { background: #fff3e0; color: #e65100; }
    .cat-circle { background: #e8f5e9; color: #2e7d32; }
    .cat-campus { background: #e3f2fd; color: #1565c0; }
    .cat-qa { background: #f3e5f5; color: #6a1b9a; }
    .author { font-size: 0.82rem; color: var(--gray); font-weight: 600; }
    .post-time { font-size: 0.78rem; color: var(--gray-light); margin-left: auto; }
    .post-title { font-size: 1.15rem; font-weight: 700; margin-bottom: 0.8rem; line-height: 1.5; color: var(--dark); letter-spacing: 0.01em; }
    .post-body { font-size: 0.92rem; color: var(--gray); line-height: 1.7; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .post-footer { display: flex; gap: 1.5rem; margin-top: 1.2rem; padding-top: 1.2rem; border-top: 1px solid #f0f0f0; }
    .post-action { display: flex; align-items: center; gap: 6px; font-size: 0.82rem; color: var(--gray-light); cursor: pointer; transition: all 0.2s; font-weight: 500; }
    .post-action:hover { color: var(--crimson); }
    .post-action.liked { color: var(--crimson); font-weight: 700; }
    .stars { color: var(--gold); font-size: 0.9rem; }

    .qa-card { background: white; border: 1.5px solid #e8d5f5; border-left: 4px solid #6a1b9a; border-radius: 12px; padding: 1.6rem 1.8rem; margin-bottom: 1.3rem; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative; }
    .qa-card:hover { box-shadow: 0 8px 32px rgba(106, 27, 154, 0.15); transform: translateY(-4px); }
    .qa-status { font-size: 0.75rem; font-weight: 700; padding: 6px 12px; border-radius: 20px; letter-spacing: 0.05em; }
    .qa-status.answered { background: #e8f5e9; color: #2e7d32; }
    .qa-status.open { background: #fff3e0; color: #e65100; }

    .loading { text-align: center; padding: 4rem 2rem; color: var(--gray); font-size: 0.95rem; }
    .loading::after { content: ''; display: inline-block; width: 20px; height: 20px; margin-left: 8px; border: 3px solid rgba(139, 0, 0, 0.1); border-top-color: var(--crimson); border-radius: 50%; animation: spin 0.8s linear infinite; vertical-align: middle; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .skeleton-card { background: white; border: 1px solid var(--border); border-radius: 12px; padding: 1.6rem 1.8rem; margin-bottom: 1.3rem; }
    .skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: loading 1.5s infinite; border-radius: 8px; }
    .skeleton-title { height: 24px; margin-bottom: 1rem; width: 70%; }
    .skeleton-text { height: 16px; margin-bottom: 0.5rem; width: 100%; }
    .skeleton-text:last-child { width: 85%; }
    @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    
    .empty-tab { text-align: center; padding: 5rem 2rem 4rem; color: var(--gray); }
    .empty-icon { font-size: 4rem; margin-bottom: 1.5rem; opacity: 0.8; }
    .empty-title { font-size: 1.2rem; font-weight: 700; margin-bottom: 0.8rem; color: var(--dark); }
    .empty-text { font-size: 0.95rem; margin-bottom: 2rem; color: var(--gray-light); line-height: 1.6; }
    .empty-action { display: inline-block; background: var(--gold); color: var(--dark); padding: 10px 24px; border-radius: 8px; font-weight: 700; cursor: pointer; text-decoration: none; transition: all 0.2s; }
    .empty-action:hover { background: var(--gold-light); transform: translateY(-2px); }

    .sidebar { display: flex; flex-direction: column; gap: 2rem; }
    .sidebar-card { background: white; border: 1px solid var(--border); border-radius: 14px; overflow: hidden; transition: all 0.3s; }
    .sidebar-card:hover { box-shadow: 0 4px 20px rgba(139, 0, 0, 0.08); }
    .sidebar-card-header { background: linear-gradient(135deg, var(--crimson) 0%, var(--crimson-dark) 100%); padding: 14px 16px; color: white; font-size: 0.9rem; font-weight: 700; letter-spacing: 0.05em; }
    .sidebar-card-body { padding: 1.4rem 1.2rem; }

    /* category tabs inside trend card */
    .trend-tabs { display: flex; gap: 0.6rem; margin-bottom: 0.8rem; overflow-x: auto; white-space: nowrap; padding-bottom: 0.2rem; }
    .trend-tab {
      flex: none;
      display: inline-block;
      padding: 6px 10px;
      font-size: 0.9rem;
      font-weight: 700;
      background: white;
      color: var(--crimson);
      border: 2px solid var(--crimson);
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s, color 0.2s, transform 0.1s;
      text-align: center;
      white-space: nowrap;
    }
    .trend-tab:hover {
      background: var(--crimson);
      color: white;
      transform: translateY(-1px);
    }
    .trend-tab.active {
      background: var(--crimson-dark);
      color: white;
      border-color: var(--crimson-dark);
    }

    /* on very narrow screens allow two rows so QA is never off-screen */
    @media (max-width: 500px) {
      .trend-tabs { white-space: normal; }
      .trend-tab { flex: 1 1 calc(50% - 0.6rem); padding: 5px 8px; font-size: 0.85rem; }
    }

    .trend-item { display: flex; align-items: flex-start; gap: 12px; padding: 0.75rem 0; border-bottom: 1px solid #f5f5f5; cursor: pointer; transition: all 0.2s; }
    .trend-item:hover { padding-left: 4px; color: var(--crimson); }
    .trend-item:last-child { border-bottom: none; }
    .trend-item-content { flex: 1; display: flex; flex-direction: column; gap: 4px; }
    .trend-num { font-size: 1.3rem; font-weight: 900; color: var(--gold); min-width: 24px; font-family: 'Playfair Display', serif; }
    .trend-text { font-size: 0.85rem; color: var(--dark); line-height: 1.5; font-weight: 500; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
    .trend-likes { font-size: 0.75rem; color: var(--gray-light); font-weight: 600; }
    .trend-loading { text-align: center; padding: 1rem 0; color: var(--gray); font-size: 0.9rem; }
    .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .stat-box { text-align: center; padding: 1.2rem 0.8rem; background: linear-gradient(135deg, rgba(139,0,0,0.05) 0%, rgba(200,169,81,0.05) 100%); border-radius: 10px; transition: all 0.2s; }
    .stat-box:hover { background: linear-gradient(135deg, rgba(139,0,0,0.08) 0%, rgba(200,169,81,0.08) 100%); }
    .stat-num { font-size: 1.6rem; font-weight: 900; color: var(--crimson); font-family: 'Playfair Display', serif; }
    .stat-label { font-size: 0.75rem; color: var(--gray); margin-top: 6px; font-weight: 600; letter-spacing: 0.05em; }

    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.55); z-index: 1000; align-items: center; justify-content: center; padding: 1.5rem; backdrop-filter: blur(2px); }
    .modal-overlay.open { display: flex; animation: fadeIn 0.25s ease; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .modal { background: white; border-radius: 18px; width: 100%; max-width: 580px; overflow: hidden; animation: slideUp 0.35s cubic-bezier(0.4, 0, 0.2, 1); max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); }
    .modal-wide { max-width: 680px; }
    @keyframes slideUp { from { transform: translateY(40px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .modal-header { background: linear-gradient(135deg, var(--crimson) 0%, var(--crimson-dark) 100%); padding: 1.5rem 1.8rem; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1; box-shadow: 0 2px 8px rgba(139, 0, 0, 0.15); }
    .modal-header h3 { color: white; font-size: 1.1rem; font-weight: 700; }
    .modal-close { color: white; background: rgba(255,255,255,0.2); border: none; font-size: 1.5rem; cursor: pointer; line-height: 1; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 8px; transition: all 0.2s; }
    .modal-close:hover { background: rgba(255,255,255,0.35); }
    .modal-body { padding: 2rem; }
    .form-group { margin-bottom: 1.4rem; }
    .form-label { display: block; font-size: 0.85rem; font-weight: 700; color: var(--dark); margin-bottom: 0.55rem; letter-spacing: 0.02em; }
    .form-input, .form-select, .form-textarea { width: 100%; border: 1.5px solid var(--border); border-radius: 10px; padding: 11px 14px; font-size: 0.95rem; font-family: 'Noto Sans JP', sans-serif; color: var(--dark); outline: none; background: white; transition: all 0.2s; }
    .form-input:hover, .form-select:hover, .form-textarea:hover { border-color: var(--gray-lighter); }
    .form-input:focus, .form-select:focus, .form-textarea:focus { border-color: var(--crimson); box-shadow: 0 0 0 4px rgba(139, 0, 0, 0.1); }
    .form-textarea { resize: vertical; min-height: 110px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1.2rem; }
    .btn-submit { width: 100%; background: linear-gradient(135deg, var(--crimson) 0%, var(--crimson-dark) 100%); color: white; border: none; padding: 12px; border-radius: 10px; font-size: 0.98rem; font-weight: 700; cursor: pointer; font-family: 'Noto Sans JP', sans-serif; margin-top: 0.8rem; transition: all 0.2s; box-shadow: 0 4px 12px rgba(139, 0, 0, 0.25); }
    .btn-submit:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(139, 0, 0, 0.35); }
    .btn-submit:disabled { background: var(--gray-lighter); cursor: not-allowed; transform: none; }

    .qa-detail { padding: 2rem; }
    .qa-question-box { background: linear-gradient(135deg, #f8f3ff 0%, #f3f0ff 100%); border-left: 5px solid #7b1fa2; border-radius: 0 12px 12px 0; padding: 1.5rem 1.6rem; margin-bottom: 2rem; box-shadow: 0 2px 12px rgba(123, 31, 162, 0.08); }
    .qa-question-box .q-label { font-size: 0.78rem; font-weight: 700; color: #7b1fa2; margin-bottom: 0.7rem; letter-spacing: 0.05em; }
    .qa-question-box .q-text { font-size: 1.05rem; font-weight: 700; color: var(--dark); line-height: 1.6; }
    .answers-section h4 { font-size: 1rem; font-weight: 700; margin-bottom: 1.5rem; color: var(--dark); }
    .answer-item { background: white; border: 1.5px solid var(--border); border-radius: 12px; padding: 1.4rem; margin-bottom: 1rem; transition: all 0.2s; }
    .answer-item:hover { box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08); }
    .answer-meta { display: flex; gap: 10px; margin-bottom: 0.8rem; align-items: center; flex-wrap: wrap; }
    .answer-author { font-size: 0.85rem; font-weight: 700; color: var(--dark); }
    .answer-time { font-size: 0.78rem; color: var(--gray-light); }
    .best-badge { font-size: 0.72rem; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); color: #2e7d32; padding: 4px 10px; border-radius: 12px; font-weight: 700; }
    .answer-text { font-size: 0.92rem; color: var(--gray); line-height: 1.8; }
    .answer-input-area { margin-top: 1.5rem; border-top: 2px solid #f5f5f5; padding-top: 1.5rem; }
    .answer-input-area h4 { font-size: 0.95rem; font-weight: 700; margin-bottom: 1rem; }

    .post-detail { padding: 2rem; }
    .post-detail-header { display: flex; align-items: center; gap: 10px; margin-bottom: 1.5rem; flex-wrap: wrap; }
    .post-detail-meta { font-size: 0.85rem; font-weight: 600; color: var(--gray); }
    .post-detail-time { font-size: 0.78rem; color: var(--gray-light); }
    .post-detail-title { font-size: 1.4rem; font-weight: 700; color: var(--dark); margin-bottom: 1.5rem; line-height: 1.6; }
    .post-detail-body { font-size: 0.95rem; color: var(--gray); line-height: 1.8; margin-bottom: 1.5rem; }
    .post-detail-stats { display: flex; gap: 2rem; padding: 1.2rem; background: linear-gradient(135deg, rgba(139,0,0,0.05) 0%, rgba(200,169,81,0.05) 100%); border-radius: 10px; margin-bottom: 2rem; font-weight: 600; }
    
    .comments-section h4 { font-size: 1rem; font-weight: 700; margin-bottom: 1.5rem; color: var(--dark); }
    .comment-item { background: #f9f9f9; border: 1px solid var(--border); border-radius: 10px; padding: 1.2rem; margin-bottom: 1rem; transition: all 0.2s; }
    .comment-item:hover { background: white; box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06); }
    .comment-meta { display: flex; gap: 8px; margin-bottom: 0.7rem; align-items: center; flex-wrap: wrap; }
    .comment-author { font-size: 0.82rem; font-weight: 700; color: var(--dark); }
    .comment-time { font-size: 0.75rem; color: var(--gray-light); }
    .comment-text { font-size: 0.9rem; color: var(--gray); line-height: 1.6; }
    .comment-input-area { margin-top: 1.5rem; border-top: 2px solid #f5f5f5; padding-top: 1.5rem; }
    .comment-input-area h5 { font-size: 0.9rem; font-weight: 700; margin-bottom: 0.8rem; color: var(--dark); }

    /* ニックネーム設定モーダル */
    .nickname-modal { max-width: 420px; }

    /* stack sidebar above posts on tablets/phones up to ~992px */
    @media (max-width: 992px) {
      .header-inner { height: 60px; padding: 0; }
      .logo-jp { font-size: 1.2rem; }
      .header-right { gap: 0.6rem; }
      .nickname-badge { padding: 5px 12px; font-size: 0.75rem; }
      .btn-post { padding: 6px 14px; font-size: 0.78rem; }
      
      .hero h1 { font-size: 1.1rem; margin-bottom: 0.5rem; }
      .hero p { font-size: 0.85rem; margin-bottom: 1.2rem; }
      
      .faculty-bar-inner { gap: 6px; }
      .faculty-label { font-size: 0.7rem; margin-right: 0; }
      .faculty-chip { padding: 6px 12px; font-size: 0.75rem; }
      
      .tabs-inner { max-width: none; padding: 0 1rem; }
      .tab { padding: 12px 14px; font-size: 0.85rem; }
      
      /* make main a flex column and reverse order so sidebar shows before posts */
      .main {
        display: flex;
        flex-direction: column-reverse;
        padding: 1.5rem 1rem;
        gap: 1.5rem;
      }
      /* sidebar remains visible so trending stays accessible */
      
      .posts-header { flex-direction: column; align-items: flex-start; }
      .posts-header h2 { font-size: 1.1rem; }
      
      .post-card { border-left: 3px solid var(--gold); padding: 1.2rem 1.4rem; margin-bottom: 1rem; }
      .post-title { font-size: 1rem; }
      .post-body { font-size: 0.85rem; }
      .post-meta { gap: 8px; }
      .category-tag { font-size: 0.65rem; padding: 4px 10px; }
      .faculty-tag { font-size: 0.65rem; padding: 4px 10px; }
      
      .form-row { grid-template-columns: 1fr; gap: 1rem; }
      
      .modal-body { padding: 1.5rem; }
    }
    
    @media (max-width: 480px) {
      .hero { padding: 2rem 1.5rem 1.5rem; }
      .hero h1 { font-size: 0.95rem; }
      .search-bar { gap: 6px; }
      .search-input { padding: 10px 14px; font-size: 0.9rem; }
      
      .main { padding: 1rem; }
      .post-card { padding: 1rem; }
      .posts-footer { gap: 0.8rem; }
      .post-action { font-size: 0.75rem; }
      
      .modal-body { padding: 1.2rem; }
      .form-label { font-size: 0.8rem; }
    }
  </style>
  </head>
  <body>

  <header>
    <div class="header-inner">
      <a class="logo" href="#"><span class="logo-jp">ワセダノート</span><span class="logo-en">WASEDA NOTE</span></a>
      <div class="header-right">
        <div class="nickname-badge" id="nicknameBadge" onclick="openNicknameModal()">👤 設定中...</div>
        <button class="btn-post" onclick="openPostModal()">＋ 投稿する</button>
      </div>
    </div>
  </header>

  <div class="hero">
    <h1>早稲田生のための、早稲田生による情報共有</h1>
    <p>授業の口コミ・サークル・キャンパスライフをみんなでシェアしよう</p>
    <div class="search-bar">
      <input class="search-input" type="text" id="searchInput" placeholder="🔍 授業名・キーワードで検索..." onkeydown="if(event.key==='Enter')doSearch()">
      <button class="search-btn" onclick="doSearch()">検索</button>
    </div>
  </div>

  <div class="faculty-bar">
    <div class="faculty-bar-inner">
      <span class="faculty-label">学部：</span>
      <button class="faculty-chip active" onclick="selectFaculty('all',this)">すべて</button>
      <button class="faculty-chip" onclick="selectFaculty('seikei',this)">政治経済</button>
      <button class="faculty-chip" onclick="selectFaculty('ho',this)">法</button>
      <button class="faculty-chip" onclick="selectFaculty('shogaku',this)">商</button>
      <button class="faculty-chip" onclick="selectFaculty('kyoiku',this)">教育</button>
      <button class="faculty-chip" onclick="selectFaculty('bun',this)">文</button>
      <button class="faculty-chip" onclick="selectFaculty('bunkagaku',this)">文化構想</button>
      <button class="faculty-chip" onclick="selectFaculty('kiso',this)">基幹理工</button>
      <button class="faculty-chip" onclick="selectFaculty('sozo',this)">創造理工</button>
      <button class="faculty-chip" onclick="selectFaculty('sentan',this)">先進理工</button>
      <button class="faculty-chip" onclick="selectFaculty('ningen',this)">人間科学</button>
      <button class="faculty-chip" onclick="selectFaculty('sports',this)">スポーツ科学</button>
      <button class="faculty-chip" onclick="selectFaculty('kokusai',this)">国際教養</button>
      <button class="faculty-chip" onclick="selectFaculty('shakou',this)">社会科学</button>
    </div>
  </div>

  <div class="tabs">
    <div class="tabs-inner">
      <div class="tab active" onclick="switchTab('all',this)">📋 すべて</div>
      <div class="tab" onclick="switchTab('lecture',this)">📚 授業口コミ</div>
      <div class="tab" onclick="switchTab('circle',this)">🎯 サークル</div>
      <div class="tab" onclick="switchTab('campus',this)">🏫 キャンパスライフ</div>
      <div class="tab" onclick="switchTab('qa',this)">❓ Q&amp;A</div>
    </div>
  </div>

  <div class="main">
    <div class="posts-section">
      <div id="search-banner" class="search-banner">
        <span id="search-banner-text"></span>
        <span class="clear-search" onclick="clearSearch()">✕ クリア</span>
      </div>
      <div class="posts-header">
        <h2 id="section-title">新着投稿</h2>
        <div class="posts-header-controls">
          <button class="btn-post" id="categoryPostBtn" style="margin: 0;" onclick="openPostModalWithCategory()">＋ 投稿する</button>
          <select class="sort-select" id="sortSelect" onchange="updateSort()"><option value="newest">新着順</option><option value="popular">人気順（いいね数）</option></select>
        </div>
      </div>
      <div id="posts-container"><div class="loading">読み込み中...</div></div>
    </div>

    <aside class="sidebar">
      <div class="sidebar-card">
        <div class="sidebar-card-header">🔥 トレンド</div>
        <div class="sidebar-card-body">
          <div class="trend-tabs">
            <button class="trend-tab active" data-cat="lecture">授業口コミ</button>
            <button class="trend-tab" data-cat="circle">サークル</button>
            <button class="trend-tab" data-cat="campus">キャンパスライフ</button>
            <button class="trend-tab" data-cat="qa">Q&amp;A</button>
          </div>
          <div id="trendContainer"><div class="trend-loading">読み込み中...</div></div>
        </div>
      </div>
    </aside>
  </div>

  <!-- 投稿モーダル -->
  <div class="modal-overlay" id="postModal">
    <div class="modal">
      <div class="modal-header">
        <h3>✏️ 新規投稿</h3>
        <button class="modal-close" onclick="closePostModal()">×</button>
      </div>
      <div class="modal-body">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">カテゴリ</label>
            <select class="form-select" id="postCategory" onchange="onCategoryChange(this)">
              <option value="lecture">📚 授業口コミ</option>
              <option value="circle">🎯 サークル情報</option>
              <option value="campus">🏫 キャンパスライフ</option>
              <option value="qa">❓ Q&amp;A（質問）</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">学部</label>
            <select class="form-select" id="postFaculty">
              <option value="">学部を選択（任意）</option>
              <option value="seikei">政治経済学部</option>
              <option value="ho">法学部</option>
              <option value="shogaku">商学部</option>
              <option value="kyoiku">教育学部</option>
              <option value="bun">文学部</option>
              <option value="bunkagaku">文化構想学部</option>
              <option value="kiso">基幹理工学部</option>
              <option value="sozo">創造理工学部</option>
              <option value="sentan">先進理工学部</option>
              <option value="ningen">人間科学部</option>
              <option value="sports">スポーツ科学部</option>
              <option value="kokusai">国際教養学部</option>
              <option value="shakou">社会科学部</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label" id="title-label">タイトル</label>
          <input class="form-input" type="text" id="postTitle" placeholder="例：政治経済学の授業について">
        </div>
        <div class="form-group">
          <label class="form-label" id="body-label">内容</label>
          <textarea class="form-textarea" id="postBody" placeholder="詳しい内容を書いてください..."></textarea>
        </div>
        <div class="form-group" id="lectureExtra" style="display:none;">
          <label class="form-label">授業評価</label>
          <select class="form-select" id="postStars">
            <option value="5">⭐⭐⭐⭐⭐ とても良い</option>
            <option value="4">⭐⭐⭐⭐ 良い</option>
            <option value="3">⭐⭐⭐ 普通</option>
            <option value="2">⭐⭐ 微妙</option>
            <option value="1">⭐ 良くない</option>
          </select>
        </div>
        <button class="btn-submit" id="submitBtn" onclick="submitPost()">投稿する</button>
      </div>
    </div>
  </div>

  <!-- 投稿詳細モーダル（コメント表示用） -->
  <div class="modal-overlay" id="postDetailModal">
    <div class="modal modal-wide">
      <div class="modal-header">
        <h3 id="detailModalTitle">投稿詳細</h3>
        <button class="modal-close" onclick="closePostDetailModal()">×</button>
      </div>
      <div id="post-detail-content"></div>
    </div>
  </div>

  <!-- Q&Aモーダル -->
  <div class="modal-overlay" id="qaModal">
    <div class="modal modal-wide">
      <div class="modal-header">
        <h3>❓ Q&amp;A スレッド</h3>
        <button class="modal-close" onclick="closeQaModal()">×</button>
      </div>
      <div id="qa-detail-content"></div>
    </div>
  </div>

  <!-- ニックネームモーダル -->
  <div class="modal-overlay" id="nicknameModal">
    <div class="modal nickname-modal">
      <div class="modal-header">
        <h3>👤 ニックネーム設定</h3>
        <button class="modal-close" onclick="closeNicknameModal()">×</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">ニックネーム</label>
          <input class="form-input" type="text" id="nicknameInput" placeholder="例：waseda_taro" maxlength="20">
        </div>
        <button class="btn-submit" onclick="saveNickname()">保存する</button>
      </div>
    </div>
  </div>

  <script>
  // Supabase初期化（CDNのエクスポートの違いに対応する）
  const SUPABASE_URL = 'https://hazntivymzywhowtdtcc.supabase.co';
  const SUPABASE_ANON_KEY = 'sb_publishable_Mr1wt5ZOoLtmYqPEoIKeUw_cM4ZPSbN';
  let db;
  try {
    if (typeof createClient === 'function') {
      db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    } else if (window.supabase && typeof window.supabase.createClient === 'function') {
      db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    } else {
      throw new Error('Supabase client not found');
    }
  } catch (e) {
    console.error('Supabase init error:', e);
  }

  const FACULTIES = {
    seikei:'政治経済学部', ho:'法学部', shogaku:'商学部', kyoiku:'教育学部',
    bun:'文学部', bunkagaku:'文化構想学部', kiso:'基幹理工学部', sozo:'創造理工学部',
    sentan:'先進理工学部', ningen:'人間科学部', sports:'スポーツ科学部',
    kokusai:'国際教養学部', shakou:'社会科学部'
  };

  let currentTab = 'all';
  let currentFaculty = 'all';
  let currentSort = 'newest';
  let currentTrendCategory = 'lecture';
  let searchQuery = '';
  let currentUser = localStorage.getItem('waseda_nickname') || 'ゲスト';
  let allPosts = [];
  let answersCountMap = {};

  // ニックネーム
  function updateNicknameBadge() { document.getElementById('nicknameBadge').textContent = '👤 ' + currentUser; }
  function openNicknameModal() { document.getElementById('nicknameInput').value = currentUser; document.getElementById('nicknameModal').classList.add('open'); }
  function closeNicknameModal() { document.getElementById('nicknameModal').classList.remove('open'); }
  function saveNickname() { const val = document.getElementById('nicknameInput').value.trim(); if (!val) { alert('ニックネームを入力してください'); return; } currentUser = val; localStorage.setItem('waseda_nickname', val); updateNicknameBadge(); closeNicknameModal(); }

  // 投稿取得
  async function loadPosts() {
    const container = document.getElementById('posts-container');
    container.innerHTML = '<div class="loading">読み込み中...</div>';
    try {
      let query = db.from('posts').select('*');
      if (currentTab !== 'all') query = query.eq('category', currentTab);
      if (currentFaculty !== 'all') query = query.eq('faculty', currentFaculty);
      if (searchQuery) query = query.or(`title.ilike.%${searchQuery}%,body.ilike.%${searchQuery}%`);

      // ソート処理
      if (currentSort === 'popular') {
        query = query.order('likes', { ascending: false });
      } else {
        query = query.order('created_at', { ascending: false });
      }

      const { data, error } = await query;
      if (error) throw error;
      allPosts = data || [];

      // answers 件数を別テーブルから取得
      answersCountMap = {};
      try {
        const ids = allPosts.map(p => p.id).filter(Boolean);
        if (ids.length && db) {
          const { data: ansRows, error: ansErr } = await db.from('answers').select('post_id').in('post_id', ids);
          if (!ansErr && Array.isArray(ansRows)) ansRows.forEach(r => { answersCountMap[r.post_id] = (answersCountMap[r.post_id] || 0) + 1; });
        }
      } catch (e) { console.warn('answers count fetch failed', e); }

      renderPosts(allPosts);
      if (currentTab === 'all') loadTrendingPosts(currentTrendCategory);
    } catch (err) {
      console.error(err);
      container.innerHTML = '<div class="empty-tab"><div class="empty-icon">⚠️</div><div class="empty-title">データ読み込みエラー</div><div class="empty-text">申し訳ございません。データの取得に失敗しました。</div></div>';
    }
  }


  // トレンドポスト取得と描画
  async function loadTrendingPosts(category = currentTrendCategory) {
    try {
      if (!db) throw new Error('Supabase client not initialized');
      
      const container = document.getElementById('trendContainer');
      if (!container) return;

      // Calculate timestamp for 24 hours ago
      const now = new Date();
      const twentyFourHoursAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000).toISOString();

      // First try: get top 5 posts within 24h in the given category
      let { data: postsData, error: err1 } = await db.from('posts')
        .select('*')
        .eq('category', category)
        .gte('created_at', twentyFourHoursAgo)
        .order('likes', { ascending: false })
        .limit(5);

      // Fallback: most recent 5 posts in that category
      if (err1 || !postsData || postsData.length === 0) {
        const { data: recentData, error: err2 } = await db.from('posts')
          .select('*')
          .eq('category', category)
          .order('created_at', { ascending: false })
          .limit(5);
        if (err2) throw err2;
        postsData = recentData || [];
      }

      const posts = Array.isArray(postsData) ? postsData : [];

      if (!posts || posts.length === 0) {
        container.innerHTML = '<div style="color: var(--gray); font-size: 0.9rem; text-align: center; padding: 1rem;">投稿がまだありません</div>';
        return;
      }

      container.innerHTML = posts.map((p, idx) => {
        const title = escHtml(p.title);
        return `<div class="trend-item" onclick="scrollToPost(${JSON.stringify(p.id)})">
          <span class="trend-num">${idx + 1}</span>
          <div class="trend-item-content">
            <span class="trend-text">${title}</span>
            <span class="trend-likes">❤️ ${p.likes || 0}</span>
          </div>
        </div>`;
      }).join('');
    } catch (e) {
      console.error('loadTrendingPosts error:', e);
      const container = document.getElementById('trendContainer');
      if (container) {
        container.innerHTML = '<div style="color: var(--gray); font-size: 0.9rem; text-align: center; padding: 1rem;">投稿を読み込んでいます...</div>';
      }
    }
  }

  function switchTrendCategory(cat) {
    currentTrendCategory = cat;
    document.querySelectorAll('.trend-tab').forEach(t => {
      t.classList.toggle('active', t.getAttribute('data-cat') === cat);
    });
    const c = document.getElementById('trendContainer');
    if (c) c.innerHTML = '<div class="trend-loading">読み込み中...</div>';
    loadTrendingPosts(cat);
  }

  function setupTrendTabs() {
    document.querySelectorAll('.trend-tab').forEach(btn => {
      btn.addEventListener('click', () => switchTrendCategory(btn.getAttribute('data-cat')));
    });
  }

  // トレンドポストにスクロール・ハイライト
  function scrollToPost(postId) {
    const postElement = document.getElementById(`post-${postId}`);
    if (!postElement) {
      console.warn('Post not found:', postId);
      return;
    }

    // スクロール
    postElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

    // ハイライト効果
    postElement.style.backgroundColor = 'rgba(200, 169, 81, 0.15)';
    postElement.style.transition = 'background-color 0.3s ease';
    setTimeout(() => {
      postElement.style.backgroundColor = '';
    }, 2000);
  }

  function formatTime(ts) { const diff = Math.floor((Date.now() - new Date(ts)) / 1000); if (diff < 60) return 'たった今'; if (diff < 3600) return Math.floor(diff/60) + '分前'; if (diff < 86400) return Math.floor(diff/3600) + '時間前'; return Math.floor(diff/86400) + '日前'; }

  function renderPosts(posts) {
    const container = document.getElementById('posts-container');
    if (!posts.length) { container.innerHTML = '<div class="empty-tab"><div class="empty-icon">📭</div><div class="empty-title">まだ投稿がありません</div><div class="empty-text">このカテゴリで最初の投稿者になりませんか？<br/>あなたの経験やエピソードをシェアしてください。</div><button class="empty-action" onclick="openPostModalWithCategory()">+ 投稿を作成</button></div>'; return; }
    const catMap = { lecture:['cat-lecture','📚 授業口コミ'], circle:['cat-circle','🎯 サークル'], campus:['cat-campus','🏫 キャンパスライフ'], qa:['cat-qa','❓ Q&A'] };

    container.innerHTML = posts.map(p => {
      const [cls, label] = catMap[p.category] || ['cat-campus','その他'];
      const fTag = p.faculty ? `<span class="faculty-tag">${FACULTIES[p.faculty]||p.faculty}</span>` : '';
      const timeStr = formatTime(p.created_at);

      if (p.category === 'qa') {
        const ansCount = answersCountMap[p.id] || 0;
        const sc = p.solved ? 'answered' : 'open';
        const sl = p.solved ? '✅ 解決済み' : '🔓 回答募集中';
        return `<div class="qa-card" id="post-${p.id}" onclick='openQaDetail(${JSON.stringify(p.id)})'>
          <div class="post-meta"><span class="category-tag cat-qa">❓ Q&amp;A</span><span class="qa-status ${sc}">${sl}</span>${fTag}<span class="post-time">${timeStr}</span></div>
          <div class="post-title">${escHtml(p.title)}</div>
          <div class="post-body">${escHtml(p.body)}</div>
          <div class="post-footer">
            <span class="post-action">💬 回答 ${ansCount}件</span>
            <span class="post-action" onclick='event.stopPropagation(); likePost(${JSON.stringify(p.id)}, this)'>❤️ <span class="like-count">${p.likes||0}</span></span>
            <span class="post-action">@${escHtml(p.author)}</span>
          </div></div>`;
      }

      const stars = p.stars ? '⭐'.repeat(p.stars) : '';
      return `<div class="post-card ${p.category}" id="post-${p.id}" onclick='openPostDetail(${JSON.stringify(p.id)})'>
        <div class="post-meta"><span class="category-tag ${cls}">${label}</span>${fTag}<span class="author">@${escHtml(p.author)}</span>${stars?`<span class="stars">${stars}</span>`:''}<span class="post-time">${timeStr}</span></div>
        <div class="post-title">${escHtml(p.title)}</div>
        <div class="post-body">${escHtml(p.body)}</div>
        <div class="post-footer">
          <span class="post-action" onclick='event.stopPropagation(); likePost(${JSON.stringify(p.id)}, this)'>❤️ <span class="like-count">${p.likes||0}</span></span>
          <span class="post-action">💬 ${p.comments||0}</span>
        </div></div>`;
    }).join('');
  }

  function escHtml(str) { return String(str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

  // いいね
  async function likePost(id, el) {
    try {
      const countEl = el && el.querySelector ? el.querySelector('.like-count') : null;
      const cur = countEl ? parseInt(countEl.textContent||'0') : 0;
      const newCount = cur + 1;
      if (countEl) countEl.textContent = newCount;
      if (!db) throw new Error('Supabase client not initialized');
      const { error } = await db.from('posts').update({ likes: newCount }).eq('id', id);
      if (error) { console.error('Like update error', error); if (countEl) countEl.textContent = cur; }
    } catch (e) { console.error(e); alert('いいねの更新に失敗しました'); }
  }

  // 検索
  function doSearch() { searchQuery = document.getElementById('searchInput').value.trim(); const banner = document.getElementById('search-banner'); if (searchQuery) { banner.classList.add('show'); document.getElementById('search-banner-text').textContent = `「${searchQuery}」の検索結果`; } else { banner.classList.remove('show'); } loadPosts(); }
  function clearSearch() { searchQuery = ''; document.getElementById('searchInput').value = ''; document.getElementById('search-banner').classList.remove('show'); loadPosts(); }

  // ソート更新
  function updateSort() { currentSort = document.getElementById('sortSelect').value || 'newest'; loadPosts(); }

  // タブ・学部切替
  function switchTab(tab, el) {
    currentTab = tab;
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    const titles = { all:'新着投稿', lecture:'授業口コミ', circle:'サークル情報', campus:'キャンパスライフ', qa:'Q&A' };
    document.getElementById('section-title').textContent = titles[tab];
    loadPosts();
    const sidebar = document.querySelector('.sidebar');
    if (sidebar) sidebar.style.display = (tab === 'all' ? 'flex' : 'none');
  }
  function selectFaculty(f, el) { currentFaculty = f; document.querySelectorAll('.faculty-chip').forEach(c => c.classList.remove('active')); el.classList.add('active'); loadPosts(); }

  // 投稿モーダル
  function openPostModal() { document.getElementById('postModal').classList.add('open'); }
  function openPostModalWithCategory(category = null) {
    if (category === null) category = currentTab === 'all' ? 'lecture' : (currentTab === 'qa' ? 'qa' : currentTab);
    document.getElementById('postModal').classList.add('open');
    setTimeout(() => { const sel = document.getElementById('postCategory'); sel.value = category; onCategoryChange(sel); }, 0);
  }
  function closePostModal() { document.getElementById('postModal').classList.remove('open'); }
  function onCategoryChange(sel) { const isL = sel.value === 'lecture', isQ = sel.value === 'qa'; document.getElementById('lectureExtra').style.display = isL ? 'block' : 'none'; document.getElementById('title-label').textContent = isQ ? '質問タイトル' : 'タイトル'; document.getElementById('body-label').textContent = isQ ? '質問の詳細' : '内容'; document.getElementById('postTitle').placeholder = isQ ? '例：政経の必修登録の方法は？' : '例：マクロ経済学の口コミ'; }

  // 投稿送信
  async function submitPost() {
    const title = document.getElementById('postTitle').value.trim();
    const body = document.getElementById('postBody').value.trim();
    const category = document.getElementById('postCategory').value;
    const faculty = document.getElementById('postFaculty').value;
    if (!title || !body) { alert('タイトルと内容を入力してください'); return; }

    const btn = document.getElementById('submitBtn'); btn.disabled = true; btn.textContent = '投稿中...';
    const stars = category === 'lecture' ? parseInt(document.getElementById('postStars').value) : null;
    const newPost = { category, faculty: faculty || null, author: currentUser, title, body, likes: 0, comments: 0, stars };

    const { error } = await db.from('posts').insert([newPost]);
    btn.disabled = false; btn.textContent = '投稿する';
    if (error) { alert('投稿に失敗しました: ' + error.message); return; }

    closePostModal(); document.getElementById('postTitle').value = ''; document.getElementById('postBody').value = ''; loadPosts();
  }

  // answers テーブルから指定投稿の回答を取得するヘルパー
  async function loadAnswers(postId) {
    try { if (!db) throw new Error('Supabase client not initialized'); const { data, error } = await db.from('answers').select('*').eq('post_id', postId).order('created_at', { ascending: false }); if (error) { console.error('loadAnswers error', error); return []; } return Array.isArray(data) ? data : []; } catch (e) { console.error(e); return []; }
  }

  // Q&A詳細
  async function openQaDetail(id) {
    try {
      if (!db) throw new Error('Supabase client not initialized');
      const { data: post, error } = await db.from('posts').select('*').eq('id', id).single();
      if (error || !post) return;

      const answers = await loadAnswers(id);
      const ansHtml = !answers.length
        ? '<p style="color:#aaa;font-size:0.85rem;text-align:center;padding:1rem 0;">まだ回答がありません。最初に回答しよう！</p>'
        : answers.map(a => { const time = a.created_at ? formatTime(a.created_at) : (a.time || ''); return `<div class="answer-item"><div class="answer-meta"><span class="answer-author">@${escHtml(a.author)}</span>${a.best?'<span class="best-badge">✅ ベストアンサー</span>':''}<span class="answer-time">${time}</span></div><div class="answer-text">${escHtml(a.text)}</div></div>`; }).join('');

      document.getElementById('qa-detail-content').innerHTML = `
        <div class="qa-detail">
          <div class="qa-question-box">
            <div class="q-label">❓ 質問</div>
            <div class="q-text">${escHtml(post.title)}</div>
            <div style="font-size:0.85rem;color:var(--gray);margin-top:0.6rem;line-height:1.7">${escHtml(post.body)}</div>
            <div style="font-size:0.75rem;color:#aaa;margin-top:0.5rem">@${escHtml(post.author)} · ${formatTime(post.created_at)}${post.faculty?' · '+FACULTIES[post.faculty]:''}</div>
          </div>
          <div class="answers-section"><h4>💬 回答 ${answers.length}件</h4>${ansHtml}</div>
          <div class="answer-input-area">
            <h4>✏️ 回答する</h4>
            <textarea class="form-textarea" id="answerInput-${id}" placeholder="あなたの知識や経験をシェアしてください..." style="margin-bottom:0.7rem"></textarea>
            <button class="btn-submit" style="margin-top:0" onclick="submitAnswer(${JSON.stringify(id)})">回答を投稿</button>
          </div>
        </div>`;
      document.getElementById('qaModal').classList.add('open');
    } catch (e) { console.error(e); }
  }

  function closeQaModal() { document.getElementById('qaModal').classList.remove('open'); }

  // 投稿詳細（コメント表示）
  async function openPostDetail(postId) {
    try {
      if (!db) throw new Error('Supabase client not initialized');
      const { data: post, error } = await db.from('posts').select('*').eq('id', postId).single();
      if (error || !post || post.category === 'qa') return;

      const comments = await loadComments(postId);
      const catMap = { lecture: ['📚 授業口コミ', 'cat-lecture'], circle: ['🎯 サークル情報', 'cat-circle'], campus: ['🏫 キャンパスライフ', 'cat-campus'] };
      const [catLabel, catCls] = catMap[post.category] || ['その他', 'cat-campus'];
      const fTag = post.faculty ? `<span class="faculty-tag">${FACULTIES[post.faculty]||post.faculty}</span>` : '';
      const stars = post.stars ? '⭐'.repeat(post.stars) : '';
      const timeStr = formatTime(post.created_at);

      const cmtHtml = !comments.length
        ? '<p style="color:#aaa;font-size:0.9rem;text-align:center;padding:2rem 0;">コメントがまだありません。最初のコメントを書いてみませんか？</p>'
        : comments.map(c => `<div class="comment-item"><div class="comment-meta"><span class="comment-author">@${escHtml(c.author)}</span><span class="comment-time">${formatTime(c.created_at)}</span></div><div class="comment-text">${escHtml(c.text)}</div></div>`).join('');

      const catHtml = `<span class="category-tag ${catCls}">${catLabel}</span>`;
      document.getElementById('detailModalTitle').textContent = post.title;
      document.getElementById('post-detail-content').innerHTML = `
        <div class="post-detail">
          <div class="post-detail-header">
            ${catHtml}${fTag}<span class="post-detail-meta">@${escHtml(post.author)}</span>${stars?`<span>${stars}</span>`:''}<span class="post-detail-time">${timeStr}</span>
          </div>
          <div class="post-detail-title">${escHtml(post.title)}</div>
          <div class="post-detail-body">${escHtml(post.body)}</div>
          <div class="post-detail-stats">
            <span>❤️ ${post.likes||0}</span>
            <span>💬 ${comments.length}件のコメント</span>
          </div>
          <div class="comments-section">
            <h4>コメント</h4>
            ${cmtHtml}
            <div class="comment-input-area">
              <h5>コメントを追加</h5>
              <textarea class="form-textarea" id="commentInput-${postId}" placeholder="あなたの意見や感想をシェアしてください..." style="margin-bottom:0.7rem"></textarea>
              <button class="btn-submit" style="margin-top:0" onclick="submitComment(${JSON.stringify(postId)})">コメントを投稿</button>
            </div>
          </div>
        </div>
      `;
      document.getElementById('postDetailModal').classList.add('open');
    } catch (e) { console.error(e); }
  }

  function closePostDetailModal() { document.getElementById('postDetailModal').classList.remove('open'); }

  async function loadComments(postId) {
    try {
      if (!db) throw new Error('Supabase client not initialized');
      const { data, error } = await db.from('comments').select('*').eq('post_id', postId).order('created_at', { ascending: false });
      if (error) { console.error('loadComments error', error); return []; }
      return Array.isArray(data) ? data : [];
    } catch (e) { console.error(e); return []; }
  }

  async function submitComment(postId) {
    const input = document.getElementById(`commentInput-${postId}`);
    const text = input?.value?.trim();
    if (!text) { alert('コメントを入力してください'); return; }

    try {
      if (!db) throw new Error('Supabase client not initialized');
      const newComment = { post_id: postId, author: currentUser, text };
      const { error: insertErr } = await db.from('comments').insert([newComment]);
      if (insertErr) { alert('コメント投稿に失敗しました: ' + insertErr.message); return; }

      // posts テーブルのコメント数を更新
      const post = allPosts.find(p => p.id === postId);
      if (post) {
        const newCount = (post.comments || 0) + 1;
        await db.from('posts').update({ comments: newCount }).eq('id', postId);
        post.comments = newCount;
      }

      // モーダルを再表示
      await openPostDetail(postId);
    } catch (e) { console.error(e); alert('コメント投稿に失敗しました'); }
  }

  async function submitAnswer(postId) {
    const input = document.getElementById('answerInput-' + postId);
    const text = input.value.trim();
    if (!text) { alert('回答を入力してください'); return; }
    try {
      if (!db) throw new Error('Supabase client not initialized');
      const newAns = { post_id: postId, author: currentUser, text };
      const { data: inserted, error: insertErr } = await db.from('answers').insert([newAns]);
      if (insertErr) throw insertErr;
      input.value = '';
      openQaDetail(postId);
      loadPosts();
    } catch (e) { console.error(e); alert('回答の投稿に失敗しました'); }
  }

  // モーダル外クリックで閉じる
  document.getElementById('postModal').addEventListener('click', e => { if (e.target===document.getElementById('postModal')) closePostModal(); });
  document.getElementById('postDetailModal').addEventListener('click', e => { if (e.target===document.getElementById('postDetailModal')) closePostDetailModal(); });
  document.getElementById('qaModal').addEventListener('click', e => { if (e.target===document.getElementById('qaModal')) closeQaModal(); });
  document.getElementById('nicknameModal').addEventListener('click', e => { if (e.target===document.getElementById('nicknameModal')) closeNicknameModal(); });

  // 初期化
  updateNicknameBadge();
  setupTrendTabs();
  loadPosts();
  </script>
  </body>
  </html>
