<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ—©ç¨²ç”°å¤§å­¦ å—é¨“ç”Ÿã‚µãƒãƒ¼ãƒˆ - ãƒ¯ã‚»ãƒ€ãƒãƒ¼ãƒˆ</title>
<meta name="description" content="æ—©ç¨²ç”°å¤§å­¦ã‚’ç›®æŒ‡ã™å—é¨“ç”Ÿã®ãŸã‚ã®æƒ…å ±ã‚µã‚¤ãƒˆã€‚åœ¨å­¦ç”Ÿã®åˆæ ¼ä½“é¨“è¨˜ã€å­¦éƒ¨ç´¹ä»‹ã€å‹‰å¼·ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã€å—é¨“ç”ŸåŒå£«ã®æ²ç¤ºæ¿ãŒæƒã£ã¦ã„ã¾ã™ã€‚">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root {
    --crimson: #8B0000; --crimson-light: #A50000; --crimson-dark: #700000; --crimson-pale: #f9f0f0;
    --gold: #C8A951; --gold-light: #e8c96a;
    --dark: #1a1a1a; --gray: #6b6b6b; --gray-light: #9a9a9a; --gray-lighter: #d5d5d5;
    --white: #fff; --border: #e8e0e0; --bg: #faf8f8;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Noto Sans JP', sans-serif; background: var(--bg); color: var(--dark); line-height: 1.6; }

  /* HEADER */
  header { background: linear-gradient(135deg, var(--crimson) 0%, var(--crimson-dark) 100%); padding: 0 1.2rem; position: sticky; top: 0; z-index: 100; box-shadow: 0 3px 16px rgba(139,0,0,.3); }
  .header-inner { max-width: 1100px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; height: 58px; gap: 1rem; }
  .logo { display: flex; align-items: center; gap: 8px; text-decoration: none; flex-shrink: 0; }
  .logo-jp { font-size: 1.2rem; font-weight: 900; color: #fff; white-space: nowrap; }
  .logo-badge { font-size: .68rem; background: var(--gold); color: #1a1000; padding: 3px 9px; border-radius: 20px; font-weight: 700; white-space: nowrap; }
  .header-actions { display: flex; align-items: center; gap: .55rem; min-width: 0; }
  .btn-google-auth { background: #fff; color: #333; border: 1.5px solid #dadce0; border-radius: 18px; padding: 6px 12px; font-size: .76rem; font-weight: 700; display: inline-flex; align-items: center; gap: 6px; cursor: pointer; transition: all .2s; white-space: nowrap; }
  .btn-google-auth:hover { border-color: #c4c7cc; box-shadow: 0 1px 4px rgba(0,0,0,.1); }
  .btn-google-auth.logged-in { background: #f8f9fa; }
  .google-g { width: 18px; height: 18px; border-radius: 50%; background: conic-gradient(#4285f4 0 25%, #34a853 25% 50%, #fbbc05 50% 75%, #ea4335 75% 100%); color: #fff; font-size: 11px; line-height: 18px; text-align: center; font-weight: 900; display: inline-block; }
  .google-user-name { max-width: 90px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .btn-mypage { background: rgba(255,255,255,.14); color: #fff; border: 1.5px solid rgba(255,255,255,.35); padding: 6px 10px; border-radius: 18px; font-size: .72rem; font-weight: 700; cursor: pointer; transition: all .2s; white-space: nowrap; position: relative; }
  .btn-mypage:hover { background: rgba(255,255,255,.28); }
  .btn-mypage.has-notification::after { content: attr(data-notify-count); position: absolute; top: -7px; right: -7px; min-width: 18px; height: 18px; padding: 0 5px; border-radius: 999px; background: #ff2d55; color: #fff; font-size: .67rem; font-weight: 800; display: inline-flex; align-items: center; justify-content: center; line-height: 1; box-shadow: 0 2px 8px rgba(0,0,0,.28); border: 1.5px solid rgba(255,255,255,.85); }
  .nickname-badge { background: rgba(255,255,255,0.18); border: 1.5px solid rgba(255,255,255,0.35); color: white; padding: 6px 10px; border-radius: 20px; font-size: 0.74rem; cursor: pointer; transition: all 0.2s; font-weight: 500; white-space: nowrap; max-width: 190px; overflow: hidden; text-overflow: ellipsis; }
  .nickname-badge:hover { background: rgba(255,255,255,0.28); }
  .header-back { color: rgba(255,255,255,.75); font-size: .82rem; text-decoration: none; display: flex; align-items: center; gap: 4px; white-space: nowrap; transition: color .2s; flex-shrink: 0; }
  .header-back:hover { color: #fff; }

  /* HERO */
  .hero { background: linear-gradient(160deg, var(--crimson-dark) 0%, var(--crimson) 60%, #a52020 100%); padding: 56px 1.2rem 48px; }
  .hero-inner { max-width: 680px; margin: 0 auto; text-align: center; }
  .hero-label { display: inline-block; background: var(--gold); color: #1a1000; font-size: .72rem; font-weight: 700; padding: 4px 14px; border-radius: 20px; margin-bottom: 1rem; letter-spacing: .05em; }
  .hero-title { font-size: 1.75rem; font-weight: 900; color: #fff; line-height: 1.45; margin-bottom: .8rem; }
  .hero-sub { font-size: .92rem; color: rgba(255,255,255,.82); line-height: 1.75; margin-bottom: 1.8rem; }
  .hero-btns { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; }
  .btn-hero { padding: 11px 24px; border-radius: 8px; font-weight: 700; font-size: .88rem; text-decoration: none; cursor: pointer; transition: all .2s; display: inline-block; font-family: 'Noto Sans JP', sans-serif; border: none; }
  .btn-hero-solid { background: #fff; color: var(--crimson); }
  .btn-hero-solid:hover { background: var(--gold); color: #1a1000; }
  .btn-hero-outline { background: transparent; color: #fff; border: 2px solid rgba(255,255,255,.55); }
  .btn-hero-outline:hover { background: rgba(255,255,255,.12); border-color: #fff; }

  /* TABS */
  .tabs { background: #fff; border-bottom: 2px solid #f0ede0; position: sticky; top: 58px; z-index: 90; box-shadow: 0 2px 12px rgba(0,0,0,.08); display: flex; align-items: center; }
  .tabs-scroll-btn { flex-shrink: 0; width: 28px; min-width: 28px; height: 28px; margin-right: 0.75rem; border: 1.5px solid var(--gray-lighter); border-radius: 50%; background: #fff; color: var(--gray-light); font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: color 0.2s, border-color 0.2s, box-shadow 0.2s, opacity 0.25s, width 0.25s, min-width 0.25s, margin-right 0.25s; box-shadow: 0 1px 4px rgba(0,0,0,0.08); user-select: none; overflow: hidden; }
  .tabs-scroll-btn:hover { border-color: var(--crimson); color: var(--crimson); box-shadow: 0 2px 8px rgba(139,0,0,0.15); }
  .tabs-scroll-btn.hidden { opacity: 0; pointer-events: none; width: 0; min-width: 0; margin-right: 0; border-width: 0; }
  .tabs-inner { padding: .6rem 1rem; display: flex; flex-wrap: nowrap; gap: .6rem; max-width: 1100px; margin: 0 auto; overflow-x: auto; scroll-behavior: smooth; }
  .tabs-inner::-webkit-scrollbar { height: 3px; }
  .tabs-inner::-webkit-scrollbar-track { background: rgba(0,0,0,.05); }
  .tabs-inner::-webkit-scrollbar-thumb { background: rgba(139,0,0,.2); border-radius: 2px; }
  .tab { display: inline-block; padding: 7px 13px; font-size: .82rem; font-weight: 600; background: #fff; color: var(--crimson); border: 1.5px solid var(--crimson); border-radius: 18px; cursor: pointer; transition: all .2s; white-space: nowrap; user-select: none; flex-shrink: 0; }
  .tab:hover { background: var(--crimson-pale); }
  .tab.active { background: linear-gradient(135deg, var(--crimson) 0%, var(--crimson-dark) 100%); color: #fff; border-color: var(--crimson-dark); font-weight: 700; box-shadow: 0 2px 8px rgba(139,0,0,.2); }

  /* TAB PANELS */
  .tab-panel { display: none; }
  .tab-panel.active { display: block; }
  .panel-inner { max-width: 1100px; margin: 0 auto; padding: 40px 1.2rem 60px; }

  /* SECTION HEADER */
  .sec-eye { font-size: .72rem; font-weight: 700; color: var(--crimson); letter-spacing: .08em; text-transform: uppercase; margin-bottom: .3rem; }
  .sec-title { font-size: 1.35rem; font-weight: 900; color: var(--dark); margin-bottom: .3rem; }
  .sec-div { width: 32px; height: 3px; background: var(--crimson); border-radius: 2px; margin: .4rem 0 .9rem; }
  .sec-sub { font-size: .86rem; color: var(--gray); margin-bottom: 1.6rem; line-height: 1.65; }

  /* FILTER CHIPS */
  .filter-bar { display: flex; gap: .5rem; flex-wrap: wrap; margin-bottom: 1.4rem; }
  .chip { font-size: .75rem; font-weight: 600; padding: 5px 12px; border-radius: 20px; border: 1.5px solid var(--border); background: #fff; color: var(--gray); cursor: pointer; transition: all .2s; white-space: nowrap; }
  .chip:hover { border-color: var(--crimson); color: var(--crimson); }
  .chip.active { background: var(--crimson); color: #fff; border-color: var(--crimson-dark); }

  /* â”€â”€â”€ FACULTY CARDS â”€â”€â”€ */
  .faculty-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem; }
  .faculty-card { border: 1.5px solid var(--border); border-radius: 14px; background: #fff; overflow: hidden; transition: box-shadow .2s; }
  .faculty-card:hover { box-shadow: 0 4px 18px rgba(139,0,0,.1); }
  .faculty-card-head { padding: 1.1rem 1.1rem .7rem; cursor: pointer; }
  .faculty-campus-tag { font-size: .67rem; background: var(--crimson-pale); color: var(--crimson); padding: 2px 8px; border-radius: 4px; font-weight: 600; display: inline-block; margin-bottom: .5rem; }
  .faculty-card-name { font-size: 1rem; font-weight: 900; margin-bottom: .25rem; }
  .faculty-card-eng { font-size: .62rem; color: var(--gray-light); font-family: 'Playfair Display', serif; margin-bottom: .6rem; }
  .faculty-detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: .5rem; padding: 0 1.1rem .9rem; }
  .faculty-detail-item { background: var(--bg); border-radius: 8px; padding: .5rem .7rem; }
  .faculty-detail-label { font-size: .65rem; font-weight: 700; color: var(--crimson); margin-bottom: .15rem; letter-spacing: .03em; }
  .faculty-detail-value { font-size: .78rem; color: var(--dark); line-height: 1.5; }
  .faculty-comments-area { border-top: 1.5px solid var(--border); padding: .8rem 1.1rem; }
  .faculty-comments-title { font-size: .75rem; font-weight: 700; color: var(--gray); margin-bottom: .5rem; }
  .faculty-comment-item { font-size: .78rem; color: var(--dark); background: var(--bg); border-radius: 6px; padding: .5rem .7rem; margin-bottom: .4rem; line-height: 1.55; }
  .faculty-comment-meta { font-size: .68rem; color: var(--gray-light); margin-top: .25rem; }
  .faculty-ask-btn { display: inline-block; margin-top: .6rem; font-size: .76rem; font-weight: 700; color: var(--crimson); cursor: pointer; }
  .faculty-ask-btn:hover { text-decoration: underline; }

  /* â”€â”€â”€ Q&A (å‹‰å¼·ã‚¢ãƒ‰ãƒã‚¤ã‚¹) â”€â”€â”€ */
  .qa-grid { display: flex; flex-direction: column; gap: .7rem; }
  .qa-card { border: 1.5px solid var(--border); border-radius: 10px; background: #fff; padding: .8rem .95rem; transition: border-color .2s; }
  .qa-card:hover { border-color: var(--crimson); }
  .qa-card.my-question { border-color: var(--gold-dark); box-shadow: 0 2px 10px rgba(200,169,81,.18); background: #fffdf5; }
  .qa-list-section-title { font-size: .78rem; font-weight: 800; color: var(--gray); margin: .2rem 0 .45rem; letter-spacing: .02em; }
  .qa-card-head { display: flex; align-items: flex-start; justify-content: space-between; gap: .7rem; cursor: pointer; }
  .qa-card-main { min-width: 0; }
  .qa-card-toggle-icon { font-size: .78rem; color: var(--gray-light); line-height: 1; margin-top: .15rem; transition: transform .2s; }
  .qa-card.expanded .qa-card-toggle-icon { transform: rotate(180deg); }
  .qa-card-meta { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; margin-bottom: .35rem; }
  .qa-faculty-tag { font-size: .68rem; background: var(--crimson-pale); color: var(--crimson); padding: 2px 8px; border-radius: 4px; font-weight: 600; }
  .qa-open-badge { font-size: .68rem; background: #e8f5e9; color: #2e7d32; padding: 2px 8px; border-radius: 4px; font-weight: 600; }
  .qa-my-badge { font-size: .68rem; background: #fff8e1; color: #8a5d00; padding: 2px 8px; border-radius: 4px; font-weight: 700; }
  .qa-card-title { font-size: .9rem; font-weight: 700; margin-bottom: .1rem; line-height: 1.45; }
  .qa-card-preview { font-size: .76rem; color: var(--gray-light); overflow: hidden; display: -webkit-box; -webkit-line-clamp: 1; line-clamp: 1; -webkit-box-orient: vertical; }
  .qa-card-stats { margin-top: .45rem; display: flex; gap: .8rem; align-items: center; font-size: .74rem; color: var(--gray); font-weight: 700; }
  .qa-card-fold { display: none; margin-top: .55rem; border-top: 1px solid var(--border); padding-top: .55rem; }
  .qa-card.expanded .qa-card-fold { display: block; }
  .qa-card-body { font-size: .8rem; color: var(--gray); line-height: 1.65; }
  .qa-card-footer { margin-top: .5rem; display: flex; gap: 1rem; font-size: .74rem; color: var(--gray-light); align-items: center; justify-content: flex-end; }

  /* Q&A post form */
  .qa-form-box { background: #fff; border: 1.5px solid var(--border); border-radius: 12px; padding: 1.3rem; margin-bottom: 1.4rem; }
  .qa-form-title { font-size: .95rem; font-weight: 700; margin-bottom: 1rem; }
  .qa-post-box { position: static; top: auto; margin-bottom: 1.4rem; }
  .qa-post-box .post-form-title { margin-bottom: 0; }
  .qa-post-box .post-form-body { margin-top: 1rem; display: none !important; }
  .qa-post-box.open .post-form-body { display: block !important; }
  .auth-hint { font-size: .74rem; color: var(--gray); line-height: 1.6; margin: -.25rem 0 .9rem; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: .45rem .6rem; }
  .post-auth-options { display: flex; gap: .6rem; flex-wrap: wrap; margin-bottom: .8rem; }
  .post-auth-option { display: inline-flex; align-items: center; gap: 6px; font-size: .78rem; color: var(--dark); background: #fff; border: 1px solid var(--border); border-radius: 999px; padding: 4px 10px; }
  .post-auth-login-actions { display: none; margin: -.2rem 0 .8rem; }
  .post-auth-login-btn { width: 100%; background: linear-gradient(135deg, var(--crimson) 0%, var(--crimson-dark) 100%); color: #fff; border: none; border-radius: 10px; padding: 9px 12px; font-size: .8rem; font-weight: 800; cursor: pointer; }
  .post-auth-login-btn:hover { opacity: .95; }
  .qa-layout { display: grid; grid-template-columns: 1fr 2fr; gap: 1.5rem; align-items: start; }

  /* Q&A detail modal */
  .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.5); z-index: 200; overflow-y: auto; }
  .modal-overlay.open { display: flex; align-items: flex-start; justify-content: center; padding: 2rem 1rem; }
  .modal { background: #fff; border-radius: 16px; width: 100%; max-width: 640px; overflow: hidden; }
  .modal-header { background: linear-gradient(135deg, var(--crimson) 0%, var(--crimson-dark) 100%); padding: 1rem 1.2rem; display: flex; align-items: center; justify-content: space-between; }
  .modal-header h3 { color: #fff; font-size: 1rem; font-weight: 700; }
  .modal-close { background: none; border: none; color: rgba(255,255,255,.8); font-size: 1.4rem; cursor: pointer; line-height: 1; }
  .modal-body { padding: 1.4rem; max-height: 70vh; overflow-y: auto; }
  .qa-question-box { background: var(--crimson-pale); border-radius: 10px; padding: 1rem; margin-bottom: 1rem; }
  .q-label { font-size: .75rem; font-weight: 700; color: var(--crimson); margin-bottom: .3rem; }
  .q-text { font-size: 1rem; font-weight: 700; margin-bottom: .4rem; }
  .answers-section h4 { font-size: .9rem; font-weight: 700; margin-bottom: .6rem; color: var(--dark); }
  .answer-item { border: 1px solid var(--border); border-radius: 8px; padding: .7rem; margin-bottom: .5rem; background: var(--bg); }
  .answer-meta { display: flex; gap: 8px; align-items: center; margin-bottom: .3rem; font-size: .75rem; color: var(--gray-light); }
  .answer-like { font-size: .78rem; color: var(--gray-light); margin-left: auto; cursor: pointer; user-select: none; }
  .answer-like.liked { color: var(--crimson); font-weight: 700; }
  .answer-text { font-size: .85rem; color: var(--dark); line-height: 1.6; }
  .answer-input-area { margin-top: 1rem; padding-top: 1rem; border-top: 1.5px solid var(--border); }
  .answer-input-area h4 { font-size: .9rem; font-weight: 700; margin-bottom: .6rem; }

  /* â”€â”€â”€ BOARD â”€â”€â”€ */
  .board-layout { display: grid; grid-template-columns: 300px 1fr; gap: 1.4rem; align-items: start; }
  .post-form-box { background: transparent; border: none; border-radius: 0; padding: 0; position: sticky; top: 112px; }
  .post-form-title { display: flex; align-items: center; justify-content: flex-start; }
  .btn-post { background: var(--gold); color: var(--crimson-dark); border: none; padding: 8px 18px; border-radius: 8px; font-weight: 700; font-size: 0.85rem; cursor: pointer; font-family: 'Noto Sans JP', sans-serif; transition: all 0.2s; white-space: nowrap; }
  .btn-post:hover { background: var(--gold-light); transform: translateY(-1px); }
  .post-form-body { margin-top: 1rem; display: none; }
  .post-form-box.open .post-form-body { display: block; }
  .post-form-box.open .post-form-body {
    position: fixed;
    inset: 0;
    margin: 0;
    background: rgba(0,0,0,.55);
    z-index: 300;
    overflow-y: auto;
    padding: 1.2rem;
  }
  .post-form-body-inner {
    width: 100%;
    max-width: 640px;
    margin: 1.4rem auto;
    background: #fff;
    border: 1.5px solid var(--border);
    border-radius: 14px;
    padding: 1.3rem;
    box-shadow: 0 20px 60px rgba(0,0,0,.28);
  }
  .post-form-modal-head { display: flex; align-items: center; justify-content: space-between; gap: .8rem; margin-bottom: .9rem; }
  .post-form-modal-title { font-size: .95rem; font-weight: 700; color: var(--dark); }
  .post-form-modal-close { border: none; background: #f4f4f4; color: var(--gray); width: 30px; height: 30px; border-radius: 8px; font-size: 1.1rem; line-height: 1; cursor: pointer; }
  .post-form-modal-close:hover { background: #ececec; }
  body.post-form-open { overflow: hidden; }
  @media (max-width: 860px) {
    .post-form-title { cursor: default; }
  }
  .board-posts { display: flex; flex-direction: column; gap: .7rem; }
  .board-card { background: #fff; border: 1.5px solid var(--border); border-radius: 12px; padding: 1rem 1.1rem; transition: border-color .2s; }
  .board-card:hover { border-color: var(--gray-lighter); }
  .board-card-meta { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; margin-bottom: .45rem; }
  .board-type-tag { font-size: .69rem; font-weight: 700; padding: 2px 8px; border-radius: 20px; white-space: nowrap; }
  .type-soudan    { background: #e3f0ff; color: #1a5cb8; }
  .type-shinchoku { background: #e8f5e9; color: #2e7d32; }
  .type-shitsumon { background: #fff8e1; color: #b77000; }
  .type-zatsudan  { background: #f3e5f5; color: #6a1b9a; }
  .board-faculty-tag { font-size: .69rem; background: var(--crimson-pale); color: var(--crimson); padding: 2px 8px; border-radius: 4px; font-weight: 600; white-space: nowrap; }
  .board-card-author { font-size: .73rem; color: var(--gray-light); }
  .board-card-time { font-size: .69rem; color: var(--gray-lighter); margin-left: auto; white-space: nowrap; }
  .board-card-body { font-size: .87rem; color: var(--dark); line-height: 1.65; }
  .board-card-footer { margin-top: .55rem; display: flex; gap: 1rem; font-size: .75rem; color: var(--gray-light); }
  .board-like { cursor: pointer; transition: color .15s; display: flex; align-items: center; gap: 3px; user-select: none; }
  .board-like:hover, .board-like.liked { color: var(--crimson); font-weight: 700; }

  /* â”€â”€â”€ TAIKENKI â”€â”€â”€ */
  .tk-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem; }
  .tk-card { border: 1.5px solid var(--border); border-radius: 12px; background: #fff; padding: 1.1rem; cursor: pointer; transition: all .2s; }
  .tk-card:hover { border-color: var(--gold); box-shadow: 0 4px 14px rgba(200,169,81,.12); }
  .tk-card-head { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: .6rem; align-items: center; }
  .tk-faculty-tag { font-size: .7rem; background: var(--crimson-pale); color: var(--crimson); padding: 2px 9px; border-radius: 4px; font-weight: 600; }
  .tk-exam-tag { font-size: .7rem; background: #fff8e1; color: #b77000; padding: 2px 9px; border-radius: 4px; font-weight: 600; }
  .tk-stats { display: grid; grid-template-columns: 1fr 1fr; gap: .35rem; margin-bottom: .65rem; }
  .tk-stat { background: var(--bg); border-radius: 6px; padding: .35rem .55rem; }
  .tk-stat-label { font-size: .62rem; color: var(--gray-light); font-weight: 700; }
  .tk-stat-value { font-size: .78rem; font-weight: 700; color: var(--dark); }
  .tk-advice { font-size: .81rem; color: var(--gray); line-height: 1.6; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 3; line-clamp: 3; -webkit-box-orient: vertical; }
  .tk-meta { margin-top: .6rem; font-size: .72rem; color: var(--gray-light); }

  /* Taikenki detail modal */
  .tk-detail-item { margin-bottom: .6rem; }
  .tk-detail-label { font-size: .72rem; font-weight: 700; color: var(--crimson); margin-bottom: .15rem; }
  .tk-detail-value { font-size: .87rem; color: var(--dark); line-height: 1.6; }

  /* â”€â”€â”€ AFTER â”€â”€â”€ */
  .after-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 1rem; }
  .after-card { border: 1.5px solid var(--border); border-radius: 12px; padding: 1.2rem; background: #fff; transition: all .2s; }
  .after-card:hover { border-color: var(--gold); box-shadow: 0 4px 14px rgba(200,169,81,.12); transform: translateY(-2px); }
  .after-card-icon { font-size: 1.8rem; margin-bottom: .55rem; }
  .after-card-title { font-size: .93rem; font-weight: 700; margin-bottom: .3rem; }
  .after-card-desc { font-size: .78rem; color: var(--gray); line-height: 1.55; margin-bottom: .8rem; }
  .after-card-link { font-size: .76rem; color: var(--crimson); font-weight: 700; text-decoration: none; }
  .after-card-link:hover { text-decoration: underline; }

  /* SHARED FORM ELEMENTS */
  .form-group { margin-bottom: .8rem; }
  .form-label { display: block; font-size: .78rem; font-weight: 700; color: var(--dark); margin-bottom: .25rem; }
  .form-input { width: 100%; border: 1.5px solid var(--border); border-radius: 8px; padding: 8px 10px; font-size: .86rem; font-family: 'Noto Sans JP', sans-serif; background: var(--bg); transition: border-color .2s; }
  .form-input:focus { outline: none; border-color: var(--crimson); background: #fff; }
  .form-select { width: 100%; border: 1.5px solid var(--border); border-radius: 8px; padding: 8px 10px; font-size: .86rem; font-family: 'Noto Sans JP', sans-serif; background: var(--bg); cursor: pointer; }
  .form-select:focus { outline: none; border-color: var(--crimson); }
  .form-textarea { width: 100%; border: 1.5px solid var(--border); border-radius: 8px; padding: 9px 10px; font-size: .86rem; font-family: 'Noto Sans JP', sans-serif; resize: vertical; min-height: 90px; background: var(--bg); }
  .form-textarea:focus { outline: none; border-color: var(--crimson); background: #fff; }
  .btn-submit { width: 100%; background: linear-gradient(135deg, var(--crimson) 0%, var(--crimson-dark) 100%); color: white; border: none; padding: 12px; border-radius: 10px; font-size: 0.98rem; font-weight: 700; cursor: pointer; font-family: 'Noto Sans JP', sans-serif; margin-top: 0.8rem; transition: all 0.2s; box-shadow: 0 4px 12px rgba(139, 0, 0, 0.25); }
  .btn-submit:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(139, 0, 0, 0.35); }
  .btn-submit:disabled { background: var(--gray-lighter); cursor: not-allowed; transform: none; }
  .form-notice { font-size: .7rem; color: var(--gray-light); margin-top: .55rem; text-align: center; }
  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: .7rem; }

  /* EMPTY STATE */
  .empty-state { text-align: center; padding: 2.8rem 1.5rem; border: 1.5px dashed var(--border); border-radius: 12px; grid-column: 1 / -1; }
  .empty-state-icon { font-size: 2.2rem; margin-bottom: .7rem; }
  .empty-state-title { font-size: .95rem; font-weight: 700; color: var(--gray); margin-bottom: .3rem; }
  .empty-state-text { font-size: .82rem; color: var(--gray-light); line-height: 1.6; }
  .empty-state-btn { margin-top: 1rem; display: inline-block; background: var(--crimson); color: #fff; padding: 9px 20px; border-radius: 8px; font-size: .83rem; font-weight: 700; text-decoration: none; }

  /* FOOTER */
  footer { background: var(--dark); color: rgba(255,255,255,.55); padding: 2rem 1.2rem; }
  .footer-inner { max-width: 700px; margin: 0 auto; text-align: center; }
  .footer-logo { font-size: 1rem; font-weight: 900; color: #fff; margin-bottom: .4rem; }
  .footer-link { color: var(--gold-light); text-decoration: none; }
  .footer-link:hover { text-decoration: underline; }
  .footer-disclaimer { font-size: .7rem; line-height: 1.8; margin-top: .9rem; color: rgba(255,255,255,.3); }

  .loading { text-align: center; padding: 2.5rem; color: var(--gray-light); font-size: .86rem; }

  /* RESPONSIVE */
  @media (max-width: 992px) {
    .tabs-inner { padding: .45rem .4rem; gap: .35rem; }
    .tab { font-size: .75rem; padding: 5px 10px; }
    .qa-layout { grid-template-columns: 1fr; }
    .btn-post { padding: 7px 14px; font-size: 0.8rem; }
  }
  @media (max-width: 860px) {
    .board-layout { grid-template-columns: 1fr; }
    .post-form-box { position: static; }
    .faculty-grid { grid-template-columns: 1fr; }
  }
  @media (max-width: 768px) {
    .panel-inner { padding: 32px 1rem 48px; }
    .hero { padding: 48px 1rem 40px; }
    .hero-title { font-size: 1.4rem; }
    .hero-btns { flex-direction: column; align-items: center; }
    .btn-hero { width: 100%; max-width: 260px; text-align: center; }
    .tk-grid { grid-template-columns: 1fr; }
    .after-grid { grid-template-columns: repeat(2, 1fr); }
    .form-row { grid-template-columns: 1fr; }
  }
  @media (max-width: 480px) {
    .tabs-inner { padding: .4rem .3rem; gap: .3rem; }
    .tab { font-size: .7rem; padding: 4px 8px; }
    .hero-title { font-size: 1.2rem; }
    .sec-title { font-size: 1.2rem; }
    .faculty-detail-grid { grid-template-columns: 1fr; }
    .after-grid { grid-template-columns: 1fr 1fr; }
    .btn-post { padding: 6px 12px; font-size: 0.78rem; }
  }
</style>
</head>
<body>

<!-- HEADER -->
<header>
  <div class="header-inner">
    <a href="https://waseda-ten.vercel.app/" class="logo">
      <span class="logo-jp">ãƒ¯ã‚»ãƒ€ãƒãƒ¼ãƒˆ</span>
      <span class="logo-badge">å—é¨“ç”Ÿã‚µãƒãƒ¼ãƒˆ</span>
    </a>
    <div class="header-actions">
      <button class="btn-google-auth" id="googleAuthBtn" onclick="handleGoogleAuthClick()">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
      <button class="btn-mypage" id="myPageBtn" onclick="openMyPageModal()">ğŸ“Œ ãƒã‚¤ãƒšãƒ¼ã‚¸</button>
      <div class="nickname-badge" id="nicknameBadge" onclick="openNicknameModal()">ğŸ‘¤ ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’è¨­å®š</div>
      <a href="https://waseda-ten.vercel.app/" class="header-back">â† åœ¨å­¦ç”Ÿæ²ç¤ºæ¿ã¸</a>
    </div>
  </div>
</header>

<!-- HERO -->
<section class="hero">
  <div class="hero-inner">
    <span class="hero-label">æ—©ç¨²ç”°å¤§å­¦ å—é¨“ç”Ÿã‚µãƒãƒ¼ãƒˆ</span>
    <h1 class="hero-title">æ—©ç¨²ç”°ã‚’ç›®æŒ‡ã™äººã®ãŸã‚ã®æƒ…å ±ã‚µã‚¤ãƒˆ</h1>
    <p class="hero-sub">åœ¨å­¦ç”Ÿã®ãƒªã‚¢ãƒ«ãªå£°ã¨ã€åŒã˜ç›®æ¨™ã‚’æŒã¤ä»²é–“ãŒé›†ã¾ã‚‹å ´æ‰€</p>
    <div class="hero-btns">
      <button class="btn-hero btn-hero-solid" onclick="switchTab('qa-tab')">åœ¨å­¦ç”Ÿã«è³ªå•ã™ã‚‹</button>
      <button class="btn-hero btn-hero-outline" onclick="switchTab('board-tab')">å—é¨“ç”Ÿæ²ç¤ºæ¿</button>
    </div>
  </div>
</section>

<!-- TABS -->
<div class="tabs">
  <div class="tabs-inner" id="tabsInner">
    <span class="tab active" data-tab="faculties-tab" onclick="switchTab('faculties-tab')">ğŸ« å­¦éƒ¨ç´¹ä»‹</span>
    <span class="tab" data-tab="qa-tab"        onclick="switchTab('qa-tab')">â“ å‹‰å¼·Q&A</span>
    <span class="tab" data-tab="qa-life-tab"   onclick="switchTab('qa-life-tab')">ğŸ« å¤§å­¦ç”Ÿæ´»Q&A</span>
    <span class="tab" data-tab="board-tab"     onclick="switchTab('board-tab')">ğŸ’¬ å—é¨“ç”Ÿæ²ç¤ºæ¿</span>
    <span class="tab" data-tab="taikenki-tab"  onclick="switchTab('taikenki-tab')">ğŸ† åˆæ ¼ä½“é¨“è¨˜</span>
    <span class="tab" data-tab="after-tab"     onclick="switchTab('after-tab')">ğŸ“ åˆæ ¼å¾Œã®æº–å‚™</span>
  </div>
  <button class="tabs-scroll-btn" id="tabsScrollBtn" onclick="scrollTabsRight()" aria-label="ã‚‚ã£ã¨è¦‹ã‚‹">â€º</button>
</div>

<!-- â•â•â• PANEL: å­¦éƒ¨ç´¹ä»‹ â•â•â• -->
<div id="panel-faculties-tab" class="tab-panel active">
  <div class="panel-inner">
    <div class="sec-eye">å¿—æœ›æ ¡é¸ã³</div>
    <h2 class="sec-title">å­¦éƒ¨ç´¹ä»‹</h2>
    <div class="sec-div"></div>
    <p class="sec-sub">æ—©ç¨²ç”°å¤§å­¦ã®13å­¦éƒ¨ã‚’å­¦éƒ¨åˆ¥ã«è©³ã—ãç´¹ä»‹ã—ã¾ã™ã€‚ã‚«ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨æ²ç¤ºæ¿ã§è³ªå•ã§ãã¾ã™ã€‚</p>
    <div class="filter-bar" id="faculty-filter-bar"><!-- JSã§æç”» --></div>
    <div class="faculty-grid" id="faculty-grid"><!-- JSã§æç”» --></div>
  </div>
</div>

<!-- â•â•â• PANEL: å‹‰å¼·Q&A â•â•â• -->
<div id="panel-qa-tab" class="tab-panel">
  <div class="panel-inner">
    <div class="sec-eye">åœ¨å­¦ç”Ÿã¸ã®è³ªå•</div>
    <h2 class="sec-title">å‹‰å¼·ãƒ»å—é¨“ã‚¢ãƒ‰ãƒã‚¤ã‚¹ Q&A</h2>
    <div class="sec-div"></div>
    <p class="sec-sub">åœ¨å­¦ç”Ÿã«å—é¨“ã®ã“ã¨ã‚’ç›´æ¥è³ªå•ã§ãã¾ã™ã€‚æ—©ç¨²ç”°ç”ŸãŒçµŒé¨“ã‚’ã‚‚ã¨ã«å›ç­”ã—ã¾ã™ã€‚</p>
    <div class="qa-layout">
      <!-- æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ  -->
      <div class="post-form-box qa-post-box" id="qaFormBoxStudy">
        <div class="post-form-title">
          <button type="button" class="btn-post" onclick="toggleQaForm('study')">ï¼‹ æŠ•ç¨¿ã™ã‚‹</button>
        </div>
        <div class="post-form-body" onclick="handlePostFormBackdrop(event, 'qaFormBoxStudy')">
        <div class="post-form-body-inner">
        <div class="post-form-modal-head">
          <div class="post-form-modal-title">â“ è³ªå•ã‚’æŠ•ç¨¿ã™ã‚‹</div>
          <button type="button" class="post-form-modal-close" onclick="closeComposerForm('qaFormBoxStudy')">Ã—</button>
        </div>
        <div class="auth-hint" id="authHintQa">ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦æŠ•ç¨¿ã™ã‚‹ã¨ç¢ºèªãƒ»å‰Šé™¤ãƒ»ãƒã‚¤ãƒšãƒ¼ã‚¸ãŒä½¿ãˆã¾ã™ã€‚æœªãƒ­ã‚°ã‚¤ãƒ³æŠ•ç¨¿ã¯ç®¡ç†å¯¾è±¡å¤–ã§ã™ã€‚</div>
        <div class="post-auth-options" id="authOptionsQa">
          <label class="post-auth-option"><input type="radio" name="postAuthMode-qa" id="qaAuthLogin" value="login" onchange="updateAuthModeSelectors()"> ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦æŠ•ç¨¿ï¼ˆç¢ºèªãƒ»å‰Šé™¤ãƒ»ãƒã‚¤ãƒšãƒ¼ã‚¸å¯¾å¿œï¼‰</label>
          <label class="post-auth-option"><input type="radio" name="postAuthMode-qa" id="qaAuthGuest" value="guest" checked onchange="updateAuthModeSelectors()"> ãƒ­ã‚°ã‚¤ãƒ³ã›ãšæŠ•ç¨¿ï¼ˆç®¡ç†å¯¾è±¡å¤–ï¼‰</label>
        </div>
        <div class="post-auth-login-actions" id="authLoginActionsQa">
          <button type="button" class="post-auth-login-btn" onclick="handleGoogleAuthClick('post-form')">ã“ã®ã¾ã¾Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
        </div>
        <div class="form-group">
          <label class="form-label">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ  <span style="color:#e74c3c">*</span></label>
          <input class="form-input" type="text" id="qa-author" placeholder="ä¾‹ï¼šæ—©å¤§å¿—æœ›é«˜3" maxlength="20">
        </div>
        <div class="form-group">
          <label class="form-label">å¿—æœ›å­¦éƒ¨</label>
          <select class="form-select" id="qa-faculty">
            <option value="">é¸æŠï¼ˆä»»æ„ï¼‰</option>
            <option value="seikei">æ”¿æ²»çµŒæ¸ˆ</option><option value="ho">æ³•</option>
            <option value="shogaku">å•†</option><option value="kyoiku">æ•™è‚²</option>
            <option value="bun">æ–‡</option><option value="bunkagaku">æ–‡åŒ–æ§‹æƒ³</option>
            <option value="kiso">åŸºå¹¹ç†å·¥</option><option value="sozo">å‰µé€ ç†å·¥</option>
            <option value="sentan">å…ˆé€²ç†å·¥</option><option value="ningen">äººé–“ç§‘å­¦</option>
            <option value="sports">ã‚¹ãƒãƒ¼ãƒ„ç§‘å­¦</option><option value="kokusai">å›½éš›æ•™é¤Š</option>
            <option value="shakou">ç¤¾ä¼šç§‘å­¦</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">è³ªå•ã‚¿ã‚¤ãƒˆãƒ« <span style="color:#e74c3c">*</span></label>
          <input class="form-input" type="text" id="qa-title" placeholder="ä¾‹ï¼šè‹±èªã®å¯¾ç­–ã¯ã©ã†ã—ã¾ã—ãŸã‹ï¼Ÿ" maxlength="60">
        </div>
        <div class="form-group">
          <label class="form-label">æœ¬æ–‡ <span style="color:#e74c3c">*</span></label>
          <textarea class="form-textarea" id="qa-body" placeholder="è³ªå•ã®è©³ç´°ã‚’æ›¸ã„ã¦ãã ã•ã„..."></textarea>
        </div>
        <button class="btn-submit" onclick="submitJukenQa(this, 'study')">è³ªå•ã‚’æŠ•ç¨¿ã™ã‚‹</button>
        <p class="form-notice">è‰¯è­˜ã‚ã‚‹æŠ•ç¨¿ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚</p>
        </div>
        </div>
      </div>
      <!-- Q&Aä¸€è¦§ -->
      <div>
        <div class="filter-bar" id="qa-faculty-filter"><!-- JS --></div>
        <div id="qa-list" class="qa-grid"><div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div></div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â• PANEL: å¤§å­¦ç”Ÿæ´»Q&A â•â•â• -->
<div id="panel-qa-life-tab" class="tab-panel">
  <div class="panel-inner">
    <div class="sec-eye">åœ¨å­¦ç”Ÿã¸ã®è³ªå•</div>
    <h2 class="sec-title">å¤§å­¦ç”Ÿæ´» Q&A</h2>
    <div class="sec-div"></div>
    <p class="sec-sub">ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹ã®é›°å›²æ°—ã€æ™‚é–“å‰²ã€é€šå­¦ã€ä¸€äººæš®ã‚‰ã—ã€ã‚µãƒ¼ã‚¯ãƒ«å‚åŠ ãªã©å¤§å­¦ç”Ÿæ´»ã«ã¤ã„ã¦è³ªå•ã§ãã¾ã™ã€‚</p>
    <div class="qa-layout">
      <div class="post-form-box qa-post-box" id="qaFormBoxLife">
        <div class="post-form-title">
          <button type="button" class="btn-post" onclick="toggleQaForm('life')">ï¼‹ æŠ•ç¨¿ã™ã‚‹</button>
        </div>
        <div class="post-form-body" onclick="handlePostFormBackdrop(event, 'qaFormBoxLife')">
        <div class="post-form-body-inner">
        <div class="post-form-modal-head">
          <div class="post-form-modal-title">ğŸ« å¤§å­¦ç”Ÿæ´»ã«ã¤ã„ã¦è³ªå•ã™ã‚‹</div>
          <button type="button" class="post-form-modal-close" onclick="closeComposerForm('qaFormBoxLife')">Ã—</button>
        </div>
        <div class="auth-hint" id="authHintQaLife">ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦æŠ•ç¨¿ã™ã‚‹ã¨ç¢ºèªãƒ»å‰Šé™¤ãƒ»ãƒã‚¤ãƒšãƒ¼ã‚¸ãŒä½¿ãˆã¾ã™ã€‚æœªãƒ­ã‚°ã‚¤ãƒ³æŠ•ç¨¿ã¯ç®¡ç†å¯¾è±¡å¤–ã§ã™ã€‚</div>
        <div class="post-auth-options" id="authOptionsQaLife">
          <label class="post-auth-option"><input type="radio" name="postAuthMode-qaLife" id="qaLifeAuthLogin" value="login" onchange="updateAuthModeSelectors()"> ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦æŠ•ç¨¿ï¼ˆç¢ºèªãƒ»å‰Šé™¤ãƒ»ãƒã‚¤ãƒšãƒ¼ã‚¸å¯¾å¿œï¼‰</label>
          <label class="post-auth-option"><input type="radio" name="postAuthMode-qaLife" id="qaLifeAuthGuest" value="guest" checked onchange="updateAuthModeSelectors()"> ãƒ­ã‚°ã‚¤ãƒ³ã›ãšæŠ•ç¨¿ï¼ˆç®¡ç†å¯¾è±¡å¤–ï¼‰</label>
        </div>
        <div class="post-auth-login-actions" id="authLoginActionsQaLife">
          <button type="button" class="post-auth-login-btn" onclick="handleGoogleAuthClick('post-form')">ã“ã®ã¾ã¾Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
        </div>
        <div class="form-group">
          <label class="form-label">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ  <span style="color:#e74c3c">*</span></label>
          <input class="form-input" type="text" id="qa-life-author" placeholder="ä¾‹ï¼šæ—©å¤§å¿—æœ›é«˜3" maxlength="20">
        </div>
        <div class="form-group">
          <label class="form-label">å¿—æœ›å­¦éƒ¨</label>
          <select class="form-select" id="qa-life-faculty">
            <option value="">é¸æŠï¼ˆä»»æ„ï¼‰</option>
            <option value="seikei">æ”¿æ²»çµŒæ¸ˆ</option><option value="ho">æ³•</option>
            <option value="shogaku">å•†</option><option value="kyoiku">æ•™è‚²</option>
            <option value="bun">æ–‡</option><option value="bunkagaku">æ–‡åŒ–æ§‹æƒ³</option>
            <option value="kiso">åŸºå¹¹ç†å·¥</option><option value="sozo">å‰µé€ ç†å·¥</option>
            <option value="sentan">å…ˆé€²ç†å·¥</option><option value="ningen">äººé–“ç§‘å­¦</option>
            <option value="sports">ã‚¹ãƒãƒ¼ãƒ„ç§‘å­¦</option><option value="kokusai">å›½éš›æ•™é¤Š</option>
            <option value="shakou">ç¤¾ä¼šç§‘å­¦</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">è³ªå•ã‚¿ã‚¤ãƒˆãƒ« <span style="color:#e74c3c">*</span></label>
          <input class="form-input" type="text" id="qa-life-title" placeholder="ä¾‹ï¼š1å¹´ç”Ÿã®æ™‚é–“å‰²ã¯ã©ã‚Œãã‚‰ã„å¿™ã—ã„ã§ã™ã‹ï¼Ÿ" maxlength="60">
        </div>
        <div class="form-group">
          <label class="form-label">æœ¬æ–‡ <span style="color:#e74c3c">*</span></label>
          <textarea class="form-textarea" id="qa-life-body" placeholder="è³ªå•ã®è©³ç´°ã‚’æ›¸ã„ã¦ãã ã•ã„..."></textarea>
        </div>
        <button class="btn-submit" onclick="submitJukenQa(this, 'life')">è³ªå•ã‚’æŠ•ç¨¿ã™ã‚‹</button>
        <p class="form-notice">è‰¯è­˜ã‚ã‚‹æŠ•ç¨¿ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚</p>
        </div>
        </div>
      </div>
      <div>
        <div class="filter-bar" id="qa-life-faculty-filter"><!-- JS --></div>
        <div id="qa-life-list" class="qa-grid"><div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div></div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â• PANEL: å—é¨“ç”Ÿæ²ç¤ºæ¿ â•â•â• -->
<div id="panel-board-tab" class="tab-panel">
  <div class="panel-inner">
    <div class="sec-eye">å—é¨“ç”Ÿã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£</div>
    <h2 class="sec-title">å—é¨“ç”Ÿæ²ç¤ºæ¿</h2>
    <div class="sec-div"></div>
    <p class="sec-sub">åŒã˜ç›®æ¨™ã‚’æŒã¤ä»²é–“ã¨æƒ…å ±äº¤æ›ãƒ»é€²æ—å ±å‘ŠãŒã§ãã‚‹å ´æ‰€ã§ã™ã€‚</p>
    <div class="filter-bar" id="board-type-filter">
      <span class="chip active" data-type="all" onclick="filterBoard('all',this)">ã™ã¹ã¦</span>
      <span class="chip" data-type="ç›¸è«‡" onclick="filterBoard('ç›¸è«‡',this)">ç›¸è«‡</span>
      <span class="chip" data-type="é€²æ—å ±å‘Š" onclick="filterBoard('é€²æ—å ±å‘Š',this)">é€²æ—å ±å‘Š</span>
      <span class="chip" data-type="è³ªå•" onclick="filterBoard('è³ªå•',this)">è³ªå•</span>
      <span class="chip" data-type="é›‘è«‡" onclick="filterBoard('é›‘è«‡',this)">é›‘è«‡</span>
    </div>
    <div class="filter-bar" id="board-faculty-filter"><!-- JS --></div>
    <div class="board-layout">
      <div class="post-form-box" id="boardFormBox">
        <div class="post-form-title">
          <button type="button" class="btn-post" onclick="toggleBoardForm()">ï¼‹ æŠ•ç¨¿ã™ã‚‹</button>
        </div>
        <div class="post-form-body" onclick="handlePostFormBackdrop(event, 'boardFormBox')">
          <div class="post-form-body-inner">
          <div class="post-form-modal-head">
            <div class="post-form-modal-title">ğŸ“ æ²ç¤ºæ¿ã«æŠ•ç¨¿ã™ã‚‹</div>
            <button type="button" class="post-form-modal-close" onclick="closeComposerForm('boardFormBox')">Ã—</button>
          </div>
          <div class="auth-hint" id="authHintBoard">ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦æŠ•ç¨¿ã™ã‚‹ã¨ç¢ºèªãƒ»å‰Šé™¤ãƒ»ãƒã‚¤ãƒšãƒ¼ã‚¸ãŒä½¿ãˆã¾ã™ã€‚æœªãƒ­ã‚°ã‚¤ãƒ³æŠ•ç¨¿ã¯ç®¡ç†å¯¾è±¡å¤–ã§ã™ã€‚</div>
          <div class="post-auth-options" id="authOptionsBoard">
            <label class="post-auth-option"><input type="radio" name="postAuthMode-board" id="boardAuthLogin" value="login" onchange="updateAuthModeSelectors()"> ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦æŠ•ç¨¿ï¼ˆç¢ºèªãƒ»å‰Šé™¤ãƒ»ãƒã‚¤ãƒšãƒ¼ã‚¸å¯¾å¿œï¼‰</label>
            <label class="post-auth-option"><input type="radio" name="postAuthMode-board" id="boardAuthGuest" value="guest" checked onchange="updateAuthModeSelectors()"> ãƒ­ã‚°ã‚¤ãƒ³ã›ãšæŠ•ç¨¿ï¼ˆç®¡ç†å¯¾è±¡å¤–ï¼‰</label>
          </div>
          <div class="post-auth-login-actions" id="authLoginActionsBoard">
            <button type="button" class="post-auth-login-btn" onclick="handleGoogleAuthClick('post-form')">ã“ã®ã¾ã¾Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
          </div>
          <div class="form-group">
            <label class="form-label">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ  <span style="color:#e74c3c">*</span></label>
            <input class="form-input" type="text" id="boardNickname" placeholder="ä¾‹ï¼šæ—©ç¨²ç”°å¿—æœ›19æ­³" maxlength="20">
          </div>
          <div class="form-group">
            <label class="form-label">å¿—æœ›å­¦éƒ¨</label>
            <select class="form-select" id="boardFaculty">
              <option value="">å­¦éƒ¨ã‚’é¸æŠï¼ˆä»»æ„ï¼‰</option>
              <option value="seikei">æ”¿æ²»çµŒæ¸ˆå­¦éƒ¨</option><option value="ho">æ³•å­¦éƒ¨</option>
              <option value="shogaku">å•†å­¦éƒ¨</option><option value="kyoiku">æ•™è‚²å­¦éƒ¨</option>
              <option value="bun">æ–‡å­¦éƒ¨</option><option value="bunkagaku">æ–‡åŒ–æ§‹æƒ³å­¦éƒ¨</option>
              <option value="kiso">åŸºå¹¹ç†å·¥å­¦éƒ¨</option><option value="sozo">å‰µé€ ç†å·¥å­¦éƒ¨</option>
              <option value="sentan">å…ˆé€²ç†å·¥å­¦éƒ¨</option><option value="ningen">äººé–“ç§‘å­¦éƒ¨</option>
              <option value="sports">ã‚¹ãƒãƒ¼ãƒ„ç§‘å­¦éƒ¨</option><option value="kokusai">å›½éš›æ•™é¤Šå­¦éƒ¨</option>
              <option value="shakou">ç¤¾ä¼šç§‘å­¦éƒ¨</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">æŠ•ç¨¿ç¨®åˆ¥ <span style="color:#e74c3c">*</span></label>
            <select class="form-select" id="boardType">
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="ç›¸è«‡">ç›¸è«‡</option><option value="é€²æ—å ±å‘Š">é€²æ—å ±å‘Š</option>
              <option value="è³ªå•">è³ªå•</option><option value="é›‘è«‡">é›‘è«‡</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">æœ¬æ–‡ <span style="color:#e74c3c">*</span></label>
            <textarea class="form-textarea" id="boardBody" placeholder="æ°—ã«ãªã‚‹ã“ã¨ã‚„é€²æ—ã‚’è‡ªç”±ã«æ›¸ã„ã¦ãã ã•ã„..."></textarea>
          </div>
          <button class="btn-submit" id="boardSubmitBtn" onclick="submitBoardPost(this)">æŠ•ç¨¿ã™ã‚‹</button>
          <p class="form-notice">è‰¯è­˜ã‚ã‚‹æŠ•ç¨¿ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚</p>
          </div>
        </div>
      </div>
      <div id="board-posts" class="board-posts"><div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div></div>
    </div>
  </div>
</div>

<!-- â•â•â• PANEL: åˆæ ¼ä½“é¨“è¨˜ â•â•â• -->
<div id="panel-taikenki-tab" class="tab-panel">
  <div class="panel-inner">
    <div class="sec-eye">å…ˆè¼©ã®åˆæ ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼</div>
    <h2 class="sec-title">åˆæ ¼ä½“é¨“è¨˜</h2>
    <div class="sec-div"></div>
    <p class="sec-sub">åˆæ ¼ã—ãŸå…ˆè¼©ãŸã¡ã®ãƒªã‚¢ãƒ«ãªä½“é¨“è¨˜ã€‚åœ¨å­¦ç”Ÿæ²ç¤ºæ¿ã®ã€Œå—é¨“ç”Ÿã‚µãƒãƒ¼ãƒˆã€ã‚¿ãƒ–ã‹ã‚‰æŠ•ç¨¿ã§ãã¾ã™ã€‚</p>
    <div class="filter-bar" id="tk-faculty-filter"><!-- JS --></div>
    <div id="taikenki-list" class="tk-grid"><div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div></div>
  </div>
</div>

<!-- â•â•â• PANEL: åˆæ ¼å¾Œã®æº–å‚™ â•â•â• -->
<div id="panel-after-tab" class="tab-panel">
  <div class="panel-inner">
    <div class="sec-eye">åˆæ ¼ã—ãŸæ–¹ã¸</div>
    <h2 class="sec-title">åˆæ ¼å¾Œã®æº–å‚™</h2>
    <div class="sec-div"></div>
    <p class="sec-sub">åˆæ ¼ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ã€‚å…¥å­¦å‰ã«ç¢ºèªã—ã¦ãŠããŸã„ã“ã¨ã‚’ã¾ã¨ã‚ã¾ã—ãŸã€‚</p>
    <div class="after-grid">
      <div class="after-card">
        <div class="after-card-icon">ğŸ“‹</div>
        <div class="after-card-title">å…¥å­¦æ‰‹ç¶šã</div>
        <div class="after-card-desc">å…¥å­¦é‡‘ãƒ»æˆæ¥­æ–™ã®æ”¯æ‰•ã„ã‚„æ›¸é¡æå‡ºã®ç· åˆ‡ãªã©ã€æ‰‹ç¶šãã®æµã‚Œã‚’å…ˆè¼©ã«ç¢ºèªã—ã‚ˆã†ã€‚</div>
        <a href="https://waseda-ten.vercel.app/" class="after-card-link">åœ¨å­¦ç”Ÿã«èã â†’</a>
      </div>
      <div class="after-card">
        <div class="after-card-icon">ğŸ </div>
        <div class="after-card-title">ä¸€äººæš®ã‚‰ã—æº–å‚™</div>
        <div class="after-card-desc">æ—©ç¨²ç”°å‘¨è¾ºã®å®¶è³ƒç›¸å ´ãƒ»ãŠã™ã™ã‚ã‚¨ãƒªã‚¢ãƒ»å¼•è¶Šã—æ™‚æœŸã®æ³¨æ„ç‚¹ãªã©ã€‚</div>
        <a href="https://waseda-ten.vercel.app/" class="after-card-link">åœ¨å­¦ç”Ÿã«èã â†’</a>
      </div>
      <div class="after-card">
        <div class="after-card-icon">ğŸ¯</div>
        <div class="after-card-title">ã‚µãƒ¼ã‚¯ãƒ«æƒ…å ±</div>
        <div class="after-card-desc">æ–°æ­“ã®æ™‚æœŸã€äººæ°—ã‚µãƒ¼ã‚¯ãƒ«ã€å…¼ã‚µãƒ¼ã®å®Ÿæ…‹ã¾ã§å…ˆè¼©ã‹ã‚‰æ•™ãˆã¦ã‚‚ã‚‰ãŠã†ã€‚</div>
        <a href="https://waseda-ten.vercel.app/" class="after-card-link">ã‚µãƒ¼ã‚¯ãƒ«æƒ…å ±ã‚’è¦‹ã‚‹ â†’</a>
      </div>
      <div class="after-card">
        <div class="after-card-icon">ğŸ“š</div>
        <div class="after-card-title">å±¥ä¿®ç™»éŒ²</div>
        <div class="after-card-desc">åˆã‚ã¦ã®å±¥ä¿®ç™»éŒ²ã¯æˆ¸æƒ‘ã†ã“ã¨ã‚‚ã€‚å˜ä½ã®å–ã‚Šæ–¹ã‚’å…ˆè¼©ã®æˆæ¥­å£ã‚³ãƒŸã§ç¢ºèªã—ã‚ˆã†ã€‚</div>
        <a href="https://waseda-ten.vercel.app/" class="after-card-link">æˆæ¥­å£ã‚³ãƒŸã‚’è¦‹ã‚‹ â†’</a>
      </div>
    </div>
  </div>
</div>

<!-- Q&A è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-overlay" id="qaModal">
  <div class="modal">
    <div class="modal-header">
      <h3>â“ è³ªå•ãƒ»å›ç­”</h3>
      <button class="modal-close" onclick="closeQaModal()">Ã—</button>
    </div>
    <div class="modal-body" id="qa-detail-content"></div>
  </div>
</div>

<!-- ä½“é¨“è¨˜è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-overlay" id="tkModal">
  <div class="modal">
    <div class="modal-header">
      <h3>ğŸ† åˆæ ¼ä½“é¨“è¨˜</h3>
      <button class="modal-close" onclick="closeTkModal()">Ã—</button>
    </div>
    <div class="modal-body" id="tk-detail-content"></div>
  </div>
</div>

<div class="modal-overlay" id="nicknameModal">
  <div class="modal" style="max-width:460px;">
    <div class="modal-header">
      <h3>ğŸ‘¤ ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ è¨­å®š</h3>
      <button class="modal-close" onclick="closeNicknameModal()">Ã—</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ </label>
        <input class="form-input" type="text" id="nicknameInput" maxlength="20" placeholder="ä¾‹ï¼šwaseda_taro">
      </div>
      <button class="btn-submit" onclick="saveNickname()">ä¿å­˜ã™ã‚‹</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="myPageModal">
  <div class="modal" style="max-width:680px;">
    <div class="modal-header">
      <h3>ğŸ“Œ ãƒã‚¤ãƒšãƒ¼ã‚¸</h3>
      <button class="modal-close" onclick="closeMyPageModal()">Ã—</button>
    </div>
    <div class="modal-body">
      <div id="myPageSummary" style="font-size:.84rem;color:var(--gray);margin-bottom:1rem;">èª­ã¿è¾¼ã¿ä¸­...</div>
      <div id="myPageList"></div>
    </div>
  </div>
</div>

<div class="modal-overlay" id="boardDetailModal">
  <div class="modal" style="max-width:680px;">
    <div class="modal-header">
      <h3>ğŸ’¬ æ²ç¤ºæ¿è©³ç´°</h3>
      <button class="modal-close" onclick="closeBoardDetailModal()">Ã—</button>
    </div>
    <div class="modal-body" id="board-detail-content"></div>
  </div>
</div>

<!-- FOOTER -->
<footer>
  <div class="footer-inner">
    <div class="footer-logo">ãƒ¯ã‚»ãƒ€ãƒãƒ¼ãƒˆ</div>
    <p style="font-size:.82rem;margin-bottom:.3rem;"><a href="https://waseda-ten.vercel.app/" class="footer-link">åœ¨å­¦ç”Ÿæ²ç¤ºæ¿ã¸æˆ»ã‚‹</a></p>
    <div class="footer-disclaimer">
      æœ¬ã‚µã‚¤ãƒˆã¯æ—©ç¨²ç”°å¤§å­¦ã®å…¬å¼ã‚µã‚¤ãƒˆã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚æ²è¼‰æƒ…å ±ã¯ã™ã¹ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã‚‹æŠ•ç¨¿ã§ã‚ã‚Šã€å†…å®¹ã®æ­£ç¢ºæ€§ã‚’ä¿è¨¼ã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚<br>
      å—é¨“ã«é–¢ã™ã‚‹æ­£ç¢ºãªæƒ…å ±ã¯å¿…ãš<a href="https://www.waseda.jp/" class="footer-link" target="_blank" rel="noopener">æ—©ç¨²ç”°å¤§å­¦å…¬å¼ã‚µã‚¤ãƒˆ</a>ã§ã”ç¢ºèªãã ã•ã„ã€‚
    </div>
  </div>
</footer>

<script>
// â”€â”€ Supabase â”€â”€
const SUPABASE_URL = 'https://hazntivymzywhowtdtcc.supabase.co';
const SUPABASE_ANON_KEY = 'sb_publishable_Mr1wt5ZOoLtmYqPEoIKeUw_cM4ZPSbN';
const AUTH_REDIRECT_URL = 'https://waseda-ten.vercel.app/juken.html';
const TRUSTED_AUTH_HOSTS = ['waseda-ten.vercel.app'];
const JUKEN_AUTH_RETURN_KEY = 'waseda_juken_auth_return';
const JUKEN_AUTH_DRAFT_KEY = 'waseda_juken_auth_draft';
const JUKEN_AUTH_DRAFT_TS_KEY = 'waseda_juken_auth_draft_ts';
const BOARD_COMMENT_AUTH_RETURN_KEY = 'waseda_board_comment_auth_return';
const BOARD_COMMENT_AUTH_DRAFT_KEY = 'waseda_board_comment_auth_draft';
const BOARD_COMMENT_AUTH_DRAFT_TS_KEY = 'waseda_board_comment_auth_draft_ts';
let db;
try {
  if (typeof createClient === 'function') db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  else if (window.supabase?.createClient) db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
} catch(e) { console.error('Supabase init:', e); }
let googleAuthUser = null;
let currentUser = localStorage.getItem('waseda_nickname') || 'ã‚²ã‚¹ãƒˆ';
const LAST_AUTH_USER_KEY = 'waseda_last_auth_user_id';
const MY_PAGE_NOTIFY_PREFIX = 'waseda_mypage_notify_state_';
const MY_PAGE_NOTIFY_INTERVAL_MS = 60000;
let myPageNotifyCount = 0;
let myPageNotifyTimer = null;
let myPageNotifyInFlight = false;

// â”€â”€ å®šæ•° â”€â”€
const FACULTIES = {
  seikei:'æ”¿æ²»çµŒæ¸ˆå­¦éƒ¨', ho:'æ³•å­¦éƒ¨', shogaku:'å•†å­¦éƒ¨', kyoiku:'æ•™è‚²å­¦éƒ¨',
  bun:'æ–‡å­¦éƒ¨', bunkagaku:'æ–‡åŒ–æ§‹æƒ³å­¦éƒ¨', kiso:'åŸºå¹¹ç†å·¥å­¦éƒ¨', sozo:'å‰µé€ ç†å·¥å­¦éƒ¨',
  sentan:'å…ˆé€²ç†å·¥å­¦éƒ¨', ningen:'äººé–“ç§‘å­¦éƒ¨', sports:'ã‚¹ãƒãƒ¼ãƒ„ç§‘å­¦éƒ¨',
  kokusai:'å›½éš›æ•™é¤Šå­¦éƒ¨', shakou:'ç¤¾ä¼šç§‘å­¦éƒ¨'
};
const FACULTY_DATA = [
  { key:'seikei',    name:'æ”¿æ²»çµŒæ¸ˆå­¦éƒ¨', eng:'Political Science & Economics',  campus:'æ—©ç¨²ç”°',   vibe:'å°‘äººæ•°ã‚¼ãƒŸãŒå……å®Ÿã€‚æ”¿æ²»ãƒ»çµŒæ¸ˆãƒ»å›½éš›ã®3å°‚æ”»ã«åˆ†ã‹ã‚Œã‚‹ã€‚æ´»ç™ºãªãƒ‡ã‚£ã‚¹ã‚«ãƒƒã‚·ãƒ§ãƒ³æ–‡åŒ–ã€‚', career:'ç·åˆå•†ç¤¾ãƒ»é‡‘èãƒ»å®˜å…¬åºãƒ»ã‚³ãƒ³ã‚µãƒ«ãƒ»ãƒã‚¹ã‚³ãƒŸãŒå¤šã„ã€‚å›½å®¶å…¬å‹™å“¡å¿—æœ›ã‚‚ã€‚', gender:'ç”·æ€§ã‚„ã‚„å¤šã‚ï¼ˆç´„6:4ï¼‰', hensachi:'67ã€œ70ï¼ˆä¸€èˆ¬ï¼‰' },
  { key:'ho',        name:'æ³•å­¦éƒ¨',       eng:'Law',                            campus:'æ—©ç¨²ç”°',   vibe:'æ³•å¾‹ãƒ»æ”¿æ²»ã®2å­¦ç§‘ã€‚è‡ªä¸»çš„ãªå­¦ç¿’ãŒæ±‚ã‚ã‚‰ã‚Œã‚‹ã€‚å¸æ³•è©¦é¨“ã‚µãƒ¼ã‚¯ãƒ«ãŒç››ã‚“ã€‚', career:'æ³•æ›¹ãƒ»å®˜å…¬åºãƒ»é‡‘èãƒ»ã‚³ãƒ³ã‚µãƒ«ãƒ»å¤§æ‰‹ä¼æ¥­ã®æ³•å‹™éƒ¨é–€ã€‚', gender:'ç”·å¥³ã»ã¼åŠã€…', hensachi:'65ã€œ68ï¼ˆä¸€èˆ¬ï¼‰' },
  { key:'shogaku',   name:'å•†å­¦éƒ¨',       eng:'Commerce',                       campus:'æ—©ç¨²ç”°',   vibe:'ãƒãƒ¼ã‚±ãƒ»ä¼šè¨ˆãƒ»ãƒ•ã‚¡ã‚¤ãƒŠãƒ³ã‚¹ãªã©å¹…åºƒã„ã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ³ãŒæ´»ç™ºã€‚å°±è·æ„è­˜ãŒé«˜ã„å­¦ç”ŸãŒå¤šã„ã€‚', career:'é‡‘èãƒ»å•†ç¤¾ãƒ»ã‚³ãƒ³ã‚µãƒ«ãƒ»ãƒ¡ãƒ¼ã‚«ãƒ¼ãƒ»åºƒå‘Šã€‚å°±è·ç‡ãƒˆãƒƒãƒ—ã‚¯ãƒ©ã‚¹ã€‚', gender:'ç”·æ€§ã‚„ã‚„å¤šã‚ï¼ˆç´„6:4ï¼‰', hensachi:'65ã€œ68ï¼ˆä¸€èˆ¬ï¼‰' },
  { key:'kyoiku',    name:'æ•™è‚²å­¦éƒ¨',     eng:'Education',                      campus:'æ—©ç¨²ç”°',   vibe:'æ–‡ç³»ã‹ã‚‰ç†ç³»ã¾ã§å¤šå½©ãªå°‚ä¿®ã€‚ã‚¢ãƒƒãƒˆãƒ›ãƒ¼ãƒ ãªé›°å›²æ°—ã€‚æ•™è·èª²ç¨‹ãŒå……å®Ÿã€‚', career:'æ•™å“¡ãƒ»å…¬å‹™å“¡ãƒ»ä¸€èˆ¬ä¼æ¥­ã¨é€²è·¯ã¯å¹…åºƒã„ã€‚æ•™å“¡å…è¨±å–å¾—è€…ã‚‚å¤šã„ã€‚', gender:'å¥³æ€§ã‚„ã‚„å¤šã‚ï¼ˆç´„4:6ï¼‰', hensachi:'62ã€œ66ï¼ˆä¸€èˆ¬ï¼‰' },
  { key:'bun',       name:'æ–‡å­¦éƒ¨',       eng:'Humanities & Social Sciences',   campus:'æ—©ç¨²ç”°',   vibe:'æ–‡å­¦ãƒ»å“²å­¦ãƒ»å¿ƒç†ãƒ»ç¤¾ä¼šå­¦ãªã©æ·±ã„å­¦å•ã€‚è‡ªç”±ãªé›°å›²æ°—ã§å€‹æ€§çš„ãªå­¦ç”ŸãŒå¤šã„ã€‚', career:'å‡ºç‰ˆãƒ»ãƒã‚¹ã‚³ãƒŸãƒ»ä¸€èˆ¬ä¼æ¥­ãƒ»å¤§å­¦é™¢é€²å­¦ã¨å¤šæ§˜ã€‚', gender:'å¥³æ€§å¤šã‚ï¼ˆç´„3:7ï¼‰', hensachi:'63ã€œ66ï¼ˆä¸€èˆ¬ï¼‰' },
  { key:'bunkagaku', name:'æ–‡åŒ–æ§‹æƒ³å­¦éƒ¨', eng:'Culture, Media & Society',       campus:'æ—©ç¨²ç”°',   vibe:'æ–‡å­¦éƒ¨ã®å§‰å¦¹å­¦éƒ¨ã€‚ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ»è¡¨è±¡ãƒ»æ–‡åŒ–ã‚’å­¦ã¶ã€‚ãŠã—ã‚ƒã‚Œãªå­¦ç”ŸãŒå¤šã„å°è±¡ã€‚', career:'ãƒã‚¹ã‚³ãƒŸãƒ»åºƒå‘Šãƒ»å‡ºç‰ˆãƒ»ITãƒ»ä¸€èˆ¬ä¼æ¥­ã¨å¤šæ§˜ã€‚', gender:'å¥³æ€§å¤šã‚ï¼ˆç´„3:7ï¼‰', hensachi:'64ã€œ67ï¼ˆä¸€èˆ¬ï¼‰' },
  { key:'kiso',      name:'åŸºå¹¹ç†å·¥å­¦éƒ¨', eng:'Fundamental Sci. & Engineering', campus:'è¥¿æ—©ç¨²ç”°', vibe:'æ•°å­¦ãƒ»æƒ…å ±ãƒ»é›»æ°—é›»å­ãŒä¸­å¿ƒã€‚å®Ÿé¨“ãƒ»æ¼”ç¿’ãŒå¤šãå¿™ã—ã„ãŒä»²é–“æ„è­˜ãŒå¼·ã„ã€‚', career:'ITãƒ»ãƒ¡ãƒ¼ã‚«ãƒ¼ãƒ»é€šä¿¡ã€‚å¤§å­¦é™¢é€²å­¦ç‡ãŒé«˜ã„ï¼ˆç´„70%ï¼‰ã€‚', gender:'ç”·æ€§å¤šã‚ï¼ˆç´„8:2ï¼‰', hensachi:'64ã€œ68ï¼ˆä¸€èˆ¬ï¼‰' },
  { key:'sozo',      name:'å‰µé€ ç†å·¥å­¦éƒ¨', eng:'Creative Sci. & Engineering',    campus:'è¥¿æ—©ç¨²ç”°', vibe:'å»ºç¯‰ãƒ»æ©Ÿæ¢°ãƒ»ç’°å¢ƒè³‡æºã€‚ã‚‚ã®ã¥ãã‚ŠãŒå¥½ããªå­¦ç”ŸãŒé›†ã¾ã‚‹ã€‚å»ºç¯‰å­¦ç§‘ã¯ç‰¹ã«å¿™ã—ã„ã€‚', career:'å»ºè¨­ãƒ»ãƒ¡ãƒ¼ã‚«ãƒ¼ãƒ»ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã€‚å¤§å­¦é™¢é€²å­¦ã‚‚å¤šã„ã€‚', gender:'ç”·æ€§å¤šã‚ï¼ˆç´„7:3ï¼‰', hensachi:'63ã€œ67ï¼ˆä¸€èˆ¬ï¼‰' },
  { key:'sentan',    name:'å…ˆé€²ç†å·¥å­¦éƒ¨', eng:'Advanced Sci. & Engineering',    campus:'è¥¿æ—©ç¨²ç”°', vibe:'ç‰©ç†ãƒ»åŒ–å­¦ãƒ»ç”Ÿå‘½åŒ»ç§‘å­¦ã€‚ç ”ç©¶å¿—å‘ãŒå¼·ãå¤§å­¦é™¢é€²å­¦ç‡ãŒæœ€ã‚‚é«˜ã„å­¦éƒ¨ã®ä¸€ã¤ã€‚', career:'å¤§å­¦é™¢â†’ç ”ç©¶è·ãƒ»è£½è–¬ãƒ»ãƒã‚¤ã‚ªãŒå¤šã„ã€‚å¤§å­¦é™¢é€²å­¦ç‡ç´„80%ã€‚', gender:'ç”·æ€§å¤šã‚ï¼ˆç´„7:3ï¼‰', hensachi:'64ã€œ68ï¼ˆä¸€èˆ¬ï¼‰' },
  { key:'ningen',    name:'äººé–“ç§‘å­¦éƒ¨',   eng:'Human Sciences',                 campus:'æ‰€æ²¢',     vibe:'å¿ƒç†ãƒ»æ•™è‚²ãƒ»ç¤¾ä¼šå­¦ã®èåˆã€‚æ‰€æ²¢ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹ã§ã®ã‚“ã³ã‚Šã—ãŸé›°å›²æ°—ã€‚é€šå­¦æ³¨æ„ã€‚', career:'ä¸€èˆ¬ä¼æ¥­ãƒ»å…¬å‹™å“¡ãƒ»å¤§å­¦é™¢ãƒ»æ•™å“¡ã¨å¹…åºƒã„ã€‚', gender:'å¥³æ€§ã‚„ã‚„å¤šã‚ï¼ˆç´„4:6ï¼‰', hensachi:'60ã€œ64ï¼ˆä¸€èˆ¬ï¼‰' },
  { key:'sports',    name:'ã‚¹ãƒãƒ¼ãƒ„ç§‘å­¦éƒ¨',eng:'Sport Sciences',                campus:'æ‰€æ²¢',     vibe:'ã‚¹ãƒãƒ¼ãƒ„æ¨è–¦ã®å­¦ç”Ÿã‚‚å¤šãæ´»æ°—ãŒã‚ã‚‹ã€‚ä½“è‚²ä¼šç³»ã®é›°å›²æ°—ã€‚æ‰€æ²¢ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹ã€‚', career:'ã‚¹ãƒãƒ¼ãƒ„æ¥­ç•Œãƒ»æ•™å“¡ãƒ»ä¸€èˆ¬ä¼æ¥­ã€‚ã‚¢ã‚¹ãƒªãƒ¼ãƒˆã®å‰²åˆãŒé«˜ã„ã€‚', gender:'ç”·æ€§ã‚„ã‚„å¤šã‚ï¼ˆç´„6:4ï¼‰', hensachi:'55ã€œ62ï¼ˆä¸€èˆ¬ï¼‰' },
  { key:'kokusai',   name:'å›½éš›æ•™é¤Šå­¦éƒ¨', eng:'International Liberal Studies',  campus:'æ—©ç¨²ç”°',   vibe:'è‹±èªã§æˆæ¥­ã€‚å¸°å›½å­å¥³ãƒ»æµ·å¤–çµŒé¨“è€…ãŒå¤šã„ã€‚å›½éš›è‰²è±Šã‹ã€‚ç•™å­¦å¿…é ˆã€‚', career:'å¤–è³‡ç³»ãƒ»å›½éš›æ©Ÿé–¢ãƒ»å•†ç¤¾ãƒ»ã‚³ãƒ³ã‚µãƒ«ãƒ»ãƒã‚¹ã‚³ãƒŸã€‚è‹±èªåŠ›ã‚’æ´»ã‹ã™è·ç¨®ã€‚', gender:'å¥³æ€§å¤šã‚ï¼ˆç´„4:6ï¼‰', hensachi:'67ã€œ70ï¼ˆä¸€èˆ¬ï¼‰' },
  { key:'shakou',    name:'ç¤¾ä¼šç§‘å­¦éƒ¨',   eng:'Social Sciences',                campus:'æ—©ç¨²ç”°',   vibe:'å¤œé–“ã‹ã‚‰æ˜¼é–“ã«ç§»è¡Œã€‚æ–‡ç†èåˆã§è‡ªç”±ã«å­¦ã¹ã‚‹ã€‚ãƒã‚¤ãƒˆã‚„ã‚µãƒ¼ã‚¯ãƒ«ã¨ä¸¡ç«‹ã—ã‚„ã™ã„ã€‚', career:'ä¸€èˆ¬ä¼æ¥­ãƒ»å…¬å‹™å“¡ã¨å¹…åºƒã„ã€‚å°±è·ç‡ã¯é«˜ã„ã€‚', gender:'ç”·æ€§ã‚„ã‚„å¤šã‚ï¼ˆç´„6:4ï¼‰', hensachi:'65ã€œ68ï¼ˆä¸€èˆ¬ï¼‰' },
];
const TYPE_CLASSES = { 'ç›¸è«‡':'type-soudan', 'é€²æ—å ±å‘Š':'type-shinchoku', 'è³ªå•':'type-shitsumon', 'é›‘è«‡':'type-zatsudan' };

// â”€â”€ ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ â”€â”€
function escHtml(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function formatTime(ts) {
  const d = Math.floor((Date.now()-new Date(ts))/1000);
  if (d<60) return 'ãŸã£ãŸä»Š'; if (d<3600) return Math.floor(d/60)+'åˆ†å‰';
  if (d<86400) return Math.floor(d/3600)+'æ™‚é–“å‰'; return Math.floor(d/86400)+'æ—¥å‰';
}
function getDeviceId() {
  let id = localStorage.getItem('waseda_device_id');
  if (!id) { id='dev_'+Math.random().toString(36).substr(2,9)+'_'+Date.now().toString(36); localStorage.setItem('waseda_device_id',id); }
  return id;
}
function getOwnerKey() {
  return googleAuthUser?.id ? `auth:${googleAuthUser.id}` : null;
}
function rememberLastAuthUserId(userOrId) {
  const userId = typeof userOrId === 'string' ? userOrId : userOrId?.id;
  if (!userId) return;
  try { localStorage.setItem(LAST_AUTH_USER_KEY, userId); } catch {}
}
function getLastAuthUserId() {
  try {
    const userId = (localStorage.getItem(LAST_AUTH_USER_KEY) || '').trim();
    return userId || null;
  } catch {
    return null;
  }
}
function isOwnerKeyColumnError(error) {
  const msg = `${error?.message || ''} ${error?.details || ''}`;
  return /owner_key/i.test(msg) && /(column|schema|does not exist|unknown)/i.test(msg);
}
function createOwnerPayload(base) {
  return { ...base, device_id: getDeviceId(), owner_key: getOwnerKey() };
}
function getOwnedPostIdsKey(userId) {
  return `waseda_owned_post_ids_${userId}`;
}
function getCommentTrackedPostIdsKey(userId) {
  return `waseda_comment_tracked_post_ids_${userId}`;
}
function getOwnedNicknamesKey(userId) {
  return `waseda_owned_nicknames_${userId}`;
}
function getOwnedPostIds(userId) {
  if (!userId) return [];
  try {
    const parsed = JSON.parse(localStorage.getItem(getOwnedPostIdsKey(userId)) || '[]');
    return Array.isArray(parsed) ? parsed : [];
  } catch {
    return [];
  }
}
function rememberOwnedPostId(postId, userId) {
  if (!postId || !userId) return;
  rememberLastAuthUserId(userId);
  const set = new Set(getOwnedPostIds(userId).map(String));
  set.add(String(postId));
  const arr = [...set];
  if (arr.length > 500) arr.splice(0, arr.length - 500);
  localStorage.setItem(getOwnedPostIdsKey(userId), JSON.stringify(arr));
}
function getCommentTrackedPostIds(userId) {
  if (!userId) return [];
  try {
    const parsed = JSON.parse(localStorage.getItem(getCommentTrackedPostIdsKey(userId)) || '[]');
    return Array.isArray(parsed) ? parsed : [];
  } catch {
    return [];
  }
}
function rememberCommentTrackedPostId(postId, userId) {
  if (!postId || !userId) return;
  rememberLastAuthUserId(userId);
  const set = new Set(getCommentTrackedPostIds(userId).map(String));
  set.add(String(postId));
  const arr = [...set];
  if (arr.length > 500) arr.splice(0, arr.length - 500);
  localStorage.setItem(getCommentTrackedPostIdsKey(userId), JSON.stringify(arr));
}
function getOwnedNicknames(userId) {
  if (!userId) return [];
  try {
    const parsed = JSON.parse(localStorage.getItem(getOwnedNicknamesKey(userId)) || '[]');
    return Array.isArray(parsed) ? parsed : [];
  } catch {
    return [];
  }
}
function rememberOwnedNickname(nickname, userId) {
  const nick = (nickname || '').trim();
  if (!nick || !userId) return;
  rememberLastAuthUserId(userId);
  const set = new Set(getOwnedNicknames(userId).map(v => String(v).trim()).filter(Boolean));
  set.add(nick);
  const arr = [...set];
  if (arr.length > 100) arr.splice(0, arr.length - 100);
  localStorage.setItem(getOwnedNicknamesKey(userId), JSON.stringify(arr));
}
function getAccountNicknameCandidates(user) {
  const set = new Set();
  const localNick = (localStorage.getItem('waseda_nickname') || '').trim();
  const currentNick = (currentUser || '').trim();
  const displayNick = getGoogleDisplayName(user || googleAuthUser).trim();
  [localNick, currentNick, displayNick].forEach(v => {
    if (v && v !== 'ã‚²ã‚¹ãƒˆ') set.add(v);
  });
  if (user?.id) getOwnedNicknames(user.id).forEach(v => { if (v) set.add(String(v)); });
  return [...set];
}
function removeOwnedPostId(postId, userId) {
  if (!postId || !userId) return;
  rememberLastAuthUserId(userId);
  const set = new Set(getOwnedPostIds(userId).map(String));
  set.delete(String(postId));
  localStorage.setItem(getOwnedPostIdsKey(userId), JSON.stringify([...set]));
}
function getPreferredNickname() {
  const saved = (localStorage.getItem('waseda_nickname') || '').trim();
  if (saved && saved !== 'ã‚²ã‚¹ãƒˆ') return saved;
  if (googleAuthUser) return getGoogleDisplayName(googleAuthUser).trim().slice(0, 20);
  return '';
}
function saveJukenDraftBeforeAuth() {
  const draft = {
    tab: currentTab,
    fields: {},
    authModes: {
      qa: getSelectedAuthMode('qa'),
      qaLife: getSelectedAuthMode('qaLife'),
      board: getSelectedAuthMode('board')
    }
  };
  const ids = [
    'qa-author', 'qa-faculty', 'qa-title', 'qa-body',
    'qa-life-author', 'qa-life-faculty', 'qa-life-title', 'qa-life-body',
    'boardNickname', 'boardFaculty', 'boardType', 'boardBody'
  ];
  ids.forEach(id => {
    const el = document.getElementById(id);
    if (el) draft.fields[id] = el.value;
  });
  const draftStr = JSON.stringify(draft);
  const nowTs = String(Date.now());
  sessionStorage.setItem(JUKEN_AUTH_DRAFT_KEY, draftStr);
  sessionStorage.setItem(JUKEN_AUTH_RETURN_KEY, '1');
  sessionStorage.setItem(JUKEN_AUTH_DRAFT_TS_KEY, nowTs);
  localStorage.setItem(JUKEN_AUTH_DRAFT_KEY, draftStr);
  localStorage.setItem(JUKEN_AUTH_RETURN_KEY, '1');
  localStorage.setItem(JUKEN_AUTH_DRAFT_TS_KEY, nowTs);
}
function restoreJukenDraftAfterAuthIfNeeded() {
  const shouldReturn = sessionStorage.getItem(JUKEN_AUTH_RETURN_KEY) === '1' || localStorage.getItem(JUKEN_AUTH_RETURN_KEY) === '1';
  if (!shouldReturn) return;
  if (!googleAuthUser?.id) return;

  const tsRaw = sessionStorage.getItem(JUKEN_AUTH_DRAFT_TS_KEY) || localStorage.getItem(JUKEN_AUTH_DRAFT_TS_KEY) || '0';
  const ageMs = Date.now() - Number(tsRaw || 0);
  if (Number.isFinite(ageMs) && ageMs > 10 * 60 * 1000) {
    sessionStorage.removeItem(JUKEN_AUTH_RETURN_KEY);
    sessionStorage.removeItem(JUKEN_AUTH_DRAFT_KEY);
    sessionStorage.removeItem(JUKEN_AUTH_DRAFT_TS_KEY);
    localStorage.removeItem(JUKEN_AUTH_RETURN_KEY);
    localStorage.removeItem(JUKEN_AUTH_DRAFT_KEY);
    localStorage.removeItem(JUKEN_AUTH_DRAFT_TS_KEY);
    return;
  }

  let draft = null;
  try {
    const draftStr = sessionStorage.getItem(JUKEN_AUTH_DRAFT_KEY) || localStorage.getItem(JUKEN_AUTH_DRAFT_KEY) || '{}';
    draft = JSON.parse(draftStr);
  } catch {
    draft = null;
  }

  sessionStorage.removeItem(JUKEN_AUTH_RETURN_KEY);
  sessionStorage.removeItem(JUKEN_AUTH_DRAFT_KEY);
  sessionStorage.removeItem(JUKEN_AUTH_DRAFT_TS_KEY);
  localStorage.removeItem(JUKEN_AUTH_RETURN_KEY);
  localStorage.removeItem(JUKEN_AUTH_DRAFT_KEY);
  localStorage.removeItem(JUKEN_AUTH_DRAFT_TS_KEY);

  if (!draft) return;

  if (draft.tab && typeof switchTab === 'function') switchTab(draft.tab);
  if (draft.fields) {
    Object.entries(draft.fields).forEach(([id, value]) => {
      const el = document.getElementById(id);
      if (el && typeof value === 'string') el.value = value;
    });
  }

  updateAuthModeSelectors();
}

function saveBoardCommentDraftBeforeAuth(postId) {
  const input = document.getElementById(`board-comment-input-${postId}`);
  const modeNode = document.querySelector(`input[name="boardCommentAuthMode-${postId}"]:checked`);
  const draft = {
    postId,
    authMode: modeNode?.value || 'guest',
    text: input?.value || ''
  };
  const draftStr = JSON.stringify(draft);
  const nowTs = String(Date.now());
  sessionStorage.setItem(BOARD_COMMENT_AUTH_DRAFT_KEY, draftStr);
  sessionStorage.setItem(BOARD_COMMENT_AUTH_RETURN_KEY, '1');
  sessionStorage.setItem(BOARD_COMMENT_AUTH_DRAFT_TS_KEY, nowTs);
  localStorage.setItem(BOARD_COMMENT_AUTH_DRAFT_KEY, draftStr);
  localStorage.setItem(BOARD_COMMENT_AUTH_RETURN_KEY, '1');
  localStorage.setItem(BOARD_COMMENT_AUTH_DRAFT_TS_KEY, nowTs);
}

async function restoreBoardCommentDraftAfterAuthIfNeeded() {
  const shouldReturn = sessionStorage.getItem(BOARD_COMMENT_AUTH_RETURN_KEY) === '1' || localStorage.getItem(BOARD_COMMENT_AUTH_RETURN_KEY) === '1';
  if (!shouldReturn) return;
  if (!googleAuthUser?.id) return;

  const tsRaw = sessionStorage.getItem(BOARD_COMMENT_AUTH_DRAFT_TS_KEY) || localStorage.getItem(BOARD_COMMENT_AUTH_DRAFT_TS_KEY) || '0';
  const ageMs = Date.now() - Number(tsRaw || 0);
  if (Number.isFinite(ageMs) && ageMs > 10 * 60 * 1000) {
    sessionStorage.removeItem(BOARD_COMMENT_AUTH_RETURN_KEY);
    sessionStorage.removeItem(BOARD_COMMENT_AUTH_DRAFT_KEY);
    sessionStorage.removeItem(BOARD_COMMENT_AUTH_DRAFT_TS_KEY);
    localStorage.removeItem(BOARD_COMMENT_AUTH_RETURN_KEY);
    localStorage.removeItem(BOARD_COMMENT_AUTH_DRAFT_KEY);
    localStorage.removeItem(BOARD_COMMENT_AUTH_DRAFT_TS_KEY);
    return;
  }

  let draft = null;
  try {
    const draftStr = sessionStorage.getItem(BOARD_COMMENT_AUTH_DRAFT_KEY) || localStorage.getItem(BOARD_COMMENT_AUTH_DRAFT_KEY) || '{}';
    draft = JSON.parse(draftStr);
  } catch {
    draft = null;
  }

  sessionStorage.removeItem(BOARD_COMMENT_AUTH_RETURN_KEY);
  sessionStorage.removeItem(BOARD_COMMENT_AUTH_DRAFT_KEY);
  sessionStorage.removeItem(BOARD_COMMENT_AUTH_DRAFT_TS_KEY);
  localStorage.removeItem(BOARD_COMMENT_AUTH_RETURN_KEY);
  localStorage.removeItem(BOARD_COMMENT_AUTH_DRAFT_KEY);
  localStorage.removeItem(BOARD_COMMENT_AUTH_DRAFT_TS_KEY);

  if (!draft?.postId) return;
  await openBoardDetail(draft.postId);
  const loginRadio = document.getElementById(`boardCommentAuthLogin-${draft.postId}`);
  const guestRadio = document.getElementById(`boardCommentAuthGuest-${draft.postId}`);
  if (loginRadio) loginRadio.checked = true;
  if (guestRadio) guestRadio.checked = false;
  const input = document.getElementById(`board-comment-input-${draft.postId}`);
  if (input && typeof draft.text === 'string') input.value = draft.text;
  updateBoardCommentAuthModeUI(draft.postId);
}

function getBoardCommentAuthMode(postId) {
  const checked = document.querySelector(`input[name="boardCommentAuthMode-${postId}"]:checked`);
  return checked?.value || 'guest';
}

function updateBoardCommentAuthModeUI(postId) {
  const optionsWrap = document.getElementById(`boardCommentAuthOptions-${postId}`);
  const loginWrap = document.getElementById(`boardCommentAuthLoginActions-${postId}`);
  const loginRadio = document.getElementById(`boardCommentAuthLogin-${postId}`);
  const guestRadio = document.getElementById(`boardCommentAuthGuest-${postId}`);
  if (!optionsWrap || !loginWrap || !loginRadio || !guestRadio) return;

  if (googleAuthUser?.id) {
    loginRadio.checked = true;
    guestRadio.checked = false;
    optionsWrap.style.display = 'none';
    loginWrap.style.display = 'none';
    return;
  }

  if (!loginRadio.checked && !guestRadio.checked) guestRadio.checked = true;
  optionsWrap.style.display = 'flex';
  loginWrap.style.display = loginRadio.checked ? 'block' : 'none';
}

async function handleBoardCommentLoginClick(postId) {
  saveBoardCommentDraftBeforeAuth(postId);
  await handleGoogleAuthClick('comment');
}
function syncNicknameFromGoogle() {
  if (!googleAuthUser) return;
  const saved = (localStorage.getItem('waseda_nickname') || '').trim();
  if (saved && saved !== 'ã‚²ã‚¹ãƒˆ') return;
  const display = getGoogleDisplayName(googleAuthUser).trim();
  if (!display) return;
  localStorage.setItem('waseda_nickname', display.slice(0, 20));
}
function fillNicknameInputs() {
  const nick = getPreferredNickname();
  if (!nick) return;
  ['qa-author', 'qa-life-author', 'boardNickname'].forEach(id => {
    const el = document.getElementById(id);
    if (el && !el.value.trim()) el.value = nick;
  });
}
async function getResolvedAuthUser() {
  if (googleAuthUser?.id) return googleAuthUser;
  if (!db?.auth) return null;
  try {
    const { data, error } = await db.auth.getSession();
    if (error) return null;
    let user = data?.session?.user || null;
    if (!user?.id) {
      try {
        const { data: userData, error: userError } = await db.auth.getUser();
        if (!userError && userData?.user?.id) user = userData.user;
      } catch {}
    }
    if (user?.id) {
      googleAuthUser = user;
      rememberLastAuthUserId(user);
    }
    return user;
  } catch {
    return null;
  }
}
function getSelectedAuthMode(formKey) {
  const checked = document.querySelector(`input[name="postAuthMode-${formKey}"]:checked`);
  return checked?.value || 'guest';
}
function updateAuthModeSelectors() {
  const pairs = [
    { key: 'qa', container: 'authOptionsQa', login: 'qaAuthLogin', guest: 'qaAuthGuest', actions: 'authLoginActionsQa' },
    { key: 'qaLife', container: 'authOptionsQaLife', login: 'qaLifeAuthLogin', guest: 'qaLifeAuthGuest', actions: 'authLoginActionsQaLife' },
    { key: 'board', container: 'authOptionsBoard', login: 'boardAuthLogin', guest: 'boardAuthGuest', actions: 'authLoginActionsBoard' }
  ];
  pairs.forEach(({ container, login, guest, actions }) => {
    const wrap = document.getElementById(container);
    const loginRadio = document.getElementById(login);
    const guestRadio = document.getElementById(guest);
    const actionWrap = document.getElementById(actions);
    if (!wrap || !loginRadio || !guestRadio) return;
    if (googleAuthUser?.id) {
      loginRadio.checked = true;
      guestRadio.checked = false;
      wrap.style.display = 'none';
      if (actionWrap) actionWrap.style.display = 'none';
    } else {
      wrap.style.display = 'flex';
      if (!loginRadio.checked && !guestRadio.checked) guestRadio.checked = true;
      if (actionWrap) actionWrap.style.display = loginRadio.checked ? 'block' : 'none';
    }
  });
}
async function resolvePostAuthMode(formKey = null) {
  const resolvedUser = await getResolvedAuthUser();
  if (resolvedUser?.id) return { mode: 'login', user: resolvedUser };

  if (!formKey) {
    const useLogin = confirm('æŠ•ç¨¿æ–¹æ³•ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚\nOK: ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦æŠ•ç¨¿ï¼ˆç¢ºèªãƒ»å‰Šé™¤ãƒ»ãƒã‚¤ãƒšãƒ¼ã‚¸å¯¾å¿œï¼‰\nã‚­ãƒ£ãƒ³ã‚»ãƒ«: ãƒ­ã‚°ã‚¤ãƒ³ã›ãšæŠ•ç¨¿ï¼ˆç®¡ç†å¯¾è±¡å¤–ï¼‰');
    if (useLogin) {
      alert('Googleãƒ­ã‚°ã‚¤ãƒ³å¾Œã«ã€ã‚‚ã†ä¸€åº¦æŠ•ç¨¿ã—ã¦ãã ã•ã„ã€‚');
      await handleGoogleAuthClick();
      return null;
    }
    return { mode: 'guest', user: null };
  }

  const selectedMode = getSelectedAuthMode(formKey);
  if (selectedMode === 'login') {
    alert('Googleãƒ­ã‚°ã‚¤ãƒ³å¾Œã«ã€ã‚‚ã†ä¸€åº¦æŠ•ç¨¿ã—ã¦ãã ã•ã„ã€‚');
    await handleGoogleAuthClick('post-form');
    return null;
  }
  return { mode: 'guest', user: null };
}
function isMyContent(item, myIds) {
  if (!item) return false;
  const userId = googleAuthUser?.id || getLastAuthUserId();
  const owner = String(item.owner_key || '').trim();
  if (userId && (owner === `auth:${userId}` || owner === userId)) return true;
  const effectiveMyIds = myIds || (userId ? new Set(getOwnedPostIds(userId).map(String)) : null);
  if (effectiveMyIds && effectiveMyIds.has(String(item.id))) return true;
  const nick = getPreferredNickname();
  if (nick && item.author === nick) return true;
  if (!owner && item.device_id && item.device_id === getDeviceId()) return true;
  return false;
}
function getGoogleDisplayName(user) {
  return user?.user_metadata?.name || user?.user_metadata?.full_name || user?.email || 'ãƒ­ã‚°ã‚¤ãƒ³ä¸­ãƒ¦ãƒ¼ã‚¶ãƒ¼';
}
function getAuthRedirectUrl() {
  try {
    const url = new URL(window.location.href);
    const isHttp = url.protocol === 'http:' || url.protocol === 'https:';
    const isTrustedHost = TRUSTED_AUTH_HOSTS.includes(url.hostname);
    if (isHttp && isTrustedHost) return `${url.origin}${url.pathname}`;
  } catch (e) {
    console.warn('redirect URL parse failed:', e);
  }
  return AUTH_REDIRECT_URL;
}
function scheduleJukenDraftRestoreChecks() {
  [0, 250, 800, 1500].forEach(ms => setTimeout(() => restoreJukenDraftAfterAuthIfNeeded(), ms));
}
function renderGoogleAuthButton() {
  const btn = document.getElementById('googleAuthBtn');
  if (!btn) return;
  if (googleAuthUser) {
    btn.classList.add('logged-in');
    btn.innerHTML = `<span class="google-g">G</span><span class="google-user-name">${escHtml(getGoogleDisplayName(googleAuthUser))}</span>`;
    btn.title = 'ã‚¯ãƒªãƒƒã‚¯ã§ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ';
  } else {
    btn.classList.remove('logged-in');
    btn.textContent = 'Googleã§ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆæŠ•ç¨¿ç®¡ç†ï¼‰';
    btn.title = 'ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¨æŠ•ç¨¿ã‚’ç¢ºèªãƒ»å‰Šé™¤ã§ãã¾ã™';
  }
  renderAccountSummary();
}
function renderAccountSummary() {
  const nick = document.getElementById('nicknameBadge');
  const myPageBtn = document.getElementById('myPageBtn');
  if (nick) {
    const name = (currentUser || '').trim();
    nick.textContent = name && name !== 'ã‚²ã‚¹ãƒˆ' ? `ğŸ‘¤ ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ : ${name}` : 'ğŸ‘¤ ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’è¨­å®š';
  }
  if (myPageBtn) {
    myPageBtn.textContent = googleAuthUser ? 'ğŸ“Œ ãƒã‚¤ãƒšãƒ¼ã‚¸ï¼ˆæŠ•ç¨¿ç®¡ç†ONï¼‰' : 'ğŸ“Œ ãƒã‚¤ãƒšãƒ¼ã‚¸ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ã§æŠ•ç¨¿ç®¡ç†ï¼‰';
  }
  renderMyPageNotificationBadge();
  updateAuthHints();
}

function getMyPageNotifyStateKey(userId) {
  return `${MY_PAGE_NOTIFY_PREFIX}${userId}`;
}
function getEmptyNotifySnapshot() {
  return { posts: {}, answers: {}, comments: {}, updatedAt: new Date().toISOString() };
}
function readMyPageNotifySnapshot(userId) {
  if (!userId) return null;
  try {
    const raw = localStorage.getItem(getMyPageNotifyStateKey(userId));
    if (!raw) return null;
    const parsed = JSON.parse(raw);
    if (!parsed || typeof parsed !== 'object') return null;
    return {
      posts: parsed.posts && typeof parsed.posts === 'object' ? parsed.posts : {},
      answers: parsed.answers && typeof parsed.answers === 'object' ? parsed.answers : {},
      comments: parsed.comments && typeof parsed.comments === 'object' ? parsed.comments : {},
      updatedAt: parsed.updatedAt || null
    };
  } catch {
    return null;
  }
}
function writeMyPageNotifySnapshot(userId, snapshot) {
  if (!userId || !snapshot) return;
  try { localStorage.setItem(getMyPageNotifyStateKey(userId), JSON.stringify(snapshot)); } catch {}
}
function renderMyPageNotificationBadge() {
  const myPageBtn = document.getElementById('myPageBtn');
  if (!myPageBtn) return;
  const count = Number(myPageNotifyCount) || 0;
  if (count > 0) {
    myPageBtn.dataset.notifyCount = count > 99 ? '99+' : String(count);
    myPageBtn.classList.add('has-notification');
  } else {
    delete myPageBtn.dataset.notifyCount;
    myPageBtn.classList.remove('has-notification');
  }
}
function calcNotifyDelta(current, seen) {
  let total = 0;
  const curr = current || getEmptyNotifySnapshot();
  const base = seen || getEmptyNotifySnapshot();
  Object.keys(curr.posts || {}).forEach(id => {
    const c = curr.posts[id] || {};
    const b = (base.posts || {})[id] || {};
    total += Math.max(0, Number(c.likes || 0) - Number(b.likes || 0));
    total += Math.max(0, Number(c.comments || 0) - Number(b.comments || 0));
    total += Math.max(0, Number(c.answers || 0) - Number(b.answers || 0));
  });
  Object.keys(curr.answers || {}).forEach(id => {
    const c = curr.answers[id] || {};
    const b = (base.answers || {})[id] || {};
    total += Math.max(0, Number(c.likes || 0) - Number(b.likes || 0));
  });
  Object.keys(curr.comments || {}).forEach(id => {
    const c = curr.comments[id] || {};
    const b = (base.comments || {})[id] || {};
    total += Math.max(0, Number(c.likes || 0) - Number(b.likes || 0));
  });
  return total;
}
async function queryRowsWithLikeFallback(table, selectWithLikes, selectWithoutLikes, applyQuery) {
  let { data, error } = await applyQuery(db.from(table).select(selectWithLikes));
  if (error && isLikesColumnError(error)) {
    ({ data, error } = await applyQuery(db.from(table).select(selectWithoutLikes)));
  }
  return { data: data || [], error };
}
async function fetchOwnedInteractionRows(table, trackingUserId, nicknameCandidates = []) {
  const merged = new Map();
  let ownerKeyUsable = true;
  const ownerKeys = [`auth:${trackingUserId}`, trackingUserId];

  for (const key of ownerKeys) {
    const { data, error } = await queryRowsWithLikeFallback(
      table,
      'id,likes,author,owner_key,device_id',
      'id,author,owner_key,device_id',
      q => q.eq('owner_key', key).limit(300)
    );
    if (error) {
      if (isOwnerKeyColumnError(error)) {
        ownerKeyUsable = false;
        break;
      }
      throw error;
    }
    (data || []).forEach(row => merged.set(String(row.id), row));
  }

  const nicknameSet = new Set((nicknameCandidates || []).map(v => String(v).trim()).filter(Boolean));
  const fallbackSelectWithOwner = ownerKeyUsable ? 'id,likes,author,owner_key,device_id' : 'id,likes,author,device_id';
  const fallbackSelectWithoutLikes = ownerKeyUsable ? 'id,author,owner_key,device_id' : 'id,author,device_id';
  const { data: deviceRows, error: deviceErr } = await queryRowsWithLikeFallback(
    table,
    fallbackSelectWithOwner,
    fallbackSelectWithoutLikes,
    q => q.eq('device_id', getDeviceId()).limit(300)
  );
  if (deviceErr) throw deviceErr;
  (deviceRows || []).forEach(row => {
    const owner = String(row.owner_key || '').trim();
    if (owner && owner !== `auth:${trackingUserId}` && owner !== trackingUserId) return;
    if (nicknameSet.size) {
      const author = String(row.author || '').trim();
      if (!author || !nicknameSet.has(author)) return;
    }
    merged.set(String(row.id), row);
  });

  return [...merged.values()];
}
async function collectMyPageNotifySnapshot(trackingUserId, resolvedUser) {
  const snapshot = getEmptyNotifySnapshot();
  if (!db || !trackingUserId) return snapshot;

  const postMap = new Map();
  const ownerKeys = [`auth:${trackingUserId}`, trackingUserId];
  for (const key of ownerKeys) {
    const { data, error } = await db.from('posts').select('id,likes,comments,owner_key').eq('owner_key', key).limit(300);
    if (error) {
      if (isOwnerKeyColumnError(error)) break;
      throw error;
    }
    (data || []).forEach(row => postMap.set(String(row.id), row));
  }

  const localOwnedIds = getOwnedPostIds(trackingUserId).filter(Boolean);
  if (localOwnedIds.length) {
    const { data: localPosts, error: localErr } = await db.from('posts').select('id,likes,comments').in('id', localOwnedIds).limit(400);
    if (!localErr && Array.isArray(localPosts)) {
      localPosts.forEach(row => postMap.set(String(row.id), row));
    }
  }

  const postIds = [...postMap.keys()];
  const ansMap = await fetchAnswerCountsByPostIds(postIds);
  postIds.forEach(id => {
    const row = postMap.get(id) || {};
    snapshot.posts[id] = {
      likes: Number(row.likes || 0),
      comments: Number(row.comments || 0),
      answers: Number(ansMap[id] || 0)
    };
  });

  const nicknameCandidates = getAccountNicknameCandidates(resolvedUser || { id: trackingUserId });
  const answerRows = await fetchOwnedInteractionRows('answers', trackingUserId, nicknameCandidates);
  answerRows.forEach(row => {
    snapshot.answers[String(row.id)] = { likes: Number(row.likes || 0) };
  });

  const commentRows = await fetchOwnedInteractionRows('comments', trackingUserId, nicknameCandidates);
  commentRows.forEach(row => {
    snapshot.comments[String(row.id)] = { likes: Number(row.likes || 0) };
  });

  snapshot.updatedAt = new Date().toISOString();
  return snapshot;
}
async function refreshMyPageNotificationCount(options = {}) {
  const { markAsRead = false } = options;
  if (!db || myPageNotifyInFlight) return;
  myPageNotifyInFlight = true;
  try {
    const resolvedUser = await getResolvedAuthUser();
    const trackingUserId = resolvedUser?.id || getLastAuthUserId();
    if (!trackingUserId) {
      myPageNotifyCount = 0;
      renderMyPageNotificationBadge();
      return;
    }

    const currentSnapshot = await collectMyPageNotifySnapshot(trackingUserId, resolvedUser);
    const seenSnapshot = readMyPageNotifySnapshot(trackingUserId);
    if (!seenSnapshot || markAsRead) {
      writeMyPageNotifySnapshot(trackingUserId, currentSnapshot);
      myPageNotifyCount = 0;
    } else {
      myPageNotifyCount = calcNotifyDelta(currentSnapshot, seenSnapshot);
    }
    renderMyPageNotificationBadge();
  } catch (e) {
    console.warn('refreshMyPageNotificationCount failed', e);
  } finally {
    myPageNotifyInFlight = false;
  }
}
function startMyPageNotificationPolling() {
  if (myPageNotifyTimer) return;
  myPageNotifyTimer = setInterval(() => {
    refreshMyPageNotificationCount();
  }, MY_PAGE_NOTIFY_INTERVAL_MS);
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') refreshMyPageNotificationCount();
  });
}

function updateAuthHints() {
  const msg = googleAuthUser
    ? 'ç¾åœ¨ã¯ãƒ­ã‚°ã‚¤ãƒ³æŠ•ç¨¿ãƒ¢ãƒ¼ãƒ‰ã§ã™ã€‚æŠ•ç¨¿ã¯è‡ªå‹•ã§ç¢ºèªãƒ»å‰Šé™¤ãƒ»ãƒã‚¤ãƒšãƒ¼ã‚¸å¯¾å¿œã«ãªã‚Šã¾ã™ã€‚'
    : 'ã‚²ã‚¹ãƒˆæŠ•ç¨¿: ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ æŠ•ç¨¿ã¯ã§ãã¾ã™ãŒã€ç®¡ç†ãƒ»å‰Šé™¤ãƒ»ãƒã‚¤ãƒšãƒ¼ã‚¸è¡¨ç¤ºã¯ã§ãã¾ã›ã‚“ã€‚';
  ['authHintQa', 'authHintQaLife', 'authHintBoard'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.textContent = msg;
  });
  updateAuthModeSelectors();
}
async function handleGoogleAuthClick(source = 'header') {
  if (!db?.auth) { alert('ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ã‚’åˆæœŸåŒ–ã§ãã¾ã›ã‚“ã§ã—ãŸ'); return; }
  if (googleAuthUser) {
    const { error } = await db.auth.signOut();
    if (error) alert('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
    return;
  }
  if (source === 'post-form') saveJukenDraftBeforeAuth();
  const redirectTo = getAuthRedirectUrl();
  const { data, error } = await db.auth.signInWithOAuth({
    provider: 'google',
    options: { redirectTo }
  });
  try {
    localStorage.setItem('waseda_last_oauth_result', JSON.stringify({
      at: new Date().toISOString(),
      href: window.location.href,
      redirectTo,
      data: data || null,
      error: error ? {
        name: error.name || null,
        message: error.message || null,
        status: error.status || null,
        code: error.code || null,
        details: error.details || null,
        hint: error.hint || null
      } : null
    }, null, 2));
  } catch {}
  if (error) {
    const errorDump = JSON.stringify({
      name: error.name || null,
      message: error.message || null,
      status: error.status || null,
      code: error.code || null,
      details: error.details || null,
      hint: error.hint || null
    }, null, 2);
    console.error('signInWithOAuth failed', { redirectTo, error, data });
    alert('Googleãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\n[è¿”å´ã‚¨ãƒ©ãƒ¼è©³ç´°]\n' + errorDump + '\n\n[redirectTo]\n' + redirectTo);
    return;
  }
  console.info('signInWithOAuth succeeded', { redirectTo, data });
}
async function initGoogleAuth() {
  if (!db?.auth) return;

  const { data } = await db.auth.getSession();
  googleAuthUser = data?.session?.user || null;
  if (googleAuthUser?.id) rememberLastAuthUserId(googleAuthUser);
  syncNicknameFromGoogle();
  renderGoogleAuthButton();
  restoreJukenDraftAfterAuthIfNeeded();
  restoreBoardCommentDraftAfterAuthIfNeeded();
  refreshMyPageNotificationCount();
  startMyPageNotificationPolling();

  db.auth.onAuthStateChange((_event, session) => {
    googleAuthUser = session?.user || null;
    if (googleAuthUser?.id) rememberLastAuthUserId(googleAuthUser);
    syncNicknameFromGoogle();
    renderGoogleAuthButton();
    restoreJukenDraftAfterAuthIfNeeded();
    restoreBoardCommentDraftAfterAuthIfNeeded();
    refreshMyPageNotificationCount();
  });
}
function updateNicknameBadge() { renderAccountSummary(); }
function openNicknameModal() {
  const input = document.getElementById('nicknameInput');
  if (!input) return;
  input.value = currentUser === 'ã‚²ã‚¹ãƒˆ' && googleAuthUser ? getGoogleDisplayName(googleAuthUser).slice(0,20) : (currentUser === 'ã‚²ã‚¹ãƒˆ' ? '' : currentUser);
  document.getElementById('nicknameModal').classList.add('open');
}
function closeNicknameModal() { document.getElementById('nicknameModal').classList.remove('open'); }
function saveNickname() {
  const val = (document.getElementById('nicknameInput')?.value || '').trim();
  if (!val) { alert('ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  currentUser = val;
  localStorage.setItem('waseda_nickname', val);
  if (googleAuthUser?.id) rememberOwnedNickname(val, googleAuthUser.id);
  fillNicknameInputs();
  updateNicknameBadge();
  closeNicknameModal();
}
async function openMyPageModal() {
  document.getElementById('myPageModal').classList.add('open');
  await refreshMyPageNotificationCount({ markAsRead: true });
  loadMyPagePosts();
}
function closeMyPageModal() { document.getElementById('myPageModal').classList.remove('open'); }
async function loadMyPagePosts() {
  const summaryEl = document.getElementById('myPageSummary');
  const listEl = document.getElementById('myPageList');
  if (!summaryEl || !listEl) return;
  if (!db) { summaryEl.textContent = 'DBæœªæ¥ç¶š'; listEl.innerHTML = ''; return; }
  const resolvedUser = await getResolvedAuthUser();
  const trackingUserId = resolvedUser?.id || getLastAuthUserId();
  if (!trackingUserId) {
    summaryEl.textContent = 'ãƒã‚¤ãƒšãƒ¼ã‚¸ã¯ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘æ©Ÿèƒ½ã§ã™';
    listEl.innerHTML = '<div style="text-align:center;color:var(--gray);padding:1rem 0;">ãƒ­ã‚°ã‚¤ãƒ³æŠ•ç¨¿ã®ã¿ç¢ºèªãƒ»å‰Šé™¤ã§ãã¾ã™ã€‚</div>';
    return;
  }
  try {
    summaryEl.textContent = 'èª­ã¿è¾¼ã¿ä¸­...';
    const ownerKey = `auth:${trackingUserId}`;
    let rows = [];
    const { data, error } = await db.from('posts').select('*').eq('owner_key', ownerKey).order('created_at',{ascending:false}).limit(120);
    if (error && !isOwnerKeyColumnError(error)) throw error;
    rows = data || [];
    if (!rows.length) {
      const { data: legacyRows, error: legacyErr } = await db.from('posts').select('*').eq('owner_key', trackingUserId).order('created_at',{ascending:false}).limit(120);
      if (!legacyErr && Array.isArray(legacyRows) && legacyRows.length) rows = legacyRows;
    }
    const localIds = getOwnedPostIds(trackingUserId);
    if (localIds.length) {
      const { data: localRows, error: localErr } = await db.from('posts').select('*').in('id', localIds).limit(200);
      if (!localErr && Array.isArray(localRows)) {
        const merged = new Map();
        rows.forEach(p => merged.set(String(p.id), p));
        localRows.forEach(p => merged.set(String(p.id), p));
        rows = [...merged.values()];
      }
    }

    const nicknameCandidates = getAccountNicknameCandidates(resolvedUser || { id: trackingUserId }).map(v => String(v).trim().toLowerCase()).filter(Boolean);
    const nicknameSet = new Set(nicknameCandidates);
    const { data: deviceRows, error: deviceErr } = await db.from('posts').select('*').eq('device_id', getDeviceId()).order('created_at',{ascending:false}).limit(200);
    if (deviceErr) throw deviceErr;
    if (Array.isArray(deviceRows) && deviceRows.length) {
      const legacyRows = deviceRows.filter(p => {
        const owner = (p.owner_key || '').trim();
        if (owner === ownerKey || owner === resolvedUser.id) return true;
        if (owner) return false;
        const authorLower = String(p.author || '').trim().toLowerCase();
        if (!authorLower) return true;
        if (!nicknameSet.size) return true;
        return nicknameSet.has(authorLower);
      });

      const adoptIds = legacyRows.filter(p => !p.owner_key).map(p => p.id).filter(Boolean);
      if (adoptIds.length) {
        try {
          const { error: adoptErr } = await db.from('posts').update({ owner_key: ownerKey }).in('id', adoptIds).is('owner_key', null);
          if (adoptErr && !isOwnerKeyColumnError(adoptErr)) console.warn('owner adopt failed', adoptErr);
        } catch (e) {
          console.warn('owner adopt exception', e);
        }
      }

      const merged = new Map(rows.map(p => [String(p.id), p]));
      legacyRows.forEach(p => {
        if (!p.owner_key) p.owner_key = ownerKey;
        merged.set(String(p.id), p);
        rememberOwnedPostId(p.id, trackingUserId);
        if (p.author) rememberOwnedNickname(p.author, trackingUserId);
      });
      rows = [...merged.values()];
    }

    const mergedRowsMap = new Map(rows.map(p => [String(p.id), p]));
    const trackedCommentPostIds = getCommentTrackedPostIds(trackingUserId).filter(Boolean);
    if (trackedCommentPostIds.length) {
      const { data: trackedRows, error: trackedErr } = await db.from('posts').select('*').in('id', trackedCommentPostIds).limit(300);
      if (!trackedErr && Array.isArray(trackedRows)) {
        trackedRows.forEach(p => {
          const key = String(p.id);
          if (!mergedRowsMap.has(key)) mergedRowsMap.set(key, { ...p, __commentTracked: true });
        });
      }
    }

    rows = [...mergedRowsMap.values()].sort((a,b)=>new Date(b.created_at||0)-new Date(a.created_at||0));
    const ownPostCount = rows.filter(p => !p.__commentTracked).length;
    const trackedPostCount = rows.filter(p => !!p.__commentTracked).length;
    const trackingMode = resolvedUser?.id ? 'Googleé€£æº' : 'ãƒ­ãƒ¼ã‚«ãƒ«ç®¡ç†ï¼ˆå†ãƒ­ã‚°ã‚¤ãƒ³æ¨å¥¨ï¼‰';
    summaryEl.textContent = `${trackingMode} | ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ : @${localStorage.getItem('waseda_nickname') || 'æœªè¨­å®š'} | æŠ•ç¨¿æ•°: ${ownPostCount} | ã‚³ãƒ¡ãƒ³ãƒˆå…ˆ: ${trackedPostCount}`;
    if (!rows.length) { listEl.innerHTML = '<div style="text-align:center;color:var(--gray);padding:1rem 0;">ã¾ã ã‚ãªãŸã®æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“</div>'; return; }
    listEl.innerHTML = rows.map(p => {
      const isQa = p.category === 'juken_qa' || p.category === 'juken_life_qa';
      const isCommentTracked = !!p.__commentTracked;
      const openAction = isQa
        ? `closeMyPageModal();openQaDetail(${JSON.stringify(p.id)})`
        : `closeMyPageModal();openBoardDetail(${JSON.stringify(p.id)})`;
      const canDelete = !isCommentTracked;
      const categoryLabel = `${p.category || 'æŠ•ç¨¿'}${isCommentTracked ? ' / ã‚³ãƒ¡ãƒ³ãƒˆå…ˆ' : ''}`;
      return `<div style="border:1px solid var(--border);border-radius:8px;padding:.8rem;margin-bottom:.6rem;">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:.6rem;flex-wrap:wrap;">
          <span style="font-size:.72rem;color:var(--gray);background:var(--crimson-pale);padding:2px 8px;border-radius:999px;">${escHtml(categoryLabel)}</span>
          <span style="font-size:.73rem;color:var(--gray-light);">${formatTime(p.created_at)}</span>
        </div>
        <div style="margin-top:.4rem;font-size:.88rem;font-weight:700;color:var(--dark);">${escHtml(p.title || '(ã‚¿ã‚¤ãƒˆãƒ«ãªã—)')}</div>
        <div style="margin-top:.2rem;font-size:.8rem;color:var(--gray);">${escHtml((p.body||'').slice(0,120))}</div>
        <div style="margin-top:.55rem;display:flex;gap:.5rem;justify-content:flex-end;">
          <button class="btn-submit" style="margin-top:0;padding:6px 10px;font-size:.74rem;" onclick="${openAction}">è©³ç´°</button>
          ${canDelete ? `<button class="btn-submit" style="margin-top:0;padding:6px 10px;font-size:.74rem;background:#9b1c1c;" onclick="deleteMyPagePost(${JSON.stringify(p.id)})">å‰Šé™¤</button>` : ''}
        </div>
      </div>`;
    }).join('');
  } catch (e) {
    console.error(e);
    summaryEl.textContent = 'èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ';
    listEl.innerHTML = '';
  }
}
async function deleteMyPagePost(postId) {
  if (!confirm('ã“ã®æŠ•ç¨¿ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
  const resolvedUser = await getResolvedAuthUser();
  const trackingUserId = resolvedUser?.id || getLastAuthUserId();
  if (!trackingUserId || !resolvedUser?.id) {
    alert('å‰Šé™¤ã«ã¯Googleãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚å†ãƒ­ã‚°ã‚¤ãƒ³å¾Œã«ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
    return;
  }
  try {
    let target = null;
    let hasOwnerKeyColumn = true;
    const { data: targetWithOwner, error: getErr } = await db.from('posts').select('id,owner_key,device_id,category,author').eq('id', postId).single();
    if (getErr) {
      if (!isOwnerKeyColumnError(getErr)) throw getErr;
      hasOwnerKeyColumn = false;
      const { data: targetFallback, error: fallbackErr } = await db.from('posts').select('id,device_id,category,author').eq('id', postId).single();
      if (fallbackErr) throw fallbackErr;
      target = { ...(targetFallback || {}), owner_key: null };
    } else {
      target = targetWithOwner;
    }
    const ownerKey = `auth:${trackingUserId}`;
    const isLegacyOwner = target?.owner_key === trackingUserId;
    const isDeviceLegacy = !target?.owner_key && target?.device_id && target.device_id === getDeviceId();
    const localOwnedSet = new Set(getOwnedPostIds(trackingUserId).map(String));
    const isOwnedByLocalRecord = localOwnedSet.has(String(postId));
    if (!(target?.owner_key === ownerKey || isLegacyOwner || isDeviceLegacy || isOwnedByLocalRecord)) { alert('ã“ã®æŠ•ç¨¿ã¯å‰Šé™¤ã§ãã¾ã›ã‚“'); return; }

    if (hasOwnerKeyColumn && (isDeviceLegacy || isLegacyOwner || isOwnedByLocalRecord) && target?.owner_key !== ownerKey) {
      try {
        const { error: adoptErr } = await db.from('posts').update({ owner_key: ownerKey }).eq('id', postId);
        if (adoptErr && !isOwnerKeyColumnError(adoptErr)) throw adoptErr;
      } catch (e) {
        throw e;
      }
    }

    const { error } = await db.from('posts').delete().eq('id', postId);
    if (error) throw error;
    removeOwnedPostId(postId, trackingUserId);
    if (target?.author) rememberOwnedNickname(target.author, trackingUserId);
    await loadMyPagePosts();
    if (target?.category === 'juken_life_qa') await loadQaList('life');
    else if (target?.category === 'juken_qa') await loadQaList('study');
    else if (target?.category === 'juken') await loadBoardPosts();
  } catch (e) {
    console.error(e);
    alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (e?.message || e?.code || 'unknown error'));
  }
}
function getMyQuestionIds() {
  try { return new Set(JSON.parse(localStorage.getItem('waseda_my_question_ids') || '[]')); }
  catch { return new Set(); }
}
function rememberMyQuestionId(id) {
  if (!id) return;
  const set = getMyQuestionIds();
  set.add(String(id));
  const arr = [...set];
  if (arr.length > 300) arr.splice(0, arr.length - 300);
  localStorage.setItem('waseda_my_question_ids', JSON.stringify(arr));
}
function getLikedPosts() { try{return new Set(JSON.parse(localStorage.getItem('waseda_liked')||'[]'));}catch{return new Set();} }
function setPostLiked(id,liked) { const s=getLikedPosts(); liked?s.add(String(id)):s.delete(String(id)); localStorage.setItem('waseda_liked',JSON.stringify([...s])); }

function isLikesColumnError(error) {
  const msg = `${error?.message || ''} ${error?.details || ''}`;
  return /likes/i.test(msg) && /(column|schema|does not exist|unknown)/i.test(msg);
}
function getEntityLikedSet(key) {
  try { return new Set(JSON.parse(localStorage.getItem(key) || '[]')); }
  catch { return new Set(); }
}
function setEntityLikedSet(key, setObj) {
  localStorage.setItem(key, JSON.stringify([...setObj]));
}
function getEntityLikeCountMap(key) {
  try {
    const parsed = JSON.parse(localStorage.getItem(key) || '{}');
    return parsed && typeof parsed === 'object' ? parsed : {};
  } catch {
    return {};
  }
}
function setEntityLikeCountMap(key, mapObj) {
  localStorage.setItem(key, JSON.stringify(mapObj));
}
function getAnswerLikeCount(answer) {
  if (typeof answer?.likes === 'number') return answer.likes;
  const map = getEntityLikeCountMap('waseda_answer_like_counts');
  return Number(map[String(answer?.id)] || 0);
}
async function likeAnswer(id, el) {
  try {
    if (!db) throw new Error('DBæœªæ¥ç¶š');
    const likedSet = getEntityLikedSet('waseda_liked_answers');
    const alreadyLiked = likedSet.has(String(id));
    const countEl = el && el.querySelector ? el.querySelector('.like-count') : null;
    const cur = countEl ? parseInt(countEl.textContent || '0') : 0;
    const next = alreadyLiked ? Math.max(0, cur - 1) : cur + 1;

    if (countEl) countEl.textContent = next;
    el.classList.toggle('liked', !alreadyLiked);
    if (alreadyLiked) likedSet.delete(String(id)); else likedSet.add(String(id));
    setEntityLikedSet('waseda_liked_answers', likedSet);

    const { error } = await db.from('answers').update({ likes: next }).eq('id', id);
    if (error) {
      if (isLikesColumnError(error)) {
        const map = getEntityLikeCountMap('waseda_answer_like_counts');
        map[String(id)] = next;
        setEntityLikeCountMap('waseda_answer_like_counts', map);
        return;
      }
      if (countEl) countEl.textContent = cur;
      el.classList.toggle('liked', alreadyLiked);
      if (alreadyLiked) likedSet.add(String(id)); else likedSet.delete(String(id));
      setEntityLikedSet('waseda_liked_answers', likedSet);
      throw error;
    }
  } catch (e) {
    console.error(e);
  }
}

// â”€â”€ ã‚¿ãƒ–åˆ‡æ›¿ â”€â”€
let currentTab = 'faculties-tab';
const loaded = new Set();

function switchTab(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.getElementById('panel-'+tab).classList.add('active');
  currentTab = tab;
  document.querySelector('.tabs').scrollIntoView({behavior:'smooth', block:'nearest'});
  // é…å»¶ãƒ­ãƒ¼ãƒ‰
  if (!loaded.has(tab)) { loaded.add(tab); loadTab(tab); }
}

function scrollTabsRight() {
  document.getElementById('tabsInner').scrollBy({ left: 140, behavior: 'smooth' });
}
function updateScrollBtn() {
  const inner = document.getElementById('tabsInner');
  const btn   = document.getElementById('tabsScrollBtn');
  if (!inner || !btn) return;
  const atEnd = inner.scrollLeft + inner.clientWidth >= inner.scrollWidth - 4;
  btn.classList.toggle('hidden', atEnd);
}

function loadTab(tab) {
  if (tab==='faculties-tab') { renderFacultyGrid(); loadFacultyComments(); }
  if (tab==='qa-tab')        { loadQaList('study'); buildFacultyFilter('qa-faculty-filter', (fac, el) => filterQa('study', fac, el)); }
  if (tab==='qa-life-tab')   { loadQaList('life'); buildFacultyFilter('qa-life-faculty-filter', (fac, el) => filterQa('life', fac, el)); }
  if (tab==='board-tab')     { loadBoardPosts(); buildFacultyFilter('board-faculty-filter', filterBoard2); }
  if (tab==='taikenki-tab')  { loadTaikenki(); buildFacultyFilter('tk-faculty-filter', filterTk); }
}

// â”€â”€ ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒãƒ¼ç”Ÿæˆ â”€â”€
function buildFacultyFilter(containerId, callback) {
  const el = document.getElementById(containerId);
  if (!el || el.children.length) return;
  const all = document.createElement('span');
  all.className = 'chip active'; all.textContent = 'ã™ã¹ã¦'; all.dataset.fac = 'all';
  all.onclick = () => callback('all', all);
  el.appendChild(all);
  Object.entries(FACULTIES).forEach(([k,v]) => {
    const c = document.createElement('span');
    c.className = 'chip'; c.textContent = v.replace('å­¦éƒ¨',''); c.dataset.fac = k;
    c.onclick = () => callback(k, c);
    el.appendChild(c);
  });
}
function setActiveChip(container, el) {
  document.querySelectorAll(`#${container} .chip`).forEach(c => c.classList.remove('active'));
  el.classList.add('active');
}

// â•â•â•â• å­¦éƒ¨ç´¹ä»‹ â•â•â•â•
let facultyCommentsData = {};

function renderFacultyGrid(filterFac='all') {
  const grid = document.getElementById('faculty-grid');
  const list = filterFac === 'all' ? FACULTY_DATA : FACULTY_DATA.filter(f => f.key === filterFac);
  grid.innerHTML = list.map(f => {
    const comments = (facultyCommentsData[f.key]||[]).slice(0,3);
    const cmtHtml = comments.length
      ? comments.map(c => `<div class="faculty-comment-item">${escHtml(c.body)}<div class="faculty-comment-meta">@${escHtml(c.author)} Â· ${formatTime(c.created_at)}</div></div>`).join('')
      : `<div style="font-size:.78rem;color:var(--gray-light);padding:.3rem 0">ã¾ã ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div>`;
    return `<div class="faculty-card">
      <div class="faculty-card-head" onclick="focusBoardWithFaculty('${f.key}')">
        <span class="faculty-campus-tag">ğŸ“ ${f.campus}</span>
        <div class="faculty-card-name">${f.name}</div>
        <div class="faculty-card-eng">${f.eng}</div>
      </div>
      <div class="faculty-detail-grid">
        <div class="faculty-detail-item"><div class="faculty-detail-label">é›°å›²æ°—ãƒ»ç‰¹å¾´</div><div class="faculty-detail-value">${f.vibe}</div></div>
        <div class="faculty-detail-item"><div class="faculty-detail-label">å°±è·å…ˆãƒ»é€²è·¯</div><div class="faculty-detail-value">${f.career}</div></div>
        <div class="faculty-detail-item"><div class="faculty-detail-label">ç”·å¥³æ¯”ï¼ˆç›®å®‰ï¼‰</div><div class="faculty-detail-value">${f.gender}</div></div>
        <div class="faculty-detail-item"><div class="faculty-detail-label">åå·®å€¤ãƒ»å…¥è©¦</div><div class="faculty-detail-value">${f.hensachi}</div></div>
      </div>
      <div class="faculty-comments-area">
        <div class="faculty-comments-title">ğŸ’¬ åœ¨å­¦ç”Ÿã‹ã‚‰ã®ã‚³ãƒ¡ãƒ³ãƒˆ</div>
        ${cmtHtml}
        <span class="faculty-ask-btn" onclick="focusBoardWithFaculty('${f.key}')">è³ªå•ã™ã‚‹ â†’</span>
      </div>
    </div>`;
  }).join('');

  // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒãƒ¼
  const bar = document.getElementById('faculty-filter-bar');
  if (!bar.children.length) {
    const all = document.createElement('span');
    all.className = 'chip active'; all.textContent = 'ã™ã¹ã¦'; all.dataset.fac = 'all';
    all.onclick = () => { setActiveChip('faculty-filter-bar', all); renderFacultyGrid('all'); };
    bar.appendChild(all);
    FACULTY_DATA.forEach(f => {
      const c = document.createElement('span');
      c.className = 'chip'; c.textContent = f.name.replace('å­¦éƒ¨',''); c.dataset.fac = f.key;
      c.onclick = () => { setActiveChip('faculty-filter-bar', c); renderFacultyGrid(f.key); };
      bar.appendChild(c);
    });
  }
}

async function loadFacultyComments() {
  if (!db) return;
  try {
    const { data } = await db.from('posts').select('*').eq('category','faculty_comment').order('created_at',{ascending:false}).limit(100);
    if (data) {
      facultyCommentsData = {};
      data.forEach(c => { if (!facultyCommentsData[c.faculty]) facultyCommentsData[c.faculty]=[]; facultyCommentsData[c.faculty].push(c); });
    }
    renderFacultyGrid();
  } catch(e) { console.error(e); }
}

function focusBoardWithFaculty(key) {
  switchTab('qa-tab');
  setTimeout(() => {
    const sel = document.getElementById('qa-faculty');
    if (sel) sel.value = key;
    document.getElementById('qa-title')?.focus();
  }, 100);
}

// â•â•â•â• å‹‰å¼·ã‚¢ãƒ‰ãƒã‚¤ã‚¹ Q&A â•â•â•â•
let qaAllPosts = [];
let qaLifeAllPosts = [];
let qaFacultyFilter = 'all';
let qaLifeFacultyFilter = 'all';
let qaAnswerCountMap = {};
const qaExpandedIds = { study: new Set(), life: new Set() };

function toggleQaCard(kind, postId) {
  const key = kind === 'life' ? 'life' : 'study';
  const set = qaExpandedIds[key];
  const id = String(postId);
  if (set.has(id)) set.delete(id);
  else set.add(id);
  renderQaList(key);
}

async function fetchAnswerCountsByPostIds(postIds) {
  const map = {};
  const ids = (postIds || []).filter(Boolean);
  if (!ids.length || !db) return map;
  try {
    const { data, error } = await db.from('answers').select('post_id').in('post_id', ids);
    if (error) throw error;
    (data || []).forEach(r => { map[r.post_id] = (map[r.post_id] || 0) + 1; });
  } catch (e) {
    console.warn('answer count fetch failed', e);
  }
  return map;
}

async function loadQaList(kind='study') {
  const isLife = kind === 'life';
  const el = document.getElementById(isLife ? 'qa-life-list' : 'qa-list');
  if (!db) { el.innerHTML = emptyState('â“','DBæœªæ¥ç¶š','',false); return; }
  try {
    const category = isLife ? 'juken_life_qa' : 'juken_qa';
    const { data, error } = await db.from('posts').select('*').eq('category', category).order('created_at',{ascending:false}).limit(50);
    if (error) throw error;
    if (isLife) qaLifeAllPosts = data || [];
    else qaAllPosts = data || [];

    const ids = (data || []).map(p => p.id).filter(Boolean);
    const counts = await fetchAnswerCountsByPostIds(ids);
    qaAnswerCountMap = { ...qaAnswerCountMap, ...counts };

    renderQaList(kind);
  } catch(e) { console.error(e); el.innerHTML = emptyState('âš ï¸','èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼','',false); }
}

function renderQaList(kind='study') {
  const isLife = kind === 'life';
  const key = isLife ? 'life' : 'study';
  const el = document.getElementById(isLife ? 'qa-life-list' : 'qa-list');
  const basePosts = isLife ? qaLifeAllPosts : qaAllPosts;
  const facFilter = isLife ? qaLifeFacultyFilter : qaFacultyFilter;
  const myIds = getMyQuestionIds();
  const posts = facFilter==='all' ? basePosts : basePosts.filter(p=>p.faculty===facFilter);
  if (!posts.length) { el.innerHTML = emptyState('â“','ã¾ã è³ªå•ãŒã‚ã‚Šã¾ã›ã‚“','æœ€åˆã«è³ªå•ã‚’æŠ•ç¨¿ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼',false); return; }
  const sortedPosts = [...posts].sort((a, b) => {
    const mineA = isMyContent(a, myIds) ? 1 : 0;
    const mineB = isMyContent(b, myIds) ? 1 : 0;
    if (mineA !== mineB) return mineB - mineA;
    return new Date(b.created_at || 0) - new Date(a.created_at || 0);
  });
  const mine = [];
  const others = [];
  sortedPosts.forEach(p => {
    const isMine = isMyContent(p, myIds);
    if (isMine) mine.push(p); else others.push(p);
  });

  const renderCard = (p) => {
    const isMine = isMyContent(p, myIds);
    const myTag = isMine ? '<span class="qa-my-badge">ğŸ§· ã‚ãªãŸã®è³ªå•</span>' : '';
    const fTag = p.faculty ? `<span class="qa-faculty-tag">${escHtml(FACULTIES[p.faculty]||p.faculty)}</span>` : '';
    const ansCount = qaAnswerCountMap[p.id] ?? p.comments ?? 0;
    return `<div class="qa-card${isMine ? ' my-question' : ''}" onclick="openQaDetail(${JSON.stringify(p.id)})">
      <div class="qa-card-head">
        <div class="qa-card-main">
          <div class="qa-card-meta">${myTag}${fTag}<span class="qa-open-badge">ğŸ”“ å›ç­”å‹Ÿé›†ä¸­</span><span style="font-size:.69rem;color:var(--gray-light)">@${escHtml(p.author)} Â· ${formatTime(p.created_at)}</span></div>
          <div class="qa-card-title">${escHtml(p.title)}</div>
          <div class="qa-card-preview">${escHtml(p.body)}</div>
          <div class="qa-card-stats"><span>ğŸ’¬ å›ç­” ${ansCount}ä»¶</span><span>â¤ï¸ ${p.likes||0}</span></div>
        </div>
        <span class="qa-card-toggle-icon" aria-hidden="true">â€º</span>
      </div>
    </div>`;
  };

  const mineSection = mine.length
    ? `<div class="qa-list-section-title">ğŸ§· ã‚ãªãŸã®è³ªå•ï¼ˆ${mine.length}ï¼‰</div>${mine.map(p => renderCard(p)).join('')}`
    : '';
  const othersSection = others.length
    ? `<div class="qa-list-section-title">ğŸ“š ã¿ã‚“ãªã®è³ªå•</div>${others.map(p => renderCard(p)).join('')}`
    : '';

  el.innerHTML = `${mineSection}${othersSection}`;
}

function filterQa(kind, fac, el) {
  if (kind === 'life') {
    setActiveChip('qa-life-faculty-filter', el);
    qaLifeFacultyFilter = fac;
    renderQaList('life');
    return;
  }
  setActiveChip('qa-faculty-filter', el);
  qaFacultyFilter = fac;
  renderQaList('study');
}

async function submitJukenQa(btn, kind='study') {
  const isLife = kind === 'life';
  const auth = await resolvePostAuthMode(isLife ? 'qaLife' : 'qa');
  if (!auth) return;
  const authorInput = document.getElementById(isLife ? 'qa-life-author' : 'qa-author');
  const author = authorInput.value.trim() || getPreferredNickname();
  const faculty = document.getElementById(isLife ? 'qa-life-faculty' : 'qa-faculty').value;
  const title  = document.getElementById(isLife ? 'qa-life-title' : 'qa-title').value.trim();
  const body   = document.getElementById(isLife ? 'qa-life-body' : 'qa-body').value.trim();
  if (!author) { alert('ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  if (!title)  { alert('è³ªå•ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  if (!body)   { alert('æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  if (!db)     { alert('DBæœªæ¥ç¶š'); return; }
  if (auth.mode === 'login' && !auth.user?.id) { alert('å…ˆã«Googleãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„'); return; }
  localStorage.setItem('waseda_nickname', author);
  currentUser = author;
  updateNicknameBadge();
  if (authorInput) authorInput.value = author;
  btn.disabled=true; btn.textContent='æŠ•ç¨¿ä¸­...';
  try {
    let payload = auth.mode === 'login'
      ? { category: isLife ? 'juken_life_qa' : 'juken_qa', author, title, body, faculty:faculty||null, likes:0, comments:0, device_id:getDeviceId(), owner_key:`auth:${auth.user.id}` }
      : { category: isLife ? 'juken_life_qa' : 'juken_qa', author, title, body, faculty:faculty||null, likes:0, comments:0, device_id:getDeviceId(), owner_key:null };
    let insertRes = await db.from('posts').insert([payload]).select('id').single();
    if (insertRes.error && isOwnerKeyColumnError(insertRes.error)) {
      delete payload.owner_key;
      insertRes = await db.from('posts').insert([payload]).select('id').single();
    }
    const { data, error } = insertRes;
    if (error) throw error;
    if (data?.id) rememberMyQuestionId(data.id);
    if (auth.mode === 'login' && auth.user?.id && data?.id) {
      rememberOwnedPostId(data.id, auth.user.id);
      rememberOwnedNickname(author, auth.user.id);
    }
    const authorId = isLife ? 'qa-life-author' : 'qa-author';
    const restIds = isLife ? ['qa-life-faculty','qa-life-title','qa-life-body'] : ['qa-faculty','qa-title','qa-body'];
    const authorEl = document.getElementById(authorId);
    if (authorEl) authorEl.value = author;
    restIds.forEach(id=>{ const e=document.getElementById(id); if(e) e.value=''; });
    closeComposerForm(isLife ? 'qaFormBoxLife' : 'qaFormBoxStudy');
    await loadQaList(kind);
  } catch(e) { console.error(e); alert('æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (e?.message || e?.code || JSON.stringify(e))); }
  finally { btn.disabled=false; btn.textContent='è³ªå•ã‚’æŠ•ç¨¿ã™ã‚‹'; }
}

// Q&A è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«
async function openQaDetail(id) {
  if (!db) return;
  try {
    const { data: post } = await db.from('posts').select('*').eq('id',id).single();
    if (!post) return;
    const { data: answers } = await db.from('answers').select('*').eq('post_id',id).order('created_at',{ascending:true});
    const ans = answers || [];
    const likedAnswerSet = getEntityLikedSet('waseda_liked_answers');
    const ansHtml = !ans.length
      ? '<p style="color:#aaa;font-size:.84rem;text-align:center;padding:1rem">ã¾ã å›ç­”ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æœ€åˆã«å›ç­”ã—ã‚ˆã†ï¼</p>'
      : ans.map(a=>{
          const likedCls = likedAnswerSet.has(String(a.id)) ? ' liked' : '';
          const likeCount = getAnswerLikeCount(a);
          return `<div class="answer-item"><div class="answer-meta"><span>@${escHtml(a.author)}</span><span>${formatTime(a.created_at)}</span><span class="answer-like${likedCls}" onclick="likeAnswer(${JSON.stringify(a.id)}, this)">â¤ï¸ <span class="like-count">${likeCount}</span></span></div><div class="answer-text">${escHtml(a.text)}</div></div>`;
        }).join('');
    document.getElementById('qa-detail-content').innerHTML = `
      <div class="qa-question-box">
        <div class="q-label">â“ è³ªå•</div>
        <div class="q-text">${escHtml(post.title)}</div>
        <div style="font-size:.84rem;color:var(--gray);margin-top:.5rem;line-height:1.65">${escHtml(post.body)}</div>
        <div style="font-size:.72rem;color:#aaa;margin-top:.4rem">@${escHtml(post.author)} Â· ${formatTime(post.created_at)}${post.faculty?' Â· '+FACULTIES[post.faculty]:''}</div>
      </div>
      <div class="answers-section"><h4>ğŸ’¬ å›ç­” ${ans.length}ä»¶</h4>${ansHtml}</div>
      <div class="answer-input-area">
        <h4>âœï¸ å›ç­”ã™ã‚‹</h4>
        <textarea class="form-textarea" id="ans-input-${id}" placeholder="ã‚ãªãŸã®çµŒé¨“ã‚„çŸ¥è­˜ã‚’ã‚·ã‚§ã‚¢ã—ã¦ãã ã•ã„..."></textarea>
        <button class="btn-submit" style="margin-top:.6rem" onclick="submitJukenAnswer(${JSON.stringify(id)})">å›ç­”ã‚’æŠ•ç¨¿</button>
      </div>`;
    document.getElementById('qaModal').classList.add('open');
  } catch(e) { console.error(e); }
}

async function submitJukenAnswer(postId) {
  const auth = await resolvePostAuthMode();
  if (!auth) return;
  const input = document.getElementById(`ans-input-${postId}`);
  const text = input ? input.value.trim() : '';
  if (!text) { alert('å›ç­”ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  const nick = getPreferredNickname() || 'åŒ¿å';
  localStorage.setItem('waseda_nickname', nick);
  currentUser = nick;
  updateNicknameBadge();
  const btn = event.target; btn.disabled=true; btn.textContent='æŠ•ç¨¿ä¸­...';
  try {
    let payload = auth.mode === 'login'
      ? { post_id:postId, author:nick, text, device_id:getDeviceId(), owner_key:`auth:${auth.user.id}` }
      : { post_id:postId, author:nick, text, device_id:getDeviceId(), owner_key:null };
    let insertRes = await db.from('answers').insert([payload]);
    if (insertRes.error && isOwnerKeyColumnError(insertRes.error)) {
      delete payload.owner_key;
      insertRes = await db.from('answers').insert([payload]);
    }
    const { error } = insertRes;
    if (error) throw error;
    const cur = qaAllPosts.find(p=>p.id===postId) || qaLifeAllPosts.find(p=>p.id===postId);
    if (cur) await db.from('posts').update({comments:(cur.comments||0)+1}).eq('id',postId);
    if (cur && cur.category === 'juken_life_qa') await loadQaList('life');
    else await loadQaList('study');
    await openQaDetail(postId);
  } catch(e) { console.error(e); alert('æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
  finally { btn.disabled=false; btn.textContent='å›ç­”ã‚’æŠ•ç¨¿'; }
}

function closeQaModal() { document.getElementById('qaModal').classList.remove('open'); }

// â•â•â•â• å—é¨“ç”Ÿæ²ç¤ºæ¿ â•â•â•â•
let boardAllPosts = [];
let boardTypeFilter = 'all';
let boardFacFilter = 'all';

async function loadBoardPosts() {
  const el = document.getElementById('board-posts');
  if (!db) { el.innerHTML = '<div class="loading">DBæœªæ¥ç¶š</div>'; return; }
  try {
    const { data, error } = await db.from('posts').select('*').eq('category','juken').order('created_at',{ascending:false}).limit(40);
    if (error) throw error;
    boardAllPosts = (data||[]).filter(p => p.circle_type!=='advice' && p.circle_type!=='taikenki');
    renderBoardPosts();
  } catch(e) { console.error(e); document.getElementById('board-posts').innerHTML='<div class="loading">èª­ã¿è¾¼ã¿å¤±æ•—</div>'; }
}

function filterBoard(type, el) {
  setActiveChip('board-type-filter', el); boardTypeFilter=type; renderBoardPosts();
}
function filterBoard2(fac, el) {
  setActiveChip('board-faculty-filter', el); boardFacFilter=fac; renderBoardPosts();
}

function renderBoardPosts() {
  const el = document.getElementById('board-posts');
  let posts = boardAllPosts;
  if (boardTypeFilter !== 'all') posts = posts.filter(p=>p.circle_type===boardTypeFilter);
  if (boardFacFilter  !== 'all') posts = posts.filter(p=>p.faculty===boardFacFilter);
  if (!posts.length) { el.innerHTML=`<div class="empty-state"><div class="empty-state-icon">ğŸ’¬</div><div class="empty-state-title">æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“</div><div class="empty-state-text">æœ€åˆã®æŠ•ç¨¿è€…ã«ãªã‚Šã¾ã›ã‚“ã‹ï¼Ÿ</div></div>`; return; }
  const likedSet = getLikedPosts();
  el.innerHTML = posts.map(p => {
    const typeClass = TYPE_CLASSES[p.circle_type]||'type-zatsudan';
    const typeTag = p.circle_type ? `<span class="board-type-tag ${typeClass}">${escHtml(p.circle_type)}</span>` : '';
    const facTag  = p.faculty ? `<span class="board-faculty-tag">${escHtml(FACULTIES[p.faculty]||p.faculty)}</span>` : '';
    const likedCls = likedSet.has(String(p.id))?' liked':'';
    return `<div class="board-card" onclick="openBoardDetail(${JSON.stringify(p.id)})">
      <div class="board-card-meta">${typeTag}${facTag}<span class="board-card-author">@${escHtml(p.author)}</span><span class="board-card-time">${formatTime(p.created_at)}</span></div>
      <div class="board-card-body">${escHtml(p.body)}</div>
      <div class="board-card-footer">
        <span class="board-like${likedCls}" onclick="event.stopPropagation();likeBoardPost(${JSON.stringify(p.id)},this)">â¤ï¸ <span class="like-num">${p.likes||0}</span></span>
        <span>ğŸ’¬ ${p.comments||0}</span>
      </div>
    </div>`;
  }).join('');
}

async function likeBoardPost(id, el) {
  if (!db) return;
  const already = getLikedPosts().has(String(id));
  const numEl = el.querySelector('.like-num');
  const cur = numEl ? parseInt(numEl.textContent||'0') : 0;
  const next = already ? Math.max(0,cur-1) : cur+1;
  if (numEl) numEl.textContent = next;
  el.classList.toggle('liked', !already); setPostLiked(id, !already);
  const { error } = await db.from('posts').update({likes:next}).eq('id',id);
  if (error) { if(numEl) numEl.textContent=cur; el.classList.toggle('liked',already); setPostLiked(id,already); }
}

function closeBoardDetailModal() {
  const modal = document.getElementById('boardDetailModal');
  if (modal) modal.classList.remove('open');
}

async function loadBoardComments(postId) {
  if (!db) return [];
  try {
    const { data, error } = await db.from('comments').select('*').eq('post_id', postId).order('created_at', { ascending: false });
    if (error) throw error;
    return Array.isArray(data) ? data : [];
  } catch (e) {
    console.error(e);
    return [];
  }
}

async function openBoardDetail(postId) {
  if (!db) return;
  try {
    const { data: post, error } = await db.from('posts').select('*').eq('id', postId).single();
    if (error || !post) return;
    const comments = await loadBoardComments(postId);
    const commentHtml = comments.length
      ? comments.map(c => `<div style="border:1px solid var(--border);border-radius:8px;padding:.65rem .75rem;margin-bottom:.5rem;background:var(--bg);"><div style="font-size:.8rem;color:var(--dark);line-height:1.6;">${escHtml(c.text || '')}</div><div style="font-size:.7rem;color:var(--gray-light);margin-top:.25rem;">@${escHtml(c.author || 'åŒ¿å')} Â· ${formatTime(c.created_at)}</div></div>`).join('')
      : '<div style="text-align:center;color:var(--gray-light);font-size:.82rem;padding:.6rem 0;">ã¾ã ã‚³ãƒ¡ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</div>';

    document.getElementById('board-detail-content').innerHTML = `
      <div style="border:1.5px solid var(--border);border-radius:10px;padding:.95rem 1rem;background:#fff;">
        <div style="display:flex;gap:.45rem;align-items:center;flex-wrap:wrap;margin-bottom:.45rem;">
          ${post.circle_type ? `<span class="board-type-tag ${TYPE_CLASSES[post.circle_type] || 'type-zatsudan'}">${escHtml(post.circle_type)}</span>` : ''}
          ${post.faculty ? `<span class="board-faculty-tag">${escHtml(FACULTIES[post.faculty] || post.faculty)}</span>` : ''}
          <span style="font-size:.72rem;color:var(--gray-light);">@${escHtml(post.author || 'åŒ¿å')} Â· ${formatTime(post.created_at)}</span>
        </div>
        <div style="font-size:.9rem;color:var(--dark);line-height:1.7;white-space:pre-wrap;">${escHtml(post.body || '')}</div>
      </div>
      <div style="margin-top:1rem;">
        <div style="font-size:.86rem;font-weight:700;color:var(--dark);margin-bottom:.55rem;">ğŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆ ${comments.length}ä»¶</div>
        ${commentHtml}
      </div>
      <div class="answer-input-area" style="margin-top:1rem;">
        <h4>âœï¸ ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹</h4>
        <div class="post-auth-options" id="boardCommentAuthOptions-${postId}" style="margin-bottom:.55rem;">
          <label class="post-auth-option"><input type="radio" name="boardCommentAuthMode-${postId}" id="boardCommentAuthLogin-${postId}" value="login" onchange="updateBoardCommentAuthModeUI(${JSON.stringify(postId)})"> ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦æŠ•ç¨¿ï¼ˆç¢ºèªãƒ»ãƒã‚¤ãƒšãƒ¼ã‚¸å¯¾å¿œï¼‰</label>
          <label class="post-auth-option"><input type="radio" name="boardCommentAuthMode-${postId}" id="boardCommentAuthGuest-${postId}" value="guest" checked onchange="updateBoardCommentAuthModeUI(${JSON.stringify(postId)})"> ãƒ­ã‚°ã‚¤ãƒ³ã›ãšæŠ•ç¨¿ï¼ˆç®¡ç†å¯¾è±¡å¤–ï¼‰</label>
        </div>
        <div class="post-auth-login-actions" id="boardCommentAuthLoginActions-${postId}" style="display:none;margin:-.15rem 0 .6rem;">
          <button type="button" class="post-auth-login-btn" onclick="handleBoardCommentLoginClick(${JSON.stringify(postId)})">ã“ã®ç”»é¢ã®ã¾ã¾Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
        </div>
        <textarea class="form-textarea" id="board-comment-input-${postId}" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."></textarea>
        <button class="btn-submit" style="margin-top:.6rem" onclick="submitBoardComment(${JSON.stringify(postId)}, this)">ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿</button>
      </div>`;

    const modal = document.getElementById('boardDetailModal');
    if (modal) modal.classList.add('open');
    updateBoardCommentAuthModeUI(postId);
  } catch (e) {
    console.error(e);
  }
}

async function resolveBoardCommentAuthMode(postId) {
  const resolvedUser = await getResolvedAuthUser();
  if (resolvedUser?.id) return { mode: 'login', user: resolvedUser };

  const selectedMode = getBoardCommentAuthMode(postId);
  if (selectedMode === 'login') {
    alert('ã€Œã“ã®ç”»é¢ã®ã¾ã¾Googleã§ãƒ­ã‚°ã‚¤ãƒ³ã€ãƒœã‚¿ãƒ³ã§ãƒ­ã‚°ã‚¤ãƒ³å¾Œã€ã‚‚ã†ä¸€åº¦æŠ•ç¨¿ã—ã¦ãã ã•ã„ã€‚');
    return null;
  }
  return { mode: 'guest', user: null };
}

async function submitBoardComment(postId, btn) {
  const auth = await resolveBoardCommentAuthMode(postId);
  if (!auth) return;
  const input = document.getElementById(`board-comment-input-${postId}`);
  const text = (input?.value || '').trim();
  if (!text) { alert('ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  if (!db) { alert('DBæœªæ¥ç¶š'); return; }
  const author = getPreferredNickname() || 'åŒ¿å';
  localStorage.setItem('waseda_nickname', author);
  currentUser = author;
  updateNicknameBadge();

  const targetBtn = btn || event?.target;
  if (targetBtn) { targetBtn.disabled = true; targetBtn.textContent = 'æŠ•ç¨¿ä¸­...'; }
  try {
    let payload = auth.mode === 'login'
      ? { post_id: postId, author, text, device_id: getDeviceId(), owner_key: `auth:${auth.user.id}` }
      : { post_id: postId, author, text, device_id: getDeviceId(), owner_key: null };
    let insertRes = await db.from('comments').insert([payload]);
    if (insertRes.error && isOwnerKeyColumnError(insertRes.error)) {
      delete payload.owner_key;
      insertRes = await db.from('comments').insert([payload]);
    }
    if (insertRes.error) throw insertRes.error;
    if (auth.mode === 'login' && auth.user?.id) {
      rememberCommentTrackedPostId(postId, auth.user.id);
      rememberOwnedNickname(author, auth.user.id);
    }

    const currentCount = Number(boardAllPosts.find(p => p.id === postId)?.comments || 0);
    await db.from('posts').update({ comments: currentCount + 1 }).eq('id', postId);

    if (input) input.value = '';
    await loadBoardPosts();
    await openBoardDetail(postId);
  } catch (e) {
    console.error(e);
    alert('ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (e?.message || e?.code || 'unknown error'));
  } finally {
    if (targetBtn) { targetBtn.disabled = false; targetBtn.textContent = 'ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿'; }
  }
}

function setComposerBodyLock() {
  const opened = document.querySelector('.post-form-box.open');
  document.body.classList.toggle('post-form-open', !!opened);
}

function closeAllComposerForms(exceptId = null) {
  ['qaFormBoxStudy', 'qaFormBoxLife', 'boardFormBox'].forEach((id) => {
    if (id === exceptId) return;
    const el = document.getElementById(id);
    if (el) el.classList.remove('open');
  });
}

function closeComposerForm(boxId) {
  const box = document.getElementById(boxId);
  if (!box) return;
  box.classList.remove('open');
  setComposerBodyLock();
}

function handlePostFormBackdrop(event, boxId) {
  if (event.target !== event.currentTarget) return;
  closeComposerForm(boxId);
}

function toggleBoardForm() {
  const box = document.getElementById('boardFormBox');
  if (!box) return;
  const shouldOpen = !box.classList.contains('open');
  closeAllComposerForms(shouldOpen ? 'boardFormBox' : null);
  box.classList.toggle('open', shouldOpen);
  setComposerBodyLock();
}

function toggleQaForm(kind = 'study') {
  const boxId = kind === 'life' ? 'qaFormBoxLife' : 'qaFormBoxStudy';
  const box = document.getElementById(boxId);
  if (!box) return;
  const shouldOpen = !box.classList.contains('open');
  closeAllComposerForms(shouldOpen ? boxId : null);
  box.classList.toggle('open', shouldOpen);
  setComposerBodyLock();
}

async function submitBoardPost(btn) {
  const auth = await resolvePostAuthMode('board');
  if (!auth) return;
  const nickname = document.getElementById('boardNickname').value.trim();
  const faculty  = document.getElementById('boardFaculty').value;
  const type     = document.getElementById('boardType').value;
  const body     = document.getElementById('boardBody').value.trim();
  if (!nickname) { alert('ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  if (!type)     { alert('æŠ•ç¨¿ç¨®åˆ¥ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
  if (!body)     { alert('æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  if (!db) { alert('DBæœªæ¥ç¶š'); return; }
  localStorage.setItem('waseda_nickname', nickname);
  currentUser = nickname;
  updateNicknameBadge();
  btn.disabled=true; btn.textContent='æŠ•ç¨¿ä¸­...';
  try {
    let payload = auth.mode === 'login'
      ? { category:'juken', author:nickname, title:body.slice(0,40), body, faculty:faculty||null, circle_type:type, likes:0, comments:0, device_id:getDeviceId(), owner_key:`auth:${auth.user.id}` }
      : { category:'juken', author:nickname, title:body.slice(0,40), body, faculty:faculty||null, circle_type:type, likes:0, comments:0, device_id:getDeviceId(), owner_key:null };
    let insertRes = await db.from('posts').insert([payload]).select('id').single();
    if (insertRes.error && isOwnerKeyColumnError(insertRes.error)) {
      delete payload.owner_key;
      insertRes = await db.from('posts').insert([payload]).select('id').single();
    }
    const { data, error } = insertRes;
    if (error) throw error;
    if (auth.mode === 'login' && auth.user?.id && data?.id) {
      rememberOwnedPostId(data.id, auth.user.id);
      rememberOwnedNickname(nickname, auth.user.id);
    }
    const boardNick = document.getElementById('boardNickname');
    if (boardNick) boardNick.value = nickname;
    ['boardFaculty','boardType','boardBody'].forEach(id=>{ const e=document.getElementById(id); if(e) e.value=''; });
    closeComposerForm('boardFormBox');
    await loadBoardPosts();
    document.getElementById('board-posts').scrollIntoView({behavior:'smooth'});
  } catch(e) { console.error(e); alert('æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (e?.message || JSON.stringify(e))); }
  finally { btn.disabled=false; btn.textContent='æŠ•ç¨¿ã™ã‚‹'; }
}

// â•â•â•â• åˆæ ¼ä½“é¨“è¨˜ â•â•â•â•
let tkAllData = [];
let tkFacFilter = 'all';

function parseTk(t) {
  const ef = t.extra_fields ? (typeof t.extra_fields === 'string' ? JSON.parse(t.extra_fields) : t.extra_fields) : {};
  return { ...t, advice: t.body, exam_type: ef.exam_type, study_start: ef.study_start, daily_hours: ef.daily_hours, references: ef.references, hard_subject: ef.hard_subject };
}

async function loadTaikenki() {
  const el = document.getElementById('taikenki-list');
  if (!db) { el.innerHTML = emptyState('ğŸ†','DBæœªæ¥ç¶š','',false); return; }
  try {
    const { data, error } = await db.from('posts').select('*').eq('category','taikenki').order('created_at',{ascending:false}).limit(50);
    if (error) throw error;
    tkAllData = (data || []).map(parseTk);
    renderTaikenki();
  } catch(e) { console.error(e); el.innerHTML = emptyState('âš ï¸','èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼','',false); }
}

function filterTk(fac, el) { setActiveChip('tk-faculty-filter', el); tkFacFilter=fac; renderTaikenki(); }

function renderTaikenki() {
  const el = document.getElementById('taikenki-list');
  const list = tkFacFilter==='all' ? tkAllData : tkAllData.filter(t=>t.faculty===tkFacFilter);
  if (!list.length) {
    el.innerHTML = emptyState('ğŸ†','ã¾ã ä½“é¨“è¨˜ãŒã‚ã‚Šã¾ã›ã‚“','åœ¨å­¦ç”Ÿæ²ç¤ºæ¿ã®ã€Œå—é¨“ç”Ÿã‚µãƒãƒ¼ãƒˆã€ã‚¿ãƒ–ã‹ã‚‰æŠ•ç¨¿ã§ãã¾ã™',true);
    return;
  }
  el.innerHTML = list.map(t => {
    const fTag = t.faculty ? `<span class="tk-faculty-tag">${escHtml(FACULTIES[t.faculty]||t.faculty)}</span>` : '';
    const eTag = t.exam_type ? `<span class="tk-exam-tag">${escHtml(t.exam_type)}</span>` : '';
    return `<div class="tk-card" onclick="openTkDetail(${JSON.stringify(t.id)})">
      <div class="tk-card-head">${fTag}${eTag}</div>
      <div class="tk-stats">
        ${t.study_start ? `<div class="tk-stat"><div class="tk-stat-label">å‹‰å¼·é–‹å§‹</div><div class="tk-stat-value">${escHtml(t.study_start)}</div></div>` : ''}
        ${t.daily_hours ? `<div class="tk-stat"><div class="tk-stat-label">1æ—¥ã®å‹‰å¼·æ™‚é–“</div><div class="tk-stat-value">${escHtml(t.daily_hours)}</div></div>` : ''}
      </div>
      <div class="tk-advice">${escHtml(t.advice)}</div>
      <div class="tk-meta">@${escHtml(t.author||'åŒ¿å')} Â· ${formatTime(t.created_at)}</div>
    </div>`;
  }).join('');
}

async function openTkDetail(id) {
  const t = tkAllData.find(x=>x.id===id); if (!t) return;
  const rows = [
    ['åˆæ ¼å­¦éƒ¨', FACULTIES[t.faculty]||t.faculty],
    ['å—é¨“æ–¹å¼', t.exam_type],
    ['å‹‰å¼·é–‹å§‹æ™‚æœŸ', t.study_start],
    ['1æ—¥ã®å¹³å‡å‹‰å¼·æ™‚é–“', t.daily_hours],
    ['ä¸€ç•ªå¤§å¤‰ã ã£ãŸç§‘ç›®', t.hard_subject],
    ['ä½¿ã£ãŸå‚è€ƒæ›¸ãƒ»ã‚µãƒ¼ãƒ“ã‚¹', t.references],
  ].filter(([,v])=>v).map(([l,v])=>`<div class="tk-detail-item"><div class="tk-detail-label">${l}</div><div class="tk-detail-value">${escHtml(v)}</div></div>`).join('');
  document.getElementById('tk-detail-content').innerHTML = `
    ${rows}
    <div class="tk-detail-item"><div class="tk-detail-label">å¾Œè¼©ã¸ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹</div><div class="tk-detail-value" style="line-height:1.75">${escHtml(t.advice)}</div></div>
    <div style="font-size:.72rem;color:var(--gray-light);margin-top:.8rem">@${escHtml(t.author||'åŒ¿å')} Â· ${formatTime(t.created_at)}</div>`;
  document.getElementById('tkModal').classList.add('open');
}
function closeTkModal() { document.getElementById('tkModal').classList.remove('open'); }

// â”€â”€ å…±é€š â”€â”€
function emptyState(icon, title, text, showLink) {
  return `<div class="empty-state" style="grid-column:1/-1">
    <div class="empty-state-icon">${icon}</div>
    <div class="empty-state-title">${title}</div>
    <div class="empty-state-text">${text}</div>
    ${showLink?`<a href="https://waseda-ten.vercel.app/" class="empty-state-btn">åœ¨å­¦ç”Ÿæ²ç¤ºæ¿ã§æŠ•ç¨¿ã™ã‚‹</a>`:''}
  </div>`;
}

// â”€â”€ ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹ â”€â”€
document.getElementById('qaModal').addEventListener('click', e => { if(e.target===document.getElementById('qaModal')) closeQaModal(); });
document.getElementById('tkModal').addEventListener('click', e => { if(e.target===document.getElementById('tkModal')) closeTkModal(); });
document.getElementById('nicknameModal').addEventListener('click', e => { if(e.target===document.getElementById('nicknameModal')) closeNicknameModal(); });
document.getElementById('myPageModal').addEventListener('click', e => { if(e.target===document.getElementById('myPageModal')) closeMyPageModal(); });
document.getElementById('boardDetailModal').addEventListener('click', e => { if(e.target===document.getElementById('boardDetailModal')) closeBoardDetailModal(); });

// â”€â”€ åˆæœŸãƒ­ãƒ¼ãƒ‰ â”€â”€
document.addEventListener('DOMContentLoaded', () => {
  initGoogleAuth();
  updateNicknameBadge();
  loaded.add('faculties-tab');
  renderFacultyGrid();
  loadFacultyComments();
  document.getElementById('tabsInner').addEventListener('scroll', updateScrollBtn);
  window.addEventListener('resize', updateScrollBtn);
  updateScrollBtn();
});
</script>
</body>
</html>
